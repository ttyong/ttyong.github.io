<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<script src="https://cdn.jsdelivr.net/gh/wallleap/cdn/js/piao.js"></script>
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="s8Pe1TBqyy">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/animal_bear_panda_32px_4023_easyicon.net.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/animal_bear_panda_16px_4023_easyicon.net.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="直播平台三度关系推荐v1.0,">





  <link rel="alternate" href="/atom.xml" title="TianYong's Blog" type="application/atom+xml">






<meta name="description" content="第十八周 直播平台三度关系推荐v1.0-3数据计算之实时维护粉丝关注(第二个任务) 1接下来我们来看一下数据计算中的第二步，实时维护粉丝关注数据。我们的实时粉丝关注数据呢，来源于服务端日志，因为当用户在直播平台中对主播进行关注和取消关注的时候呢，会调用服务端接口。所以说服务端会记录这些操作日志。具体的数据格式呢，是这样。这是一个json格式，fuid就代表了粉丝。uid代表的是主播。好，">
<meta property="og:type" content="article">
<meta property="og:title" content="大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3">
<meta property="og:url" content="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html">
<meta property="og:site_name" content="TianYong&#39;s Blog">
<meta property="og:description" content="第十八周 直播平台三度关系推荐v1.0-3数据计算之实时维护粉丝关注(第二个任务) 1接下来我们来看一下数据计算中的第二步，实时维护粉丝关注数据。我们的实时粉丝关注数据呢，来源于服务端日志，因为当用户在直播平台中对主播进行关注和取消关注的时候呢，会调用服务端接口。所以说服务端会记录这些操作日志。具体的数据格式呢，是这样。这是一个json格式，fuid就代表了粉丝。uid代表的是主播。好，">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261212936.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261215313.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261216414.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261635084.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261636657.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261641417.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261654714.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261704743.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261823893.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261841795.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261842193.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261843621.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261844934.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122548.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122638.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122756.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262130828.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262214894.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262237405.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262238354.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262239377.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262246028.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262254705.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262254651.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262258359.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262316695.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262323730.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262336732.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262344942.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262345661.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262349598.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262359274.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304271046115.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304271048485.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281349757.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281349353.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281350275.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281352725.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281352639.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281537558.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281537439.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281539054.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281540381.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281547995.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281553783.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281605986.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281750435.png">
<meta property="article:published_time" content="2023-04-24T07:37:33.000Z">
<meta property="article:modified_time" content="2023-05-26T10:02:54.316Z">
<meta property="article:author" content="TTYONG">
<meta property="article:tag" content="直播平台三度关系推荐v1.0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261212936.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://tianyong.fun/大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3.html">





  <title>大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3 | TianYong's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">TianYong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">比你优秀的人都努力，有什么理由不努力！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="TTYONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TianYong's Blog">
    </span>

    
      <header class="post-header">
	  
	  



        
        
          <h2 class="post-title" itemprop="name headline">大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-24T15:37:33+08:00">
                2023-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/" itemprop="url" rel="index">
                    <span itemprop="name">大数据开发工程师</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  85
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<script type="text/javascript" src="/js/src/bai.js"></script>



<h1 id="第十八周-直播平台三度关系推荐v1-0-3"><a href="#第十八周-直播平台三度关系推荐v1-0-3" class="headerlink" title="第十八周 直播平台三度关系推荐v1.0-3"></a>第十八周 直播平台三度关系推荐v1.0-3</h1><h2 id="数据计算之实时维护粉丝关注-第二个任务"><a href="#数据计算之实时维护粉丝关注-第二个任务" class="headerlink" title="数据计算之实时维护粉丝关注(第二个任务)"></a>数据计算之实时维护粉丝关注(第二个任务)</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261212936.png" alt="image-20230426121205538"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">接下来我们来看一下数据计算中的第二步，实时维护粉丝关注数据。我们的实时粉丝关注数据呢，来源于服务端日志，因为当用户在直播平台中对主播进行关注和取消关注的时候呢，会调用服务端接口。所以说服务端会记录这些操作日志。具体的数据格式呢，是这样。这是一个json格式，fuid就代表了粉丝。uid代表的是主播。好，这个timestamp，它表示这个具体你这个关注行为，或者你取消关注行为，它产生的时间。这个type呢，表示这个数据是什么类型的数据，它是粉丝关注相关的数据。那具体这条数据是关注还是取消关注，我们要根据这个desc这个参数来定。它里面这个值如果是follow就表示是关注，如果是UN follow，就表示取消关注。所以说后期我们在解析这个数据的时候呢，其实核心字段就是三个followeruid，还有这个followuid，还有这个desc。那接下来我们就需要使用sparkstreamming实时维护neo4j粉丝关注的相关数据。</span><br></pre></td></tr></table></figure>

<h3 id="父项目pom"><a href="#父项目pom" class="headerlink" title="父项目pom"></a>父项目pom</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;&#x2F;packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;generate_data&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;data_collect&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;server_inter&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;real_time_follow&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;update_user_level&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;update_user_active&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;update_video_info&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;get_recommend_list&lt;&#x2F;module&gt;</span><br><span class="line">    &lt;&#x2F;modules&gt;</span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;!-- log4j的依赖 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;slf4j-api&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.7.10&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;slf4j-log4j12&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.7.10&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.2.68&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.1.1.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.httpcomponents&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;httpclient&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;4.5.12&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;commons-dbutils&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;commons-dbutils&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.6&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;8.0.20&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.hadoop&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;hadoop-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.2.0&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;!-- spark相关依赖 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.4.3&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spark-sql_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.4.3&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spark-streaming_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.4.3&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spark-streaming-kafka-0-10_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.4.3&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;!-- neo4j相关依赖 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;4.1.1&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;neo4j-contrib&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;neo4j-spark-connector&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.4.5-M1&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;&#x2F;dependencyManagement&gt;</span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;!-- list of other repositories --&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;SparkPackagesRepo&lt;&#x2F;id&gt;</span><br><span class="line">            &lt;url&gt;http:&#x2F;&#x2F;dl.bintray.com&#x2F;spark-packages&#x2F;maven&lt;&#x2F;url&gt;</span><br><span class="line">        &lt;&#x2F;repository&gt;</span><br><span class="line">    &lt;&#x2F;repositories&gt;</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">以及添加一个repository，因为neo4j-spark-connector这个依赖在maven中央仓库中是没有的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意我在这个父项目创建module子项目，副项目这个pom文件里面啊，提前把相关的依赖啊都给它放进，我们可以看一下，主要是下面这些东西。这是Spark相关的依赖，Spark core、spark sql、 Spark streaming。还有这个spark streaming kafka对吧，因为你要读取kafka嘛。以及下面呢，是你后这相关的一些依赖。现在我提前把它拿过来，后面我们再具体用到的时候呢，我再去分析。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261215313.png" alt="image-20230426121552111"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261216414.png" alt="image-20230426121614568"></p>
<h3 id="子项目pom"><a href="#子项目pom" class="headerlink" title="子项目pom"></a>子项目pom</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;real_time_follow&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-streaming_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-streaming-kafka-0-10_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">那针对我们这个实施项目，它里面都需要什么依赖呢？注意它里面呢，你首先需要这个spark streaming以及spark streaming kafka吧。以及用neo4j那个依赖。还有一个，因为我们的原始数据是json的，我们要解析json，所以说呢，还要用那个fastjson这个包。那所以说我们看一下啊。neo4j-java-driver就类似于我们要操作mysql一样，我们要添加mysql对应的一个connector。啊，这个是类似的啊。</span><br><span class="line"></span><br><span class="line">在这呢，你可以把这个版本号给它删掉就行。因为在这啊，我们是在这个父项目里面统一来维护管理这些依赖，其实主要是管理这些版本。因为这个最外层呢，你看它套了一个dependency manager里面呢是一个dependency。所以说你看和这个比的话，它外面是多了一个这个depend manager。所以说呢，在这统一管理这些依赖的版本，你后期这里面这些子项目，你需要用到哪些依赖，你把这些依赖拿过来就可以使用了，这样的话你不需要指定版本，它呢会读取你那个父项目里面pom里面指定的这个版本。如果说你有个性化的需求，你说你那个公共的版本不满足我的要求，我想使用某一个特殊的版本，那么你可以在这来指定你的版本就可以了。这样的话只针对你这个子项目有效。那把这几个依赖加过来就可以了，现在我们来看看这个啊，前面这几个就没什么好说的了，主要看看这个neo4j-java-driver。就类似我们操作mysql一样，我们需要找到neo4j它的一个驱动jar包给大家分析一下我是在哪找到的？官网，这个其实啊，我们直接到这个maven仓库里面去搜也行，你到仓库里面去搜这个new瑞杠Java杠driver也是可以找到的，是一样的。这是这个流程。</span><br><span class="line"></span><br><span class="line">好，那接下来呢，我们把这个项目它的一个技术环境，再给它配一下邮件。摩托塞定是。这样里面注意咱那个library，我们把这个scala2.11这个SDK给它加进来。因为针对Spark而言，我们用的是2.11。你在这呢，我们再建一个录入叫SC。把它设置为S。OK，注意前面我们在开发代码的时候，我们先用代码来开发。等最后的时候呢，我会把那个java代码具体的实现呢，也给大家提供过去。我们课上讲的时候以这个scala代码为主。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那接下来建一个包。com。点五克点Spark。在这里面，我们创建一个object。叫real time。follow。那在这我们先写点注释，这个呢是任务二了，就第二个任务。实施维护粉丝关注数据。你妈吗？对，在这我们一个streaming。context。它里面呢，需要接触一个SPA以及一个时间second。second。我们把这个周期呢设为五秒行吧。上面呢，我们来创建，你有一个Spark，这个都是固定的写法。said master。LOGO2。因为你是一个实时处理程序。set APP name。就是这个。提取的变量。好。好，这个呢，也提取一个变量有SSC吧。这个呢表示创建。context。</span><br><span class="line"></span><br><span class="line">那接下来呢，我们需要获取。消费卡夫卡的数据流。这个呢，也是一个固定的写法。搞不搞？第二数一。我们使用那个direct。泛型呢，都是spring这个我们前面讲过啊嗯。把这个SSC传过去。后面呢，穿这个location。street。这个后面呢，直接那个五月份。好，它下面还有一个参数叫consumer。一个订阅功能啊。这块泛型呢，也都是three。sweets。注意这里面我们需要给它指定两个参数，一个呢是topics对吧，指定topic。还有一个呢，是卡夫卡的一个参数。需要这两个参数。那我们这上面需要重建一下。嗯。在这呢，指定要读取的topic的名称。主要是两个。那我们先创建第一个。他其实就是这个。我们直接使用个map。object。直接在这块来处理啊。首先在里面使用卡夫卡的一个扑克地址。RI。101冒号9092。逗号。0203把这个改一下，0203。好，这样第一个参数就搞定了。我们还需要指定一下这个K的一个序列化类型。前面先空着，我先把后面那个写，写完之后呢，复制一下。嗯。glass of string。这样就可以了。那前面的话呢，其实就是K点把这个拿过来。he ser。小写。这个呢是value的序列化类型，嗯。把这个复制一下，再改一下。好，这样就可以了，嗯。那下面来指定这个消费者组ID。嗯嗯。给我点ID。con吧，行吧。这个就是你来自己来指定。下面是一个消费策略。就你第一次消费的时候如何来消费？auto ofetet。就是读取最新的数据。这个是自动提交offset。嗯嗯。enable。there auto。这个是醋啊。现在啊，你最好给他强制指定类型，要不然用的时候呢，可能会有问题。加点allow their words。对吧，这个就可以了，那既然我们指定我们需要消费的这个topic。它是一个，它可以接收多个。注意，接着我们应该消费那个user。对吧，这里面是实时的粉丝关注相关的数据。OK，那这块呢就可以了，我们就可以获取到这个消费卡不卡的一个数据流了。这个是一个卡夫卡。</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.spark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.<span class="type">JSON</span></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.<span class="type">StringDeserializer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010.&#123;<span class="type">ConsumerStrategies</span>, <span class="type">KafkaUtils</span>, <span class="type">LocationStrategies</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.driver.&#123;<span class="type">AuthTokens</span>, <span class="type">GraphDatabase</span>, <span class="type">Transaction</span>, <span class="type">TransactionWork</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务2：</span></span><br><span class="line"><span class="comment"> * 实时维护粉丝关注数据</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">RealTimeFollowScala</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//创建StreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local[2]"</span>).setAppName(<span class="string">"RealTimeFollowScala"</span>)</span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定Kafka的配置信息</span></span><br><span class="line">    <span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>,<span class="type">Object</span>](</span><br><span class="line">      <span class="comment">//kafka的broker地址信息</span></span><br><span class="line">      <span class="string">"bootstrap.servers"</span>-&gt;<span class="string">"bigdata01:9092,bigdata02:9092,bigdata03:9092"</span>,</span><br><span class="line">      <span class="comment">//key的序列化类型</span></span><br><span class="line">      <span class="string">"key.deserializer"</span>-&gt;classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="comment">//value的序列化类型</span></span><br><span class="line">      <span class="string">"value.deserializer"</span>-&gt;classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="comment">//消费者组id</span></span><br><span class="line">      <span class="string">"group.id"</span>-&gt;<span class="string">"con_1"</span>,</span><br><span class="line">      <span class="comment">//消费策略</span></span><br><span class="line">      <span class="string">"auto.offset.reset"</span>-&gt;<span class="string">"latest"</span>,</span><br><span class="line">      <span class="comment">//自动提交offset</span></span><br><span class="line">      <span class="string">"enable.auto.commit"</span>-&gt;(<span class="literal">true</span>: java.lang.<span class="type">Boolean</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//指定要读取的topic的名称</span></span><br><span class="line">    <span class="keyword">val</span> topics = <span class="type">Array</span>(<span class="string">"user_follow"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取消费kafka的数据流</span></span><br><span class="line">    <span class="keyword">val</span> kafkaDStream = <span class="type">KafkaUtils</span>.createDirectStream[<span class="type">String</span>, <span class="type">String</span>](</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="type">LocationStrategies</span>.<span class="type">PreferConsistent</span>,</span><br><span class="line">      <span class="type">ConsumerStrategies</span>.<span class="type">Subscribe</span>[<span class="type">String</span>, <span class="type">String</span>](topics, kafkaParams)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理数据</span></span><br><span class="line">    <span class="comment">//首先将kafkaDStream转换为rdd，然后就可以调用rdd中的foreachPartition了</span></span><br><span class="line">    kafkaDStream.foreachRDD(rdd=&gt;&#123;</span><br><span class="line">      <span class="comment">//一次处理一个分区的数据</span></span><br><span class="line">      rdd.foreachPartition(it=&gt;&#123;</span><br><span class="line">        <span class="comment">//获取neo4j连接</span></span><br><span class="line">        <span class="keyword">val</span> driver = <span class="type">GraphDatabase</span>.driver(<span class="string">"bolt://bigdata04:7687"</span>, <span class="type">AuthTokens</span>.basic(<span class="string">"neo4j"</span>, <span class="string">"admin"</span>))</span><br><span class="line">        <span class="comment">//开启一个会话</span></span><br><span class="line">        <span class="keyword">val</span> session = driver.session()</span><br><span class="line">        it.foreach(record=&gt;&#123;</span><br><span class="line">          <span class="comment">//获取粉丝关注相关数据</span></span><br><span class="line">          <span class="comment">//&#123;"followeruid":"1001","followuid":"1002","timestamp":1798198304,"type":"user_follow","desc":"follow"&#125;</span></span><br><span class="line">          <span class="keyword">val</span> line = record.value()</span><br><span class="line">          <span class="comment">//解析数据</span></span><br><span class="line">          <span class="keyword">val</span> userFollowObj = <span class="type">JSON</span>.parseObject(line)</span><br><span class="line">          <span class="comment">//获取数据类型，关注 or  取消关注</span></span><br><span class="line">          <span class="keyword">val</span> followType = userFollowObj.getString(<span class="string">"desc"</span>)</span><br><span class="line">          <span class="comment">//获取followeruid</span></span><br><span class="line">          <span class="keyword">val</span> followeruid = userFollowObj.getString(<span class="string">"followeruid"</span>)</span><br><span class="line">          <span class="comment">//获取followuid</span></span><br><span class="line">          <span class="keyword">val</span> followuid = userFollowObj.getString(<span class="string">"followuid"</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span>(<span class="string">"follow"</span>.equals(followType))&#123;</span><br><span class="line">            <span class="comment">//添加关注：因为涉及多条命令，所以需要使用事务</span></span><br><span class="line">            session.writeTransaction(<span class="keyword">new</span> <span class="type">TransactionWork</span>[<span class="type">Unit</span>] ()&#123;</span><br><span class="line">              <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span>(tx: <span class="type">Transaction</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                  tx.run(<span class="string">"merge (:User &#123;uid:'"</span>+followeruid+<span class="string">"'&#125;)"</span>)</span><br><span class="line">                  tx.run(<span class="string">"merge (:User &#123;uid:'"</span>+followuid+<span class="string">"'&#125;)"</span>)</span><br><span class="line">                  tx.run(<span class="string">"match(a:User &#123;uid:'"</span>+followeruid+<span class="string">"'&#125;),(b:User &#123;uid:'"</span>+followuid+<span class="string">"'&#125;) merge (a) -[:follow]-&gt; (b)"</span>)</span><br><span class="line">                  <span class="comment">//提交事务</span></span><br><span class="line">                  tx.commit()</span><br><span class="line">                &#125;<span class="keyword">catch</span> &#123;</span><br><span class="line">                  <span class="keyword">case</span> ex: <span class="type">Exception</span> =&gt; tx.rollback()</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//取消关注</span></span><br><span class="line">            session.run(<span class="string">"match(:User &#123;uid: '"</span>+followeruid+<span class="string">"'&#125;) -[r:follow]-&gt; (:User &#123;uid: '"</span>+followuid+<span class="string">"'&#125;) delete r"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//关闭会话</span></span><br><span class="line">        session.close()</span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        driver.close()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//启动任务</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">//等待任务停止</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RealTimeFollowScala-scala"><a href="#RealTimeFollowScala-scala" class="headerlink" title="RealTimeFollowScala.scala"></a>RealTimeFollowScala.scala</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那下面我们就开始处理试卷。那你这边注意，你首先将这个卡不卡呀，转一下。转换为RDD。然后呢，就可以。就要用RDD中的这个for each part。好，第二和一起，阿D先把它转换成阿里D。这样这里面传过来其实就是阿里列。转成R之后，我们就可以调用它里面这个for each了，那这样的话就可以一次处理一批的数据。比如说一次处理一个分区的数。为什么要这样做呢？因为我们在这里面需要去连neo4j。我们要把这个具体用户实时的这个关注，以及取消关注这些关系呢，给他维护到neo4j里面，所以说在这呢，相当于我们需要获取用户这些链接，然后呢去操作它。</span><br><span class="line"></span><br><span class="line">那这样的话，你最好是一批获取一次链接，这样效率比较高对吧。我每一条数据过来都获取链接，这样效率比较低。因为本身你这个实时其实就是一小批一小批的数据，那针对这一小批里面的数据，你可以再按分区对吧，每个分区获取一次链接。啊，for。这是一个AI，嗯。好，那在这里面。我们就可以调用那个it点，不好意思就可以迭代它里面的每一条数据了，对吧。这是一个了吧。那现在注意，我们需要先获取u或这个链接。怎么获取呢？因为我们提前已经把那个六后力杠Java杠driver那个依赖已经引进去了，所以说你在这儿可以直接用。哇。第二。我们使用这个。这个前面呢，是那个具体的URLURL其实就是那个开头的那个。这个零四冒号7687。后面的话我们需要指定下这个用户名和密码，就这个奥。basic。嗯，指定一下用户名。你徒弟还有密码。嗯。好，这样的话，下面我们就获取到这个用户的一个链接了。那下面的话，我们需要使用这个链接呢，开启一个会话。开启绘画之后才可以去用啊。这个。那这样的话，在里面就可以使用这个session。那你在最后啊，用完之后啊，需要把它们两个给它关闭掉，先把这个写一下，关闭会话。session。close。嗯。关闭连接。there are the clothes。好，那下面呢，我们来把里面这个代码给它完善一下，这里面是核心的代码。那在这里面，我们那就可以获取这个粉丝关注相关的数据。它其实呢，就是那个阶层串出了一块阶层数据。在这了。men。这样的话就可以获取到这行数据了。把这行计算数据获取到，获取到之后注意下面呢，我们来解析数据。用杰森。yeah。us objects。嗯，把它传过去。这个呢，其实就是user。follow。好，那接下来我们就从它里面去获取一些数据。获取数据类型。到底是？关注哦，取消关注。你又使用那个user点，咱们刚才分析了，它里面有一个DC这个词对吧。follow types。那接下来我们还需要获取这个follow u ID。嗯。thatw。嗯。W。what ID？接下来获取了一个follow u ID。follow u ID。嗯嗯。好，这三个核心的这个字段呢，我们都获取到。那获取到之后，下面的话，我们其实就可以根据这个photo这个类型来执行具体关注或者是取消关注这个操作。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">那我们接着来判断一下。如果呀，这个。follow the equal。这个full time。如果说你这个值等于follow，那相当于就是关注。else。就是取消关注了。添加关注。这是取消关注。注意你说这种写法。和这样写，你说我把它放到前面。这里面呢，写那个follow有什么区别吗？注意你这种写法，如果说。他呢，是空是闹，你这样调用会报了一个空，人异常啊。但我把它放到前面，那肯定不会报空人了啊，这肯定是有值的。你就算你那个pro等于no，这个顶多是不相等，它也不会出现这个控制异常啊，这个需要注意一下。下面呢，我们来执行添加关注操作。这需要注意。因为呢，它这里面啊，会涉及多条命令。所以说呢，我们需要使用事物。类似于我们先需要添加两个节点，然后呢，再给这两个基点绑定一个关注关系。这样的话就是三条命令。这三条命令在执行的时候，要么都成功，要么都失败。好，那所以说在这我们需要这样来做，通过session。第二。right transaction。开启一个事物。你要传一个，你有一个栓死action。walk。注意这块这个泛型啊，表示你这里面这个代码啊，最终的返回的数据类型在这我们不需要返回东西，所以说呢。把要空就行了。实现里面微信的方法。就这个。好，那这里面就需要实现我们具体的逻辑了。注意。它这里面相当有一个数啊transaction，所以说我们直接调TS点。你看它里面传的是一个query string，其实就是具体的一个执行的一个语句。墨。user。ID。这是一个字符串，所以说要加个单引号啊。那我们在这获取这个UID。那下面还有一个。这是follow u ID对吧。先把这两个节点给它创建了。那下面我们要给它们两个绑定关系。注意你在这绑定关系的话，这个相当于它是分开执行的啊，只不过说他们在一个事物里面，所以你在这啊，先添加这两个下面再来查。match。把你刚才添加这两个节点查出来，再给它们两个绑定关系。user。ad。这是这个UID，我们先把这个查出来，然后呢，再把第二个。给它起个名字叫B。user。这是UID。ID对吧，这样的话，你看其实我们就把这两个节点个查出来了。你前面是添加在这，把他们两个都查出来，这查第一个，这是查第二个。并且呢，给每一个都起了一个别名，它叫a，它叫B，对吧。那后面呢，就可以使用这个。墨。a。好。这样就可以了。在这x.com提交15。那注意，如果说他在执行的时候失败了，这样的话，我们需要让这个事物回滚。catch。直接捕获这个最大的异常。只要抛一场，我们就调用它的一个back。这样就可以了。所以这里面啊，执行的还是咱们前面讲那个step语句对吧。OK，这是添加关注。那取消关注就简单了呀。取消关注，其实呢，一条命令就可以了。相当于呢，我使用match把它查出来，然后后边的话使用一个DD的，那这样的话，其实呢，你就不需要开启这种事物了，因为你相当于取消关注，只有一条命令，就不需要开启这个事故了啊，然后自动提交就行。所以说我们直接使用这个session点。软。match。user。UID。说了UID。然后面他呢。follow。这个哥们在。UID。follow u ID。注意这时候呢，给这个关系呢，起一个名字叫啊。所以说在最后面直接把这个关系给它删掉就行。这个意思啊。这个呢，就是取消关注，取消他们两个之间的佛的关系。这样的话其实就可以了啊。我们这里面的一个核心代码就搞定了。最后是一个启动任务。start。应该在这里面。这个是等待任务停止。嗯。嗯。好，这样就可以了。这样的话，我们这个代码啊，其实就开发好了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">那接下来我们需要确保卡夫卡服务cub的采集程序、数据分发程序以及服务端接口服务正常运行。那这样的话，我们就可以在本地去运行这个Spark人命程序了。好在这样我们把它启动起来。先在本地去执行一下。等这个程序启动之后呢，我们再去调那个接口，模拟产生这个用户实时的关注和取消关注数据。你先确认你这个人命程序是正常的</span><br><span class="line"></span><br><span class="line">看到没有，它这个程序不停就说明了它是OK的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">好，那接下来呢，我们就来模拟产生一些数据。找到这个generate date这个项目对吧。我们调里面这个generate real time执行这个，它每执行一次都会产生一条这个实时的一个粉丝关注或者取消关注的数据。执行一下。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261635084.png" alt="image-20230426163505984"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">是一个follow。你看这个2009FOLLOW了1005，那我们来看一下。在这刷新一下，或者你重新点那个follow，或者你点那个刷新都可以。看到没有2009FOLLOW了1005没问题吧。我们之前是没有这个的啊，之前它是没有这个follow关系的。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261636657.png" alt="image-20230426163612378"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OK，所以说呢，我们这个代码呢，正常执行了。</span><br><span class="line"></span><br><span class="line">但是注意了，目前这个程序啊，其实是存在一些问题的，因为数据通过filebeat的采集，再到kafka，最终我们消费的数据顺序和数据产生的顺序可能就不一致了。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261641417.png" alt="image-20230426164158476"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">举个例子：</span><br><span class="line">用户A先关注了用户B</span><br><span class="line">用户A很快又取关了用户B</span><br><span class="line">这样就会产生两条日志数据，这两条数据经过采集分发之后，最后我们消费过来的数据顺序很有可能是这样的</span><br><span class="line">用户A取关用户B</span><br><span class="line">用户A关注了用户B</span><br><span class="line">这种最终的结果就是用户A关注了用户B，那这样就不准确了，虽然这种情况是小概率事件，但是也是存在的，在SparkStreaming中如何解决呢？</span><br><span class="line">由于SparkStreaming是一小批一小批处理的，所以我们可以针对每次获取的这一小批数据根据数据产生的时间戳进行排序，从小到大，然后按照这个顺序去操作这些数据，这样其实就能在很大程度上避免我们刚才分析的这种问题了，但是这样并没有完全解决掉这个问题，如果两条数据分到了两批数据里面，还是会存在这个问题的，不过这种情况出现的概率就很低了，我们暂时就忽略不计了。</span><br><span class="line">在这我把这个思路分析好了，给大家留一个作业，大家下去之后自己尝试动手实现一下这个功能</span><br><span class="line"></span><br><span class="line">使用sparkstreaming解决数据乱序的问题。因为我们的原始数据里面，里面有个FUID，还有UID，还有一个时间戳，对吧，那现在在sparkstreaming里面，你获取到这一批数据之后，你对这一批数据按照time stamp进行排序，从小到大。排完序之后呢，再去执行这些操作。这样就可以了。大家呢，先自己动手做一下啊。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那接下来呢，我们来对这个代码啊，再给它完善一下。可以让它呢，同时支持在本地运行和集群运行。把这个给它停掉。</span><br><span class="line"></span><br><span class="line">这里面啊，可能会发生变化的这些信息呢，全部都给它提取出来。让它支持动态传递啊，这样的话，我们这个代码呢，更会更加通用。</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.spark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.<span class="type">JSON</span></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.<span class="type">StringDeserializer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010.&#123;<span class="type">ConsumerStrategies</span>, <span class="type">KafkaUtils</span>, <span class="type">LocationStrategies</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.driver.&#123;<span class="type">AuthTokens</span>, <span class="type">GraphDatabase</span>, <span class="type">Transaction</span>, <span class="type">TransactionWork</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务2：</span></span><br><span class="line"><span class="comment"> * 实时维护粉丝关注数据</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">RealTimeFollowScala</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> masterUrl = <span class="string">"local[2]"</span></span><br><span class="line">    <span class="keyword">var</span> appName = <span class="string">"RealTimeFollowScala"</span></span><br><span class="line">    <span class="keyword">var</span> seconds = <span class="number">5</span></span><br><span class="line">    <span class="keyword">var</span> kafkaBrokers = <span class="string">"bigdata01:9092,bigdata02:9092,bigdata03:9092"</span></span><br><span class="line">    <span class="keyword">var</span> groupId = <span class="string">"con_1"</span></span><br><span class="line">    <span class="keyword">var</span> topic = <span class="string">"user_follow"</span></span><br><span class="line">    <span class="keyword">var</span> boltUrl = <span class="string">"bolt://bigdata04:7687"</span></span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">"neo4j"</span></span><br><span class="line">    <span class="keyword">var</span> password = <span class="string">"admin"</span></span><br><span class="line">    <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      masterUrl = args(<span class="number">0</span>)</span><br><span class="line">      appName = args(<span class="number">1</span>)</span><br><span class="line">      seconds = args(<span class="number">2</span>).toInt</span><br><span class="line">      kafkaBrokers = args(<span class="number">3</span>)</span><br><span class="line">      groupId = args(<span class="number">4</span>)</span><br><span class="line">      topic = args(<span class="number">5</span>)</span><br><span class="line">      boltUrl = args(<span class="number">6</span>)</span><br><span class="line">      username = args(<span class="number">7</span>)</span><br><span class="line">      password = args(<span class="number">8</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建StreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(masterUrl).setAppName(appName)</span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(seconds))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定kafka的配置信息</span></span><br><span class="line">    <span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>,<span class="type">Object</span>](</span><br><span class="line">      <span class="comment">//kafka的broker地址信息</span></span><br><span class="line">      <span class="string">"bootstrap.servers"</span>-&gt;kafkaBrokers,</span><br><span class="line">      <span class="comment">//key的序列化类型</span></span><br><span class="line">      <span class="string">"key.deserializer"</span> -&gt;classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="comment">//value的序列化类型</span></span><br><span class="line">      <span class="string">"value.deserializer"</span> -&gt;classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="comment">//消费者组id</span></span><br><span class="line">      <span class="string">"group.id"</span> -&gt; groupId,</span><br><span class="line">      <span class="comment">//消费策略</span></span><br><span class="line">      <span class="string">"auto.offset.reset"</span> -&gt; <span class="string">"latest"</span>,</span><br><span class="line">      <span class="comment">//自动提交offset</span></span><br><span class="line">      <span class="string">"enable.auto.commit"</span> -&gt; (<span class="literal">true</span>: java.lang.<span class="type">Boolean</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定要读取的topic的名称</span></span><br><span class="line">    <span class="keyword">val</span> topics = <span class="type">Array</span>(topic)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取消费kafka的数据流</span></span><br><span class="line">    <span class="keyword">val</span> kafkaDstream = <span class="type">KafkaUtils</span>.createDirectStream[<span class="type">String</span>, <span class="type">String</span>](</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="type">LocationStrategies</span>.<span class="type">PreferConsistent</span>,</span><br><span class="line">      <span class="type">ConsumerStrategies</span>.<span class="type">Subscribe</span>[<span class="type">String</span>, <span class="type">String</span>](topics, kafkaParams)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理数据</span></span><br><span class="line">    <span class="comment">//首先将kafkaDstream转换为rdd，然后就可以调用rdd中的foreachPartition了</span></span><br><span class="line">    kafkaDstream.foreachRDD(rdd=&gt;&#123;</span><br><span class="line">      <span class="comment">//一次处理一个分区的数据</span></span><br><span class="line">      rdd.foreachPartition(it=&gt;&#123;</span><br><span class="line">        <span class="comment">//获取neo4j的连接</span></span><br><span class="line">        <span class="keyword">val</span> driver = <span class="type">GraphDatabase</span>.driver(boltUrl, <span class="type">AuthTokens</span>.basic(username, password))</span><br><span class="line">        <span class="comment">//开启一个会话</span></span><br><span class="line">        <span class="keyword">val</span> session = driver.session()</span><br><span class="line">        it.foreach(record=&gt;&#123;</span><br><span class="line">          <span class="comment">//获取粉丝关注相关数据</span></span><br><span class="line">          <span class="keyword">val</span> line = record.value()</span><br><span class="line">          <span class="comment">//解析数据</span></span><br><span class="line">          <span class="keyword">val</span> userFollowObj = <span class="type">JSON</span>.parseObject(line)</span><br><span class="line">          <span class="comment">//获取数据类型，关注 or  取消关注</span></span><br><span class="line">          <span class="keyword">val</span> followType = userFollowObj.getString(<span class="string">"desc"</span>)</span><br><span class="line">          <span class="comment">//获取followeruid</span></span><br><span class="line">          <span class="keyword">val</span> followeruid = userFollowObj.getString(<span class="string">"followeruid"</span>)</span><br><span class="line">          <span class="comment">//获取followuid</span></span><br><span class="line">          <span class="keyword">val</span> followuid = userFollowObj.getString(<span class="string">"followuid"</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span>(<span class="string">"follow"</span>.equals(followType))&#123; <span class="comment">// 顺序前后不要改</span></span><br><span class="line">            <span class="comment">//添加关注：因为涉及多条命令，所以需要使用事务</span></span><br><span class="line">            session.writeTransaction(<span class="keyword">new</span> <span class="type">TransactionWork</span>[<span class="type">Unit</span>] ()&#123;</span><br><span class="line">              <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span>(tx: <span class="type">Transaction</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                  tx.run(<span class="string">"merge (:User &#123;uid:'"</span>+followeruid+<span class="string">"'&#125;)"</span>)</span><br><span class="line">                  tx.run(<span class="string">"merge (:User &#123;uid:'"</span>+followuid+<span class="string">"'&#125;)"</span>)</span><br><span class="line">                  tx.run(<span class="string">"match(a:User &#123;uid:'"</span>+followeruid+<span class="string">"'&#125;),(b:User &#123;uid:'"</span>+followuid+<span class="string">"'&#125;) merge (a) -[:follow]-&gt; (b)"</span>)</span><br><span class="line">                  <span class="comment">//提交事务</span></span><br><span class="line">                  tx.commit()</span><br><span class="line">                &#125;<span class="keyword">catch</span> &#123;</span><br><span class="line">                  <span class="keyword">case</span> ex: <span class="type">Exception</span> =&gt; tx.rollback()</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//取消关注</span></span><br><span class="line">            session.run(<span class="string">"match (:User &#123;uid:'"</span>+followeruid+<span class="string">"'&#125;) -[r:follow]-&gt; (:User &#123;uid:'"</span>+followuid+<span class="string">"'&#125;) delete r"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//关闭会话</span></span><br><span class="line">        session.close()</span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        driver.close()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//启动任务</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">//等待任务停止</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：建议这个项目中的所有依赖包全部在spark-submit脚本后面的–jars中指定(neo4j-java-driver、fastjson、spark-streaming-kafka这三个需要手动指定，其它的spark安装包已有)，这样最终生成的任_务jar就比较小了，提交任务的时候速度会比较快。所以这里面的jar-with-dependencies插件就可以不使用了，因为我们打jar包的时候不需要把依赖打进去，这个时候也不需要在依赖中添加provided参数了。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261654714.png" alt="image-20230426165401187"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261704743.png" alt="image-20230426170407568"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">为了方便的提交任务，我们再开发一个任务提交脚本，</span><br><span class="line">在项目中创建一个bin目录，把脚本放到这个bin目录一样，这样便于管理维护</span><br><span class="line">startRealTimeFollow.sh</span><br></pre></td></tr></table></figure>

<h3 id="startRealTimeFollow-sh"><a href="#startRealTimeFollow-sh" class="headerlink" title="startRealTimeFollow.sh"></a>startRealTimeFollow.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">masterUrl&#x3D;&quot;yarn-cluster&quot;</span><br><span class="line">master&#x3D;&#96;echo $&#123;masterUrl&#125; | awk -F&#39;-&#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">deployMode&#x3D;&#96;echo $&#123;masterUrl&#125; | awk -F&#39;-&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line"></span><br><span class="line">appName&#x3D;&quot;RealTimeFollowScala&quot;</span><br><span class="line">seconds&#x3D;5</span><br><span class="line">kafkaBrokers&#x3D;&quot;bigdata01:9092,bigdata02:9092,bigdata03:9092&quot;</span><br><span class="line">groupId&#x3D;&quot;con_1&quot;</span><br><span class="line">topic&#x3D;&quot;user_follow&quot;</span><br><span class="line">boltUrl&#x3D;&quot;bolt:&#x2F;&#x2F;bigdata04:7687&quot;</span><br><span class="line">username&#x3D;&quot;neo4j&quot;</span><br><span class="line">password&#x3D;&quot;admin&quot;</span><br><span class="line"></span><br><span class="line">yarnCommonLib&#x3D;&quot;hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;yarnCommonLib&quot;</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.RealTimeFollowScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;&#x2F;fastjson-1.2.68.jar,$&#123;yarnCommonLib&#125;&#x2F;spark-streaming-kafka-0-10_2.11-2.4.3.jar,$&#123;yarnCommonLib&#125;&#x2F;neo4j-java-driver-4.1.1.jar,$&#123;yarnCommonLib&#125;&#x2F;kafka-clients-2.4.1.jar,$&#123;yarnCommonLib&#125;&#x2F;reactive-streams-1.0.3.jar \</span><br><span class="line">&#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;jobs&#x2F;real_time_follow-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;seconds&#125; $&#123;kafkaBrokers&#125; $&#123;groupId&#125; $&#123;topic&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jar包路径可以是本地，也可以是hdfs上，建议hdfs</span><br><span class="line"></span><br><span class="line">在本地如何找这些jar包?在.m2(是maven本地目录)目录下去找，然后再上传</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">针对这个参数：yarnCommonLib&#x3D;&quot;hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;yarnCommonLib&quot;</span><br><span class="line">使用公共的依赖包目录，使用起来方便，管理维护起来也方便，并且还可以提高任务执行效率，因为当我们向集群提交的时候，任务需要的依赖jar包是会自动上传到hdfs的一个临时目录的，如果我们提前把jar包上传到hdfs上面，就不会再重新上传了</span><br><span class="line"></span><br><span class="line">针对–jars后面指定的依赖jar包，需要额外再指定kafka-clients-2.4.1.jar和reactive-streams-1.0.3.jar，一个是kafka的，一个是neo4j需要依赖的，否则提交任务到集群执行是会报错的。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261823893.png" alt="image-20230426182327467"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261841795.png" alt="image-20230426184121107"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261842193.png" alt="image-20230426184238164"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261843621.png" alt="image-20230426184330270"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">重新生成一条实时关注数据，查看结果</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261844934.png" alt="image-20230426184425485"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">停止sparkStreaming任务</span><br><span class="line"></span><br><span class="line">这是正常的一帆风顺的流程。</span><br><span class="line"></span><br><span class="line">那我们如果是第一次这样做，肯定会遇到各种各样的问题，在这里来给大家复现一下。</span><br><span class="line">按照正常的思路，这个项目依赖的jar包最开始我们肯定只会使用这三个</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">masterUrl&#x3D;&quot;yarn-cluster&quot;</span><br><span class="line">master&#x3D;&#96;echo $&#123;masterUrl&#125; | awk -F&#39;-&#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">deployMode&#x3D;&#96;echo $&#123;masterUrl&#125; | awk -F&#39;-&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line"></span><br><span class="line">appName&#x3D;&quot;RealTimeFollowScala&quot;</span><br><span class="line">seconds&#x3D;5</span><br><span class="line">kafkaBrokers&#x3D;&quot;bigdata01:9092,bigdata02:9092,bigdata03:9092&quot;</span><br><span class="line">groupId&#x3D;&quot;con_1&quot;</span><br><span class="line">topic&#x3D;&quot;user_follow&quot;</span><br><span class="line">boltUrl&#x3D;&quot;bolt:&#x2F;&#x2F;bigdata04:7687&quot;</span><br><span class="line">username&#x3D;&quot;neo4j&quot;</span><br><span class="line">password&#x3D;&quot;admin&quot;</span><br><span class="line"></span><br><span class="line">yarnCommonLib&#x3D;&quot;hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;yarnCommonLib&quot;</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.RealTimeFollowScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;&#x2F;fastjson-1.2.68.jar,$&#123;yarnCommonLib&#125;&#x2F;spark-streaming-kafka-0-10_2.11-2.4.3.jar,$&#123;yarnCommonLib&#125;&#x2F;neo4j-java-driver-4.1.1.jar \</span><br><span class="line">&#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;jobs&#x2F;real_time_follow-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;seconds&#125; $&#123;kafkaBrokers&#125; $&#123;groupId&#125; $&#123;topic&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x startRealTimeFollow.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时你会发现任务执行失败了</span><br><span class="line">报错信息如下，在控制台就可以看到具体的报错信息：</span><br><span class="line">这个报错信息表示是缺少kafka的一些依赖，org&#x2F;apache&#x2F;kafka&#x2F;common&#x2F;serialization&#x2F;StringDeserializer，通过这里面的包名可以看出来，这个是kafka-clients的依赖，如果直接看不出来，那就到网上搜一下这个报错信息看看有没有收获java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;kafka&#x2F;common&#x2F;serialization&#x2F;StringDeserializer</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">所以我们在脚本中再添加这个kafka-client的依赖</span><br><span class="line"></span><br><span class="line">再提交</span><br><span class="line"></span><br><span class="line">发现任务还是执行失败，在控制台可以看到报错信息如下</span><br><span class="line"></span><br><span class="line">这里提示neo4j中的org.neo4j.driver.Config初始化失败，但是neo4j的依赖我们也添加进去了，为什么还会报这个错呢？</span><br><span class="line"></span><br><span class="line">如果这里看不到有用的错误信息，我们可以尝试到YARN中查看</span><br><span class="line">在YARN的8088界面中我们进入到spark的任务界面(注意：需要确保hadoop的日志聚合功能开启，以及Spark的historyServer进程也是开启的。)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122548.png" alt="image-20230426212208228"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122638.png" alt="image-20230426212224386"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262122756.png" alt="image-20230426212235821"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">其实根源是在这，主要是缺少这个类org.reactivestreams.Publisher，最终导致的org.neo4j.driver.Config无法初始化。</span><br><span class="line"></span><br><span class="line">那这个类org.reactivestreams.Publisher是从哪来的呢？</span><br><span class="line">它是neo4j需要使用的一个依赖里面的类</span><br><span class="line">到哪找呢？</span><br><span class="line">查看neo4j-java-driver(子pom里ctrl+点击neo4j-java-driver)这个依赖的依赖，会发现它里面确实有一个依赖的名称是org.reactivestreams，所以说我们还需要把这个依赖的jar包找到引进去。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">到此为止，把这个jar包再加进去就可以正常执行了，这就是我们排查问题的一个思路和流程，这个思路大家一定要学以致用。</span><br><span class="line"></span><br><span class="line">这个任务开发到这就结束了</span><br></pre></td></tr></table></figure>

<h2 id="数据计算之每天定时更新主播等级-第三个任务"><a href="#数据计算之每天定时更新主播等级-第三个任务" class="headerlink" title="数据计算之每天定时更新主播等级(第三个任务)"></a>数据计算之每天定时更新主播等级(第三个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主播等级数据来源于服务端数据库(定时增量导入到HDFS中)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262130828.png" alt="image-20230426213050640"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">注意：表中有两个等级字段，一个是用户等级，一个是主播等级</span><br><span class="line"></span><br><span class="line">在这我们需要使用主播等级</span><br><span class="line">针对这份数据，最核心的两个字段是第2列和第4列</span><br><span class="line">第2列是用户uid</span><br><span class="line">第4列是主播等级anchor_level</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个任务需要做的是把每天主播等级发生了变化的数据更新到neo4j中，在neo4j中也维护一份主播的等级</span><br><span class="line">创建一个子module：update_user_level</span><br><span class="line">创建scala目录，添加scala2.11的sdk</span><br><span class="line">引入依赖</span><br></pre></td></tr></table></figure>

<h3 id="所需依赖"><a href="#所需依赖" class="headerlink" title="所需依赖"></a>所需依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="UpdateUserLevelScala-scala"><a href="#UpdateUserLevelScala-scala" class="headerlink" title="UpdateUserLevelScala.scala"></a>UpdateUserLevelScala.scala</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在update_user_level下面的scala里面创建包：com.imooc.spark</span><br><span class="line">创建类：UpdateUserLevelScala</span><br><span class="line">代码如下</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.spark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.driver.&#123;<span class="type">AuthTokens</span>, <span class="type">GraphDatabase</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务3：</span></span><br><span class="line"><span class="comment"> * 每天定时更新主播等级</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">UpdateUserLevelScala</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> masterUrl = <span class="string">"local"</span></span><br><span class="line">    <span class="keyword">var</span> appName = <span class="string">"UpdateUserLevelScala"</span></span><br><span class="line">    <span class="keyword">var</span> filePath = <span class="string">"hdfs://bigdata01:9000/data/cl_level_user/20260201"</span></span><br><span class="line">    <span class="keyword">var</span> boltUrl = <span class="string">"bolt://bigdata04:7687"</span></span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">"neo4j"</span></span><br><span class="line">    <span class="keyword">var</span> password = <span class="string">"admin"</span></span><br><span class="line">    <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      masterUrl = args(<span class="number">0</span>)</span><br><span class="line">      appName = args(<span class="number">1</span>)</span><br><span class="line">      filePath = args(<span class="number">2</span>)</span><br><span class="line">      boltUrl = args(<span class="number">3</span>)</span><br><span class="line">      username = args(<span class="number">4</span>)</span><br><span class="line">      password = args(<span class="number">5</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">      .setMaster(masterUrl)</span><br><span class="line">      .setAppName(appName)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取用户等级数据</span></span><br><span class="line">    <span class="keyword">val</span> linesRDD = sc.textFile(filePath)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验数据准确性</span></span><br><span class="line">    <span class="keyword">val</span> filterRDD = linesRDD.filter(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> fields = line.split(<span class="string">"\t"</span>)</span><br><span class="line">      <span class="comment">//判断每一行的列数是否正确，以及这一行是不是表头</span></span><br><span class="line">      <span class="keyword">if</span> (fields.length == <span class="number">8</span> &amp;&amp; !fields(<span class="number">0</span>).equals(<span class="string">"id"</span>)) &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//处理数据</span></span><br><span class="line">    filterRDD.foreachPartition(it=&gt;&#123;</span><br><span class="line">      <span class="comment">//获取neo4j的连接</span></span><br><span class="line">      <span class="keyword">val</span> driver = <span class="type">GraphDatabase</span>.driver(boltUrl, <span class="type">AuthTokens</span>.basic(username, password))</span><br><span class="line">      <span class="comment">//开启一个会话</span></span><br><span class="line">      <span class="keyword">val</span> session = driver.session()</span><br><span class="line">      it.foreach(line=&gt;&#123;</span><br><span class="line">        <span class="keyword">val</span> fields = line.split(<span class="string">"\t"</span>)</span><br><span class="line">        <span class="comment">//添加等级</span></span><br><span class="line">        session.run(<span class="string">"merge(u:User &#123;uid:'"</span>+fields(<span class="number">1</span>).trim+<span class="string">"'&#125;) set u.level = "</span>+fields(<span class="number">3</span>).trim) <span class="comment">//.trim防止空格被引入</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">//关闭会话</span></span><br><span class="line">      session.close()</span><br><span class="line">      <span class="comment">//关闭连接</span></span><br><span class="line">      driver.close()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地执行"><a href="#本地执行" class="headerlink" title="本地执行"></a>本地执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在本地执行代码</span><br><span class="line">效果如下：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262214894.png" alt="image-20230426221422858"></p>
<h3 id="startUpdateUserLevel-sh"><a href="#startUpdateUserLevel-sh" class="headerlink" title="startUpdateUserLevel.sh"></a>startUpdateUserLevel.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">开发任务执行脚本</span><br><span class="line">startUpdateUserLevel.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认获取昨天时间</span></span><br><span class="line">dt=`date -d "1 days ago" +"%Y%m%d"`</span><br><span class="line">if [ "x$1" != "x" ]</span><br><span class="line">then</span><br><span class="line">dt=$1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">HDFS输入数据路径</span></span><br><span class="line">filePath="hdfs://bigdata01:9000/data/cl_level_user/$&#123;dt&#125;"</span><br><span class="line"></span><br><span class="line">masterUrl="yarn-cluster"</span><br><span class="line">master=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $1&#125;'`</span><br><span class="line">deployMode=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $2&#125;'`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">appName="UpdateUserLevelScala"`date +%s` // 加的这个是为了后面过滤任务列表，查看是否执行成功</span><br><span class="line">boltUrl="bolt://bigdata04:7687"</span><br><span class="line">username="neo4j"</span><br><span class="line">password="admin"</span><br><span class="line"></span><br><span class="line">yarnCommonLib="hdfs://bigdata01:9000/yarnCommonLib"</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.UpdateUserLevelScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;/neo4j-java-driver-4.1.1.jar,$&#123;yarnCommonLib&#125;/reactive-streams-1.0.3.jar \</span><br><span class="line">/data/soft/video_recommend/jobs/update_user_level-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;filePath&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">验证任务执行状态</span></span><br><span class="line">appStatus=`yarn application -appStates FINISHED -list | grep $&#123;appName&#125; | awk '&#123;print $7&#125;'`</span><br><span class="line">if [ "$&#123;appStatus&#125;" != "SUCCEEDED" ]</span><br><span class="line">then</span><br><span class="line">    echo "任务执行失败"</span><br><span class="line">    # 发送短信或者邮件</span><br><span class="line">else</span><br><span class="line">    echo "任务执行成功"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262237405.png" alt="image-20230426223703754"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262238354.png" alt="image-20230426223841949"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262239377.png" alt="image-20230426223922101"></p>
<h3 id="打包配置"><a href="#打包配置" class="headerlink" title="打包配置"></a>打包配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>

<h3 id="子项目完整pom"><a href="#子项目完整pom" class="headerlink" title="子项目完整pom"></a>子项目完整pom</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;update_user_level&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262246028.png" alt="image-20230426224642629"></p>
<h3 id="集群执行"><a href="#集群执行" class="headerlink" title="集群执行"></a>集群执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x startUpdateUserLevel.sh 20260201</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262254705.png" alt="image-20230426225404311"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262254651.png" alt="image-20230426225455351"></p>
<h2 id="数据计算之每天定时更新用户活跃时间-第四个任务"><a href="#数据计算之每天定时更新用户活跃时间-第四个任务" class="headerlink" title="数据计算之每天定时更新用户活跃时间(第四个任务)"></a>数据计算之每天定时更新用户活跃时间(第四个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据来源于客户端上报，每天只要打开过APP就会上报数据</span><br><span class="line">数据格式：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262258359.png" alt="image-20230426225850610"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">之前我们通过埋点模拟上报数据，通过flume落盘到hdfs上面，这样在hdfs上面产生的目录会使用当天日期，为了保证我这里使用的目录和大家都保持一致，所以在这我就生成一个固定的日期目录</span><br><span class="line">使用代码GenerateUserActiveDataV2，在代码中指定日期2026-02-01，这样会把模拟生成的用户活跃数据直接上传到hdfs上面，因为之前的数据采集流程我们已经详细分析过了，所以在这就直接把数据上传到hdfs上面了。</span><br></pre></td></tr></table></figure>

<h3 id="生成数据"><a href="#生成数据" class="headerlink" title="生成数据"></a>生成数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">执行代码：GenerateUserActiveDataV2，将会把数据上传到hdfs的这个目录下</span><br><span class="line">hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;user_active&#x2F;20260201&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262316695.png" alt="image-20230426231654458"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262323730.png" alt="image-20230426232332517"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这个任务需要做的是把每天主动活跃的用户更新到neo4j中，在neo4j中维护一份用户的最新活跃时间</span><br><span class="line">创建子module项目：update_user_active</span><br><span class="line">创建scala目录，引入scala2.11版本的sdk</span><br><span class="line">在scala目录中创建包：com.imooc.spark</span><br><span class="line">引入依赖</span><br></pre></td></tr></table></figure>

<h3 id="所需依赖-1"><a href="#所需依赖-1" class="headerlink" title="所需依赖"></a>所需依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="UpdateUserActiveScala-scala"><a href="#UpdateUserActiveScala-scala" class="headerlink" title="UpdateUserActiveScala.scala"></a>UpdateUserActiveScala.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.spark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.<span class="type">JSON</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.driver.&#123;<span class="type">AuthTokens</span>, <span class="type">GraphDatabase</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务4：</span></span><br><span class="line"><span class="comment"> * 每天定时更新用户活跃时间</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">UpdateUserActiveScala</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> masterUrl = <span class="string">"local"</span></span><br><span class="line">    <span class="keyword">var</span> appName = <span class="string">"UpdateUserActiveScala"</span></span><br><span class="line">    <span class="keyword">var</span> filePath = <span class="string">"hdfs://bigdata01:9000/data/user_active/20260201"</span></span><br><span class="line">    <span class="keyword">var</span> boltUrl = <span class="string">"bolt://bigdata04:7687"</span></span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">"neo4j"</span></span><br><span class="line">    <span class="keyword">var</span> password = <span class="string">"admin"</span></span><br><span class="line">    <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      masterUrl = args(<span class="number">0</span>)</span><br><span class="line">      appName = args(<span class="number">1</span>)</span><br><span class="line">      filePath = args(<span class="number">2</span>)</span><br><span class="line">      boltUrl = args(<span class="number">3</span>)</span><br><span class="line">      username = args(<span class="number">4</span>)</span><br><span class="line">      password = args(<span class="number">5</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">      .setMaster(masterUrl)</span><br><span class="line">      .setAppName(appName)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取用户活跃数据</span></span><br><span class="line">    <span class="keyword">val</span> linesRDD = sc.textFile(filePath)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理数据 </span></span><br><span class="line">    linesRDD.foreachPartition(it=&gt;&#123;</span><br><span class="line">      <span class="comment">//获取neo4j的连接</span></span><br><span class="line">      <span class="keyword">val</span> driver = <span class="type">GraphDatabase</span>.driver(boltUrl, <span class="type">AuthTokens</span>.basic(username, password))</span><br><span class="line">      <span class="comment">//开启一个会话</span></span><br><span class="line">      <span class="keyword">val</span> session = driver.session()</span><br><span class="line">      it.foreach(line=&gt;&#123;</span><br><span class="line">        <span class="keyword">val</span> jsonObj = <span class="type">JSON</span>.parseObject(line)</span><br><span class="line">        <span class="keyword">val</span> uid = jsonObj.getString(<span class="string">"uid"</span>)</span><br><span class="line">        <span class="keyword">val</span> timeStamp = jsonObj.getString(<span class="string">"UnixtimeStamp"</span>)</span><br><span class="line">        <span class="comment">//添加用户活跃时间</span></span><br><span class="line">        session.run(<span class="string">"merge(u:User &#123;uid:'"</span>+uid+<span class="string">"'&#125;) set u.timestamp = "</span>+timeStamp)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">//关闭会话</span></span><br><span class="line">      session.close()</span><br><span class="line">      <span class="comment">//关闭连接</span></span><br><span class="line">      driver.close()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地执行-1"><a href="#本地执行-1" class="headerlink" title="本地执行"></a>本地执行</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262336732.png" alt="image-20230426233615284"></p>
<h3 id="startUpdateUserActive-sh"><a href="#startUpdateUserActive-sh" class="headerlink" title="startUpdateUserActive.sh"></a>startUpdateUserActive.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认获取昨天时间</span></span><br><span class="line">dt=`date -d "1 days ago" +"%Y%m%d"`</span><br><span class="line">if [ "x$1" != "x" ]</span><br><span class="line">then</span><br><span class="line">dt=$1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">HDFS输入数据路径</span></span><br><span class="line">filePath="hdfs://bigdata01:9000/data/user_active/$&#123;dt&#125;"</span><br><span class="line"></span><br><span class="line">masterUrl="yarn-cluster"</span><br><span class="line">master=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $1&#125;'`</span><br><span class="line">deployMode=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $2&#125;'`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">appName="UpdateUserActiveScala"`date +%s`</span><br><span class="line">boltUrl="bolt://bigdata04:7687"</span><br><span class="line">username="neo4j"</span><br><span class="line">password="admin"</span><br><span class="line"></span><br><span class="line">yarnCommonLib="hdfs://bigdata01:9000/yarnCommonLib"</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.UpdateUserActiveScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;/fastjson-1.2.68.jar,,$&#123;yarnCommonLib&#125;/neo4j-java-driver-4.1.1.jar,$&#123;yarnCommonLib&#125;/reactive-streams-1.0.3.jar \</span><br><span class="line">/data/soft/video_recommend/jobs/update_user_active-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;filePath&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">验证任务执行状态</span></span><br><span class="line">appStatus=`yarn application -appStates FINISHED -list | grep $&#123;appName&#125; | awk '&#123;print $7&#125;'`</span><br><span class="line">if [ "$&#123;appStatus&#125;" != "SUCCEEDED" ]</span><br><span class="line">then</span><br><span class="line">    echo "任务执行失败"</span><br><span class="line">    # 发送短信或者邮件</span><br><span class="line">else</span><br><span class="line">    echo "任务执行成功"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="打包配置-1"><a href="#打包配置-1" class="headerlink" title="打包配置"></a>打包配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>

<h3 id="子项目完整pom-1"><a href="#子项目完整pom-1" class="headerlink" title="子项目完整pom"></a>子项目完整pom</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;update_user_active&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<h3 id="集群执行-1"><a href="#集群执行-1" class="headerlink" title="集群执行"></a>集群执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x startUpdateUserActive.sh 20260201</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262344942.png" alt="image-20230426234450357"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262345661.png" alt="image-20230426234521405"></p>
<h2 id="数据计算之每周一计算最近一个月主播视频评级-1-第五个任务"><a href="#数据计算之每周一计算最近一个月主播视频评级-1-第五个任务" class="headerlink" title="数据计算之每周一计算最近一个月主播视频评级-1(第五个任务)"></a>数据计算之每周一计算最近一个月主播视频评级-1(第五个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">视频数据来源于服务端，当主播开播结束后会产生一条视频数据</span><br><span class="line">数据格式：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262349598.png" alt="image-20230426234917792"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">之前我们通过埋点模拟上报数据，通过flume落盘到hdfs上面，这样在hdfs上面产生的目录会使用当天日期，为了保证我这里使用的目录和大家都保持一致，所以在这我就生成一个固定的日期目录</span><br><span class="line">使用代码GenerateVideoInfoDataV2，在代码中指定日期2026-02-01，这样会把模拟生成的用户活跃数据直接上传到hdfs上面，因为之前的数据采集流程我们已经详细分析过了，所以在这就直接把数据上传到hdfs上面了。</span><br><span class="line"></span><br><span class="line">执行代码：GenerateVideoInfoDataV2，将会把数据上传到hdfs的这个目录下</span><br><span class="line">hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;video_info&#x2F;20260201&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="生成数据-1"><a href="#生成数据-1" class="headerlink" title="生成数据"></a>生成数据</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304262359274.png" alt="image-20230426235956140"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">这个任务需要做的就是统计最近一个月内主播的视频评级信息</span><br><span class="line">在这我们先初始化一天的数据即可，计算一天和计算一个月的数据，计算逻辑是一样的，只有spark任务的输入路径不一样</span><br><span class="line">如果是一个月的数据，假设这一个月有30天，则需要把这30天对应的30个目录使用逗号分隔，拼接成一个字符串，作为Spark任务的输入即可。</span><br><span class="line"></span><br><span class="line">为什么这个任务要每周计算一次，而不是每天计算一次呢？</span><br><span class="line">因为很多主播不会每天都开播，所以我们每天都计算意义不大，均衡考虑之后按照每周计算一次这个频率。</span><br><span class="line"></span><br><span class="line">创建子module项目：update_video_info</span><br><span class="line">创建scala目录，引入scala2.11版本的sdk</span><br><span class="line">在scala目录中创建包：com.imooc.spark</span><br><span class="line">引入依赖</span><br></pre></td></tr></table></figure>

<h3 id="所需依赖-2"><a href="#所需依赖-2" class="headerlink" title="所需依赖"></a>所需依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="UpdateVideoInfoScala-scala"><a href="#UpdateVideoInfoScala-scala" class="headerlink" title="UpdateVideoInfoScala.scala"></a>UpdateVideoInfoScala.scala</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">package com.imooc.spark</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON</span><br><span class="line">import org.apache.spark.&#123;SparkConf, SparkContext&#125;</span><br><span class="line">import org.neo4j.driver.&#123;AuthTokens, GraphDatabase&#125;</span><br><span class="line">import org.slf4j.LoggerFactory</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 任务5：</span><br><span class="line"> * 每周一计算最近一个月主播视频评级</span><br><span class="line"> * 把最近几次视频评级在3B+或2A+的主播，在neo4j中设置flag&#x3D;1</span><br><span class="line"> *</span><br><span class="line"> * 注意：在执行程序之前需要先把flag&#x3D;1的重置为0</span><br><span class="line"> * Created by xuwei</span><br><span class="line"> *&#x2F;</span><br><span class="line">object UpdateVideoInfoScala &#123;</span><br><span class="line">  val logger &#x3D; LoggerFactory.getLogger(&quot;UpdateVideoInfoScala&quot;)</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]): Unit &#x3D; &#123;</span><br><span class="line">    var masterUrl &#x3D; &quot;local&quot;</span><br><span class="line">    var appName &#x3D; &quot;UpdateVideoInfoScala&quot;</span><br><span class="line">    var filePath &#x3D; &quot;hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;video_info&#x2F;20260201&quot;</span><br><span class="line">    var boltUrl &#x3D; &quot;bolt:&#x2F;&#x2F;bigdata04:7687&quot;</span><br><span class="line">    var username &#x3D; &quot;neo4j&quot;</span><br><span class="line">    var password &#x3D; &quot;admin&quot;</span><br><span class="line">    if(args.length &gt; 0)&#123;</span><br><span class="line">      masterUrl &#x3D; args(0)</span><br><span class="line">      appName &#x3D; args(1)</span><br><span class="line">      filePath &#x3D; args(2)</span><br><span class="line">      boltUrl &#x3D; args(3)</span><br><span class="line">      username &#x3D; args(4)</span><br><span class="line">      password &#x3D; args(5)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;在Driver端执行此代码，将flag&#x3D;1的重置为0</span><br><span class="line">    &#x2F;&#x2F;获取neo4j的连接</span><br><span class="line">    val driver &#x3D; GraphDatabase.driver(boltUrl, AuthTokens.basic(username, password))</span><br><span class="line">    &#x2F;&#x2F;开启一个会话</span><br><span class="line">    val session &#x3D; driver.session()</span><br><span class="line">    session.run(&quot;match(a:User) where a.flag &#x3D;1 set a.flag &#x3D; 0&quot;)</span><br><span class="line">    &#x2F;&#x2F;关闭会话</span><br><span class="line">    session.close()</span><br><span class="line">    &#x2F;&#x2F;关闭连接</span><br><span class="line">    driver.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;获取SparkContext</span><br><span class="line">    val conf &#x3D; new SparkConf()</span><br><span class="line">      .setMaster(masterUrl)</span><br><span class="line">      .setAppName(appName)</span><br><span class="line">    val sc &#x3D; new SparkContext(conf)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;读取视频评级数据</span><br><span class="line">    val linesRDD &#x3D; sc.textFile(filePath)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;解析数据中的uid，rating，timestamp</span><br><span class="line">    val tup3RDD &#x3D; linesRDD.map(line &#x3D;&gt; &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        val jsonObj &#x3D; JSON.parseObject(line)</span><br><span class="line">        val uid &#x3D; jsonObj.getString(&quot;uid&quot;)</span><br><span class="line">        val rating &#x3D; jsonObj.getString(&quot;rating&quot;)</span><br><span class="line">        val timestamp: Long &#x3D; jsonObj.getLong(&quot;timestamp&quot;)</span><br><span class="line">        (uid, rating, timestamp)</span><br><span class="line">      &#125; catch &#123;</span><br><span class="line">        case ex: Exception &#x3D;&gt; logger.error(&quot;json数据解析失败：&quot; + line)</span><br><span class="line">          (&quot;0&quot;, &quot;0&quot;, 0L)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;过滤异常数据</span><br><span class="line">    val filterRDD &#x3D; tup3RDD.filter(_._2 !&#x3D; &quot;0&quot;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;获取用户最近3场直播(视频)的评级信息</span><br><span class="line">    val top3RDD &#x3D; filterRDD.groupBy(_._1).map(group &#x3D;&gt; &#123;</span><br><span class="line">      &#x2F;&#x2F;获取最近3次开播的数据，使用制表符拼接成一个字符串</span><br><span class="line">      &#x2F;&#x2F;uid,rating,timestamp \t uid,rating,timestamp \t uid,rating,timestamp </span><br><span class="line">      val top3 &#x3D; group._2.toList.sortBy(_._3).reverse.take(3).mkString(&quot;\t&quot;)</span><br><span class="line">      (group._1, top3)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;过滤出来满足3场B+的数据</span><br><span class="line">    val top3BRDD &#x3D; top3RDD.filter(tup &#x3D;&gt; &#123;</span><br><span class="line">      var flag &#x3D; false</span><br><span class="line">      val fields &#x3D; tup._2.split(&quot;\t&quot;)</span><br><span class="line">      if (fields.length &#x3D;&#x3D; 3) &#123;</span><br><span class="line">        &#x2F;&#x2F;3场B+，表示里面没有出现C和D</span><br><span class="line">        val tmp_str &#x3D; fields(0).split(&quot;,&quot;)(1) + &quot;,&quot; + fields(1).split(&quot;,&quot;)(1) + &quot;,&quot; + fields(2).split(&quot;,&quot;)(1)</span><br><span class="line">        if (!tmp_str.contains(&quot;C&quot;) &amp;&amp; !tmp_str.contains(&quot;D&quot;)) &#123;</span><br><span class="line">          flag &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      flag</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;把满足3场B+的数据更新到neo4j中，增加一个字段flag，flag&#x3D;1表示是视频评级满足条件的主播，允许推荐给用户</span><br><span class="line">    &#x2F;&#x2F;注意：针对3场B+的数据还需要额外再限制一下主播等级，主播等级需要&gt;&#x3D;15，这样可以保证筛选出来的主播尽可能是一些优质主播</span><br><span class="line">    top3BRDD.foreachPartition(it&#x3D;&gt;&#123;</span><br><span class="line">      &#x2F;&#x2F;获取neo4j的连接</span><br><span class="line">      val driver &#x3D; GraphDatabase.driver(boltUrl, AuthTokens.basic(username, password))</span><br><span class="line">      &#x2F;&#x2F;开启一个会话</span><br><span class="line">      val session &#x3D; driver.session()</span><br><span class="line">      it.foreach(tup&#x3D;&gt;&#123;</span><br><span class="line">        session.run(&quot;match (a:User &#123;uid:&#39;&quot;+tup._1+&quot;&#39;&#125;) where a.level &gt;&#x3D;15 set a.flag &#x3D; 1&quot;)</span><br><span class="line">      &#125;)</span><br><span class="line">      &#x2F;&#x2F;关闭会话</span><br><span class="line">      session.close()</span><br><span class="line">      &#x2F;&#x2F;关闭连接</span><br><span class="line">      driver.close()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;过滤出来满足2场A+的数据</span><br><span class="line">    val top2ARDD &#x3D; top3RDD.filter(tup &#x3D;&gt; &#123;</span><br><span class="line">      var flag &#x3D; false</span><br><span class="line">      val fields &#x3D; tup._2.split(&quot;\t&quot;)</span><br><span class="line">      if (fields.length &gt;&#x3D; 2) &#123;</span><br><span class="line">        &#x2F;&#x2F;2场A+，获取最近两场直播评级，里面不能出现B、C、D</span><br><span class="line">        val tmp_str &#x3D; fields(0).split(&quot;,&quot;)(1) + &quot;,&quot; + fields(1).split(&quot;,&quot;)(1)</span><br><span class="line">        if (!tmp_str.contains(&quot;B&quot;) &amp;&amp; !tmp_str.contains(&quot;C&quot;) &amp;&amp; !tmp_str.contains(&quot;D&quot;)) &#123;</span><br><span class="line">          flag &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      flag</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;把满足2场A+的数据更新到neo4j中，设置flag&#x3D;1</span><br><span class="line">    &#x2F;&#x2F;注意：针对2场A+的数据还需要额外限制一下主播等级，主播等级需要&gt;&#x3D;4 这样可以保证筛选出来的主播尽可能是一些优质主播</span><br><span class="line">    top2ARDD.foreachPartition(it&#x3D;&gt;&#123;</span><br><span class="line">      &#x2F;&#x2F;获取neo4j的连接</span><br><span class="line">      val driver &#x3D; GraphDatabase.driver(boltUrl, AuthTokens.basic(username, password))</span><br><span class="line">      &#x2F;&#x2F;开启一个会话</span><br><span class="line">      val session &#x3D; driver.session()</span><br><span class="line">      it.foreach(tup&#x3D;&gt;&#123;</span><br><span class="line">        session.run(&quot;match (a:User &#123;uid:&#39;&quot;+tup._1+&quot;&#39;&#125;) where a.level &gt;&#x3D;4 set a.flag &#x3D; 1&quot;)</span><br><span class="line">      &#125;)</span><br><span class="line">      &#x2F;&#x2F;关闭会话</span><br><span class="line">      session.close()</span><br><span class="line">      &#x2F;&#x2F;关闭连接</span><br><span class="line">      driver.close()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地执行-2"><a href="#本地执行-2" class="headerlink" title="本地执行"></a>本地执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在本地执行代码</span><br><span class="line">然后到neo4j的web界面查看结果，发现只有uid为1005的数据对应的flag不等于1(没有flag属性)</span><br><span class="line">这样是正确的。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304271046115.png" alt="image-20230427104641625"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304271048485.png" alt="image-20230427104824499"></p>
<h3 id="startUpdateVideoInfo-sh"><a href="#startUpdateVideoInfo-sh" class="headerlink" title="startUpdateVideoInfo.sh"></a>startUpdateVideoInfo.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下面开发任务执行脚本</span><br><span class="line">注意：这个脚本中需要实现获取最近一个月的数据目录</span><br><span class="line">startUpdateVideoInfo.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取最近一个月的文件目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash">filepath=<span class="string">""</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">for</span>((i=1;i&lt;=30;i++))</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">do</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    filepath+=<span class="string">"hdfs://bigdata01:9000/data/video_info/"</span>`date -d <span class="string">"<span class="variable">$i</span> days ago"</span> +<span class="string">"%Y%m%d"</span>`, // 这里的，号很经典</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">done</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">默认获取昨天时间</span></span><br><span class="line">dt=`date -d "1 days ago" +"%Y%m%d"`</span><br><span class="line">if [ "x$1" != "x" ]</span><br><span class="line">then</span><br><span class="line">dt=$1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">HDFS输入数据路径</span></span><br><span class="line">filePath="hdfs://bigdata01:9000/data/video_info/$&#123;dt&#125;"</span><br><span class="line"></span><br><span class="line">masterUrl="yarn-cluster"</span><br><span class="line">master=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $1&#125;'`</span><br><span class="line">deployMode=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $2&#125;'`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">appName="UpdateVideoInfoScala"`date +%s`</span><br><span class="line">boltUrl="bolt://bigdata04:7687"</span><br><span class="line">username="neo4j"</span><br><span class="line">password="admin"</span><br><span class="line"></span><br><span class="line">yarnCommonLib="hdfs://bigdata01:9000/yarnCommonLib"</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.UpdateVideoInfoScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;/fastjson-1.2.68.jar,$&#123;yarnCommonLib&#125;/neo4j-java-driver-4.1.1.jar,$&#123;yarnCommonLib&#125;/reactive-streams-1.0.3.jar \</span><br><span class="line">/data/soft/video_recommend/jobs/update_video_info-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;filePath&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">验证任务执行状态</span></span><br><span class="line">appStatus=`yarn application -appStates FINISHED -list | grep $&#123;appName&#125; | awk '&#123;print $7&#125;'`</span><br><span class="line">if [ "$&#123;appStatus&#125;" != "SUCCEEDED" ]</span><br><span class="line">then</span><br><span class="line">    echo "任务执行失败"</span><br><span class="line">    # 发送短信或者邮件</span><br><span class="line">else</span><br><span class="line">    echo "任务执行成功"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="子项目完整依赖"><a href="#子项目完整依赖" class="headerlink" title="子项目完整依赖"></a>子项目完整依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;update_user_active&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<h3 id="集群执行-2"><a href="#集群执行-2" class="headerlink" title="集群执行"></a>集群执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x startUpdateVideoInfo.sh 20260201</span><br></pre></td></tr></table></figure>

<h2 id="数据计算之每周一计算三度关系推荐列数据-第六个任务"><a href="#数据计算之每周一计算三度关系推荐列数据-第六个任务" class="headerlink" title="数据计算之每周一计算三度关系推荐列数据(第六个任务)"></a>数据计算之每周一计算三度关系推荐列数据(第六个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">前面我们在neo4j中维护了粉丝和主播的一些信息，在这里我们就需要基于neo4j中的数据统计主播的三度关系推荐列表了</span><br><span class="line"></span><br><span class="line">这个任务在这也是每周计算一次，我们测试过，每天都计算的话，最终的结果变化是不大的，所以就没必要每天计算了。</span><br><span class="line"></span><br><span class="line">创建子module项目：get_recommend_list</span><br><span class="line">创建scala目录，引入scala2.11版本的sdk</span><br><span class="line">在scala目录中创建包：com.imooc.spark</span><br><span class="line">引入依赖，这里面需要额外用到spark-sql和neo4j-spark-connector这两个依赖</span><br></pre></td></tr></table></figure>

<h3 id="生成数据-2"><a href="#生成数据-2" class="headerlink" title="生成数据"></a>生成数据</h3><h3 id="所需依赖-3"><a href="#所需依赖-3" class="headerlink" title="所需依赖"></a>所需依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-sql_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;neo4j-contrib&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-spark-connector&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：在使用spark读取neo4j中数据的时候，可以使用一个插件，在官网中可以找到</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281349757.png" alt="image-20230428134919089"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281349353.png" alt="image-20230428134931154"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281350275.png" alt="image-20230428135056752"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个版本是基于neo4j 4.0，我们现在使用的neo4j是3.5的，这种一般是向下兼容的，所以操作neo4j 3.5也是可以的，后面写的spark是2.4.5，这个也是可以的，我们使用的spark是2.4.3的，最后一位版本号不一致没问题。</span><br><span class="line">目前最新版本是基于scala2.12版本编译的，我们在spark项目中使用的scala版本是2.11，所以使用2.4.5-M1这个版本。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：在使用这个依赖的时候，还需要配置它对应的repository，因为这个依赖没有在maven仓库中，把这些配置添加到父项目的pom.xml文件中</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281352725.png" alt="image-20230428135228605"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281352639.png" alt="image-20230428135241954"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">咱们前面使用的neo4j-java-driver相当于是使用原生代码操作neo4j，而现在使用neo4j-spark-connector相当于把neo4j封装到spark中了，使用起来比较方便。</span><br><span class="line"></span><br><span class="line">在使用neo4j-spark-connector的时候，选择哪个版本呢？</span><br><span class="line">点这里进去看一下</span><br></pre></td></tr></table></figure>

<h3 id="GetRecommendListScala-scala"><a href="#GetRecommendListScala-scala" class="headerlink" title="GetRecommendListScala.scala"></a>GetRecommendListScala.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.spark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.storage.<span class="type">StorageLevel</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.driver.&#123;<span class="type">AuthTokens</span>, <span class="type">GraphDatabase</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.spark.<span class="type">Neo4j</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ArrayBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务6：</span></span><br><span class="line"><span class="comment"> * 每周一计算最近一周内主活主播的三度关系列表</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * 1：待推荐主播最近一周内活跃过</span></span><br><span class="line"><span class="comment"> * 2：待推荐主播等级&gt;4</span></span><br><span class="line"><span class="comment"> * 3：待推荐主播最近1个月视频评级满足3B+或2A+(flag=1)</span></span><br><span class="line"><span class="comment"> * 4：待推荐主播的粉丝列表关注重合度&gt;2</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">GetRecommendListScala</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> masterUrl = <span class="string">"local"</span></span><br><span class="line">    <span class="keyword">var</span> appName = <span class="string">"GetRecommendListScala"</span></span><br><span class="line">    <span class="keyword">var</span> boltUrl = <span class="string">"bolt://bigdata04:7687"</span></span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">"neo4j"</span></span><br><span class="line">    <span class="keyword">var</span> password = <span class="string">"admin"</span></span><br><span class="line">    <span class="keyword">var</span> timestamp = <span class="number">0</span>L <span class="comment">//过滤最近一周内是否活跃过</span></span><br><span class="line">    <span class="keyword">var</span> duplicateNum = <span class="number">2</span> <span class="comment">//粉丝列表关注重合度</span></span><br><span class="line">    <span class="keyword">var</span> level = <span class="number">4</span> <span class="comment">//主播等级</span></span><br><span class="line">    <span class="keyword">var</span> outputPath = <span class="string">"hdfs://bigdata01:9000/data/recommend_data/20260201"</span></span><br><span class="line">    <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      masterUrl = args(<span class="number">0</span>)</span><br><span class="line">      appName = args(<span class="number">1</span>)</span><br><span class="line">      boltUrl = args(<span class="number">2</span>)</span><br><span class="line">      username = args(<span class="number">3</span>)</span><br><span class="line">      password = args(<span class="number">4</span>)</span><br><span class="line">      timestamp = args(<span class="number">5</span>).toLong</span><br><span class="line">      duplicateNum = args(<span class="number">6</span>).toInt</span><br><span class="line">      level = args(<span class="number">7</span>).toInt</span><br><span class="line">      outputPath = args(<span class="number">8</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">      .setAppName(appName)</span><br><span class="line">      .setMaster(masterUrl)</span><br><span class="line">      .set(<span class="string">"spark.driver.allowMultipleContexts"</span>,<span class="string">"true"</span>)<span class="comment">//允许创建多个context</span></span><br><span class="line">      .set(<span class="string">"spark.neo4j.url"</span>,boltUrl)<span class="comment">//bolt的地址</span></span><br><span class="line">      .set(<span class="string">"spark.neo4j.user"</span>,username)<span class="comment">//neo4j用户名</span></span><br><span class="line">      .set(<span class="string">"spark.neo4j.password"</span>,password)<span class="comment">//neo4j密码</span></span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取一周内主活的主播 并且主播等级大于4的数据</span></span><br><span class="line">    <span class="keyword">var</span> params = <span class="type">Map</span>[<span class="type">String</span>,<span class="type">Long</span>]()</span><br><span class="line">    params += (<span class="string">"timestamp"</span>-&gt;timestamp)</span><br><span class="line">    params += (<span class="string">"level"</span>-&gt;level)</span><br><span class="line">    <span class="keyword">val</span> neo4j: <span class="type">Neo4j</span> = <span class="type">Neo4j</span>(sc).cypher(<span class="string">"match (a:User) where a.timestamp &gt;= &#123;timestamp&#125; and a.level &gt;= &#123;level&#125; return a.uid"</span>).params(params)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将从neo4j中查询出来的数据转换为rowRDD</span></span><br><span class="line">    <span class="comment">//val rowRDD = neo4j.loadRowRdd</span></span><br><span class="line">    <span class="comment">//repartition 这里的repartition是为了把数据分为7份，这样下面的mapPartitions在执行的时候就有7个线程</span></span><br><span class="line">    <span class="comment">//这7个线程并行查询neo4j数据库</span></span><br><span class="line">    <span class="keyword">val</span> rowRDD = neo4j.loadRowRdd.repartition(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一次处理一批</span></span><br><span class="line">    <span class="comment">//过滤出粉丝关注重合度&gt;2的数据，并且对关注重合度倒序排列</span></span><br><span class="line">    <span class="comment">//最终的数据格式是：主播id,待推荐的主播id</span></span><br><span class="line">    <span class="keyword">val</span> mapRDD = rowRDD.mapPartitions(it =&gt; &#123;</span><br><span class="line">      <span class="comment">//获取neo4j的连接</span></span><br><span class="line">      <span class="keyword">val</span> driver = <span class="type">GraphDatabase</span>.driver(boltUrl, <span class="type">AuthTokens</span>.basic(username, password))</span><br><span class="line">      <span class="comment">//开启一个会话</span></span><br><span class="line">      <span class="keyword">val</span> session = driver.session()</span><br><span class="line">      <span class="comment">//保存计算出来的结果</span></span><br><span class="line">      <span class="keyword">val</span> resultArr = <span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</span><br><span class="line">      it.foreach(row =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> uid = row.getString(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">//计算一个用户的三度关系(主播的二度关系)</span></span><br><span class="line">        <span class="comment">//注意：数据量大了之后，这个计算操作是非常耗时</span></span><br><span class="line">        <span class="comment">//val result = session.run("match (a:User &#123;uid:'" + uid + "'&#125;) &lt;-[:follow]- (b:User) -[:follow]-&gt; (c:User) return a.uid as auid,c.uid as cuid,count(c.uid) as sum order by sum desc limit 30")</span></span><br><span class="line">        <span class="comment">//对b、c的主活时间进行过滤，以及对c的level和flag值进行过滤</span></span><br><span class="line">        <span class="keyword">val</span> result = session.run(<span class="string">"match (a:User &#123;uid:'"</span> + uid + <span class="string">"'&#125;) &lt;-[:follow]- (b:User) -[:follow]-&gt; (c:User) "</span> +</span><br><span class="line">          <span class="string">"where b.timestamp &gt;= "</span> + timestamp + <span class="string">" and c.timestamp &gt;= "</span> + timestamp + <span class="string">" and c.level &gt;= "</span> + level + <span class="string">" and c.flag = 1 "</span> +</span><br><span class="line">          <span class="string">"return a.uid as auid,c.uid as cuid,count(c.uid) as sum order by sum desc limit 30"</span>)</span><br><span class="line">        <span class="keyword">while</span> (result.hasNext) &#123;</span><br><span class="line">          <span class="keyword">val</span> record = result.next()</span><br><span class="line">          <span class="keyword">val</span> sum = record.get(<span class="string">"sum"</span>).asInt()</span><br><span class="line">          <span class="keyword">if</span> (sum &gt; duplicateNum) &#123;</span><br><span class="line">            resultArr += record.get(<span class="string">"auid"</span>).asString() + <span class="string">"\t"</span> + record.get(<span class="string">"cuid"</span>).asString()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">//关闭会话</span></span><br><span class="line">      session.close()</span><br><span class="line">      <span class="comment">//关闭连接</span></span><br><span class="line">      driver.close()</span><br><span class="line">      resultArr.iterator</span><br><span class="line">    &#125;).persist(<span class="type">StorageLevel</span>.<span class="type">MEMORY_AND_DISK</span>) <span class="comment">//把RDD数据缓存起来</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//把数据转成tuple2的形式</span></span><br><span class="line">    <span class="keyword">val</span> tup2RDD = mapRDD.map(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> splits = line.split(<span class="string">"\t"</span>)</span><br><span class="line">      (splits(<span class="number">0</span>), splits(<span class="number">1</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//根据主播id进行分组，可以获取到这个主播的待推荐列表</span></span><br><span class="line">    <span class="keyword">val</span> reduceRDD = tup2RDD.reduceByKey((v1, v2) =&gt; &#123;</span><br><span class="line">      v1 + <span class="string">","</span> + v2</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最终把结果组装成这种形式</span></span><br><span class="line">    <span class="comment">//1001 1002,1003,1004</span></span><br><span class="line">    reduceRDD.map(tup=&gt;&#123;</span><br><span class="line">      tup._1+<span class="string">"\t"</span>+tup._2</span><br><span class="line">    &#125;).repartition(<span class="number">1</span>).saveAsTextFile(outputPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地执行-3"><a href="#本地执行-3" class="headerlink" title="本地执行"></a>本地执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">先使用这一行代码，在计算三度关系数据的时候暂时先不进行条件过滤。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281537558.png" alt="image-20230428153711075"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281537439.png" alt="image-20230428153735751"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">接着使用这一行代码，在计算三度关系数据的对数据进行条件过滤</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281539054.png" alt="image-20230428153929765"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281540381.png" alt="image-20230428154023306"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">到neo4j中验证一下，确实是正确的，因为1005的flag不为1，被过滤掉了，所以我在关注1000这个主播的时候平台只需要给我推荐主1004这个主播即可。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：这个代码在执行mapPartitions的时候，最好把rowRDD的分区重新设置一下，如果让程序自动分配的话可能不太合理，分多了分少了都不太好</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">由于我们在mapPartitions中需要操作neo4j，所以这个时候rowRDD分区的数量就可以等于（neo4j服务器的CPU数量-1），要给neo4j预留出来一个cpu来处理其它任务请求。</span><br><span class="line">我们当时的服务器是8个CPU，给neo4j预留出来一个，剩下还有7个，所以说，neo4j此时可以对外提供的最大并发处理能力是7，那我们就把rowRDD设置为7个分区，就会有7个线程并行处理数据，它们可以并行操作neo4j，这样效率最高。</span><br><span class="line">如果给rowRDD设置的分区太多，对应的就会有多个线程并行操作neo4j，会给neo4j造成很大的压力，相当于neo4j在满负荷的运行，这个时候我们另外一个实时维护neo4j中粉丝关注数据的程序执行起来就很慢了，以及其他人如果这个时候想查询neo4j，也会非常慢，所以这样就不太好了。</span><br><span class="line">如果给rowRDD设置的分区太少，对应产生的执行线程就比较少，此时neo4j会比较空闲，没有多大压力，但是我们这个三度关系的任务执行就非常慢了。</span><br><span class="line">综上所述，建议把rowRDD的分区数量设置为7，这样可以充分利用neo4j服务器的性能，也不至于把neo4j服务器拖垮。</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281547995.png" alt="image-20230428154738077" style="zoom:67%;">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还有一点可以优化的，增加RDD持久化，把RDD数据缓存起来，这样可以避免个别task失败导致的数据重算，因为这个计算还是比较消耗时间的，所以说尽可能保证计算出来的数据不丢失。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281553783.png" alt="image-20230428155333860"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">问题：大家有没有想过，我们是否可以直接在Neo4j(sc).cypher(…)中指定一条查询语句，直接把所有的三度关系全部查询出来？</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这样理论上是可以的，但是在实际中，当neo4j中存储的节点数和关系数量达到千万级别之后，同时查询所有满足条件主播的三度关系推荐列表的时候会很慢，有时候会导致等了几十分钟也查询不出来数据，所以在这我们就把这个功能进行了拆解，先查看满足条件的主播uid列表，然后再一个一个计算这些主播的三度关系推荐列表，这样可以提高计算效率，并且不会出现查询不出来结果的情况。</span><br></pre></td></tr></table></figure>

<h3 id="startGetRecommendList-sh"><a href="#startGetRecommendList-sh" class="headerlink" title="startGetRecommendList.sh"></a>startGetRecommendList.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">默认获取上周一的时间</span></span><br><span class="line">dt=`date -d "7 days ago" +"%Y%m%d"`</span><br><span class="line">if [ "x$1" != "x" ]</span><br><span class="line">then</span><br><span class="line">    dt=`date -d "7 days ago $1" +"%Y%m%d"`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">masterUrl="yarn-cluster"</span><br><span class="line">master=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $1&#125;'`</span><br><span class="line">deployMode=`echo $&#123;masterUrl&#125; | awk -F'-' '&#123;print $2&#125;'`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">appName="GetRecommendListScala"`date +%s`</span><br><span class="line">boltUrl="bolt://bigdata04:7687"</span><br><span class="line">username="neo4j"</span><br><span class="line">password="admin"</span><br><span class="line"><span class="meta">#</span><span class="bash">获取上周一的时间戳(单位：毫秒)</span></span><br><span class="line">timestamp=`date --date="$&#123;dt&#125;" +%s`000</span><br><span class="line"><span class="meta">#</span><span class="bash">粉丝列表关注重合度</span></span><br><span class="line">duplicateNum=2</span><br><span class="line"><span class="meta">#</span><span class="bash">主播等级</span></span><br><span class="line">level=4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">输出结果数据路径</span></span><br><span class="line">outputPath="hdfs://bigdata01:9000/data/recommend_data/$&#123;dt&#125;"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yarnCommonLib="hdfs://bigdata01:9000/yarnCommonLib"</span><br><span class="line"></span><br><span class="line">spark-submit --master $&#123;master&#125; \</span><br><span class="line">--name $&#123;appName&#125; \</span><br><span class="line">--deploy-mode $&#123;deployMode&#125; \</span><br><span class="line">--queue default \</span><br><span class="line">--driver-memory 1g \</span><br><span class="line">--executor-memory 1g \</span><br><span class="line">--executor-cores 1 \</span><br><span class="line">--num-executors 2 \</span><br><span class="line">--class com.imooc.spark.GetRecommendListScala \</span><br><span class="line">--jars $&#123;yarnCommonLib&#125;/neo4j-java-driver-4.1.1.jar,$&#123;yarnCommonLib&#125;/reactive-streams-1.0.3.jar,$&#123;yarnCommonLib&#125;/neo4j-spark-connector-2.4.5-M1.jar \</span><br><span class="line">/data/soft/video_recommend/jobs/get_recommend_list-1.0-SNAPSHOT.jar $&#123;masterUrl&#125; $&#123;appName&#125; $&#123;boltUrl&#125; $&#123;username&#125; $&#123;password&#125; $&#123;timestamp&#125; $&#123;duplicateNum&#125; $&#123;level&#125; $&#123;outputPath&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">验证任务执行状态</span></span><br><span class="line">appStatus=`yarn application -appStates FINISHED -list | grep $&#123;appName&#125; | awk '&#123;print $7&#125;'`</span><br><span class="line">if [ "$&#123;appStatus&#125;" != "SUCCEEDED" ]</span><br><span class="line">then</span><br><span class="line">    echo "任务执行失败"</span><br><span class="line">    # 发送短信或者邮件</span><br><span class="line">else</span><br><span class="line">    echo "任务执行成功"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="子项目完整依赖-1"><a href="#子项目完整依赖-1" class="headerlink" title="子项目完整依赖"></a>子项目完整依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;db_video_recommend&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;org.example&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;get_recommend_list&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.neo4j.driver&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-java-driver&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-sql_2.11&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;neo4j-contrib&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;neo4j-spark-connector&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;!-- java编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.6.0&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;&#x2F;encoding&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;!-- scala编译插件 --&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;net.alchim31.maven&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;scala-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.6&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;scalaCompatVersion&gt;2.11&lt;&#x2F;scalaCompatVersion&gt;</span><br><span class="line">                    &lt;scalaVersion&gt;2.11.12&lt;&#x2F;scalaVersion&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;test-compile-scala&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;test-compile&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;add-source&lt;&#x2F;goal&gt;</span><br><span class="line">                            &lt;goal&gt;testCompile&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<h3 id="集群执行-3"><a href="#集群执行-3" class="headerlink" title="集群执行"></a>集群执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x startGetRecommendList.sh 20260201</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281605986.png" alt="image-20230428160537691"></p>
<h2 id="数据计算之三度关系数据导出到Mysql-第七个任务"><a href="#数据计算之三度关系数据导出到Mysql-第七个任务" class="headerlink" title="数据计算之三度关系数据导出到Mysql(第七个任务)"></a>数据计算之三度关系数据导出到Mysql(第七个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">接下来我们需要使用Sqoop将HDFS中计算好的三度关系推荐列表数据导出到MySQL中</span><br><span class="line">需要在mysql中创建一个表recommend_list</span><br><span class="line">这个表有两列：</span><br><span class="line">第一列为主播uid</span><br><span class="line">第二列为待推荐主播uid</span><br><span class="line"></span><br><span class="line">当用户关注某个主播的时候，会根据这个主播的uid到这个表里面进行查询，把待推荐主播uid获取到，在页面中进行展现，推荐给用户，这样就都可以实现三度关系推荐的效果了。</span><br><span class="line"></span><br><span class="line">建表语句如下：</span><br><span class="line">recommend_list.sql</span><br></pre></td></tr></table></figure>

<h3 id="recommend-list-sql"><a href="#recommend-list-sql" class="headerlink" title="recommend_list.sql"></a>recommend_list.sql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> recommend_list;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> recommend_list(</span><br><span class="line">	uid <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	recommend_uids <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	primary <span class="keyword">key</span> (uid)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="export-recommend-list-sh"><a href="#export-recommend-list-sh" class="headerlink" title="export_recommend_list.sh"></a>export_recommend_list.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">接下来使用sqoop将hdfs中的输出导出到mysql中</span><br><span class="line">在导出的时候实现插入和更新功能，如果uid对应的数据已存在，则更新，如果不存在则插入</span><br><span class="line">开发一个脚本</span><br><span class="line">export_recommend_list.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#默认获取上周一的时间</span><br><span class="line">dt&#x3D;&#96;date -d &quot;7 days ago&quot; +&quot;%Y%m%d&quot;&#96;</span><br><span class="line">if [ &quot;x$1&quot; !&#x3D; &quot;x&quot; ]</span><br><span class="line">then</span><br><span class="line">    dt&#x3D;&#96;date -d &quot;7 days ago $1&quot; +&quot;%Y%m%d&quot;&#96;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sqoop export \</span><br><span class="line">--connect jdbc:mysql:&#x2F;&#x2F;192.168.182.1:3306&#x2F;video?serverTimezone&#x3D;UTC \</span><br><span class="line">--username root \</span><br><span class="line">--password admin \</span><br><span class="line">--table recommend_list \</span><br><span class="line">--export-dir hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;recommend_data&#x2F;$&#123;dt&#125; \</span><br><span class="line">--input-fields-terminated-by &#39;\t&#39; \</span><br><span class="line">--update-key uid \</span><br><span class="line">--update-mode allowinsert</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -x exexport_recommend_list.sh 20260201</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304281750435.png" alt="image-20230428175018471"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其实在实际工作中我们需要做的到这就可以了，然后把这个数据库的名称、表名、表中的字段含义写一个文档同步给服务端即可，具体的数据交互是由服务端和客户端进行对接的。</span><br></pre></td></tr></table></figure>

<h2 id="数据展现"><a href="#数据展现" class="headerlink" title="数据展现"></a>数据展现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在后面的v2.0架构中，我们会开发一个接口，对外提供数据，因为直接把数据库暴露给其它用户不太安全，倒不是怕他们删库跑路，是担心他们误操作把某些数据删掉了。</span><br><span class="line">等到我们在v2.0中开发了数据接口之后，我们再通过本地启动项目进行效果演示。</span><br></pre></td></tr></table></figure>

<h2 id="项目代码双语支持"><a href="#项目代码双语支持" class="headerlink" title="项目代码双语支持"></a>项目代码双语支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">咱们前面在开发具体的数据计算代码的时候，使用的都是scala代码，为了兼顾Java开发人员，针对数据处理中的功能代码在这我也提供了Java代码支持</span><br><span class="line">在这里这些java代码我就不再手敲了，到时候直接把对应的java代码一起提交到git上面，大家如果有需要了可以去一下。</span><br><span class="line">其实我是不建议在工作中使用java去开发spark和flink的，在这只是为了给大家多一个选择而已，根据行业经验而言，scala语言是开发spark和flink最好的选择。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line">在v1.0中，我们侧重于学习整个项目的业务、架构逻辑和实战代码开发。</span><br><span class="line">针对项目调忧、项目数据规模、集群规模、Neo4j性能指标等内容，在后面的V2.0中给大家安排上。</span><br></pre></td></tr></table></figure>





<hr>
<blockquote>
</blockquote>

      
    </div>
    
    
    
	
	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html">大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 TTYONG 的个人博客">TTYONG</a></p>
  <p><span>发布时间:</span>2023年04月24日 - 15:04</p>
  <p><span>最后更新:</span>2023年05月26日 - 18:05</p>
  <p><span>原始链接:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html" title="大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-3">http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
    });
    });  
</script>



      
	</div>



    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>多少都是爱</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_reward.jpg" alt="TTYONG 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay_reward.jpg" alt="TTYONG 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0/" rel="tag"><i class="fa fa-tag"></i> 直播平台三度关系推荐v1.0</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html" rel="next" title="大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2">
                <i class="fa fa-chevron-left"></i> 大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v2-0-1.html" rel="prev" title="大数据开发工程师-第十八周 直播平台三度关系推荐v2.0-1">
                大数据开发工程师-第十八周 直播平台三度关系推荐v2.0-1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
      
        
          <ul class="sidebar-nav motion-element">
            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
              文章目录
            </li>
            <li class="sidebar-nav-overview" data-target="site-overview">
              站点概览
            </li>
          </ul>
        
      

	<section class="site-overview sidebar-panel">
	  <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
		<img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="TTYONG">
		<p class="site-author-name" itemprop="name">TTYONG</p>
		 
			<p class="site-description motion-element" itemprop="description"></p>
		 
	  </div>
	  <nav class="site-state motion-element">

		
		  <div class="site-state-item site-state-posts">
			<a href="/archives/%7C%7C%20archive">
			  <span class="site-state-item-count">375</span>
			  <span class="site-state-item-name">日志</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-categories">
			<a href="/categories/index.html">
			  <span class="site-state-item-count">51</span>
			  <span class="site-state-item-name">分类</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-tags">
			<a href="/tags/index.html">
			  <span class="site-state-item-count">107</span>
			  <span class="site-state-item-name">标签</span>
			</a>
		  </div>
		

	  </nav>

	  
		<div class="feed-link motion-element">
		  <a href="/atom.xml" rel="alternate">
			<i class="fa fa-rss"></i>
			RSS
		  </a>
		</div>
	  

	  <div class="links-of-author motion-element">
		
		  
			<span class="links-of-author-item">
			  <a href="2364076207@qq.com || envelope" target="_blank" title="E-Mail">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				E-Mail
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://wpa.qq.com/msgrd?v=3&uin=2364076207&site=qq&menu=yes || qq" target="_blank" title="QQ" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				QQ
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://weibo.com/p/1005051833844383/home || weixin" target="_blank" title="WeiXin" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				WeiXin
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://www.zhihu.com/people/he-he-ty || zhihu" target="_blank" title="ZhiHu" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				ZhiHu
			  </a>
			</span>
		  
		
	  </div>

	  
	  

	  
	  
		<div class="links-of-blogroll motion-element links-of-blogroll-block">
		  <div class="links-of-blogroll-title">
			<i class="fa  fa-fw fa-link"></i>
			友链
		  </div>
		  <ul class="links-of-blogroll-list">
			
			  <li class="links-of-blogroll-item">
				<a href="https://www.baidu.com/" target="_blank" rel="external nofollow noopener noreferrer">百度</a>
			  </li>
			
		  </ul>
		</div>
	  

	  


	</section>
	
	  
	  <!--noindex-->
		<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
		  <div class="post-toc">

			
			  
			

			
			  <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第十八周-直播平台三度关系推荐v1-0-3"><span class="nav-number">1.</span> <span class="nav-text">第十八周 直播平台三度关系推荐v1.0-3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之实时维护粉丝关注-第二个任务"><span class="nav-number">1.1.</span> <span class="nav-text">数据计算之实时维护粉丝关注(第二个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#父项目pom"><span class="nav-number">1.1.1.</span> <span class="nav-text">父项目pom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子项目pom"><span class="nav-number">1.1.2.</span> <span class="nav-text">子项目pom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RealTimeFollowScala-scala"><span class="nav-number">1.1.3.</span> <span class="nav-text">RealTimeFollowScala.scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startRealTimeFollow-sh"><span class="nav-number">1.1.4.</span> <span class="nav-text">startRealTimeFollow.sh</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之每天定时更新主播等级-第三个任务"><span class="nav-number">1.2.</span> <span class="nav-text">数据计算之每天定时更新主播等级(第三个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#所需依赖"><span class="nav-number">1.2.1.</span> <span class="nav-text">所需依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UpdateUserLevelScala-scala"><span class="nav-number">1.2.2.</span> <span class="nav-text">UpdateUserLevelScala.scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地执行"><span class="nav-number">1.2.3.</span> <span class="nav-text">本地执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startUpdateUserLevel-sh"><span class="nav-number">1.2.4.</span> <span class="nav-text">startUpdateUserLevel.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打包配置"><span class="nav-number">1.2.5.</span> <span class="nav-text">打包配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子项目完整pom"><span class="nav-number">1.2.6.</span> <span class="nav-text">子项目完整pom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群执行"><span class="nav-number">1.2.7.</span> <span class="nav-text">集群执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之每天定时更新用户活跃时间-第四个任务"><span class="nav-number">1.3.</span> <span class="nav-text">数据计算之每天定时更新用户活跃时间(第四个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成数据"><span class="nav-number">1.3.1.</span> <span class="nav-text">生成数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所需依赖-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">所需依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UpdateUserActiveScala-scala"><span class="nav-number">1.3.3.</span> <span class="nav-text">UpdateUserActiveScala.scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地执行-1"><span class="nav-number">1.3.4.</span> <span class="nav-text">本地执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startUpdateUserActive-sh"><span class="nav-number">1.3.5.</span> <span class="nav-text">startUpdateUserActive.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打包配置-1"><span class="nav-number">1.3.6.</span> <span class="nav-text">打包配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子项目完整pom-1"><span class="nav-number">1.3.7.</span> <span class="nav-text">子项目完整pom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群执行-1"><span class="nav-number">1.3.8.</span> <span class="nav-text">集群执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之每周一计算最近一个月主播视频评级-1-第五个任务"><span class="nav-number">1.4.</span> <span class="nav-text">数据计算之每周一计算最近一个月主播视频评级-1(第五个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成数据-1"><span class="nav-number">1.4.1.</span> <span class="nav-text">生成数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所需依赖-2"><span class="nav-number">1.4.2.</span> <span class="nav-text">所需依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UpdateVideoInfoScala-scala"><span class="nav-number">1.4.3.</span> <span class="nav-text">UpdateVideoInfoScala.scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地执行-2"><span class="nav-number">1.4.4.</span> <span class="nav-text">本地执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startUpdateVideoInfo-sh"><span class="nav-number">1.4.5.</span> <span class="nav-text">startUpdateVideoInfo.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子项目完整依赖"><span class="nav-number">1.4.6.</span> <span class="nav-text">子项目完整依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群执行-2"><span class="nav-number">1.4.7.</span> <span class="nav-text">集群执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之每周一计算三度关系推荐列数据-第六个任务"><span class="nav-number">1.5.</span> <span class="nav-text">数据计算之每周一计算三度关系推荐列数据(第六个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成数据-2"><span class="nav-number">1.5.1.</span> <span class="nav-text">生成数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所需依赖-3"><span class="nav-number">1.5.2.</span> <span class="nav-text">所需依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetRecommendListScala-scala"><span class="nav-number">1.5.3.</span> <span class="nav-text">GetRecommendListScala.scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地执行-3"><span class="nav-number">1.5.4.</span> <span class="nav-text">本地执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startGetRecommendList-sh"><span class="nav-number">1.5.5.</span> <span class="nav-text">startGetRecommendList.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子项目完整依赖-1"><span class="nav-number">1.5.6.</span> <span class="nav-text">子项目完整依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群执行-3"><span class="nav-number">1.5.7.</span> <span class="nav-text">集群执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之三度关系数据导出到Mysql-第七个任务"><span class="nav-number">1.6.</span> <span class="nav-text">数据计算之三度关系数据导出到Mysql(第七个任务)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#recommend-list-sql"><span class="nav-number">1.6.1.</span> <span class="nav-text">recommend_list.sql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#export-recommend-list-sh"><span class="nav-number">1.6.2.</span> <span class="nav-text">export_recommend_list.sh</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据展现"><span class="nav-number">1.7.</span> <span class="nav-text">数据展现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#项目代码双语支持"><span class="nav-number">1.8.</span> <span class="nav-text">项目代码双语支持</span></a></li></ol></li></ol></div>
			

		  </div>
		</section>
	  <!--/noindex-->
	  
	

	

  </div>
</aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2020.3.4 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TTYONG</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">794.4k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow>Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next rel="external nofollow">NexT.Pisces</a> v5.1.4</div>



-->  


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <div id="gitalk-container"></div>
  <script src="/js/src/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'd3f3299eb0cc69c8f171',
      clientSecret: '23bf8796e5dda2daf0a1b12964d89f4cc88f9ddf',
      repo: 'comments_repository',
      owner: 'ttyong',
      admin: ['ttyong'],
      id: md5(location.pathname),
      distractionFreeMode: 'false'
    })
    gitalk.render('gitalk-container')
  </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  
  

  

  

  

  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>
  
  
  
  

  <canvas id="evanyou"></canvas>
  <style>
    #evanyou {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
  <script src="/js/src/evan-you.js"></script>




  <script src="/js/src/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>




  <script async src="/js/cursor/fireworks.js"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
