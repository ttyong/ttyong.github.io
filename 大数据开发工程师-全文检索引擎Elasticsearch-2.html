<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<script src="https://cdn.jsdelivr.net/gh/wallleap/cdn/js/piao.js"></script>
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="s8Pe1TBqyy">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/animal_bear_panda_32px_4023_easyicon.net.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/animal_bear_panda_16px_4023_easyicon.net.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Elasticsearch,">





  <link rel="alternate" href="/atom.xml" title="TianYong's Blog" type="application/atom+xml">






<meta name="description" content="全文检索引擎Elasticsearch-23 Elasticsearch分词详解ES分词介绍12345678ES中在添加数据，也就是创建索引的时候，会先对数据进行分词。在查询索引数据的时候，也会先根据查询的关键字进行分词。所以在ES中分词这个过程是非常重要的，涉及到查询的效率和准确度。假设有一条数据，数据中有一个字段是titile，这个字段的值为LexCorp BFG-9000。我们想要">
<meta property="og:type" content="article">
<meta property="og:title" content="大数据开发工程师-全文检索引擎Elasticsearch-2">
<meta property="og:url" content="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html">
<meta property="og:site_name" content="TianYong&#39;s Blog">
<meta property="og:description" content="全文检索引擎Elasticsearch-23 Elasticsearch分词详解ES分词介绍12345678ES中在添加数据，也就是创建索引的时候，会先对数据进行分词。在查询索引数据的时候，也会先根据查询的关键字进行分词。所以在ES中分词这个过程是非常重要的，涉及到查询的效率和准确度。假设有一条数据，数据中有一个字段是titile，这个字段的值为LexCorp BFG-9000。我们想要">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111457924.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111501138.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111501077.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111510363.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111515484.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111515497.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111535279.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111553223.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111559457.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111606352.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111613627.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111614039.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306132345436.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306132358298.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140001201.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140003432.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140026183.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140044744.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140043276.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111650965.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111657341.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111659147.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112219264.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112222083.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112228956.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112239645.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242368.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242380.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242573.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112251246.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112253294.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112320577.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112348016.png">
<meta property="article:published_time" content="2023-06-02T10:03:09.000Z">
<meta property="article:modified_time" content="2023-06-19T10:51:55.179Z">
<meta property="article:author" content="TTYONG">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111457924.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://tianyong.fun/大数据开发工程师-全文检索引擎Elasticsearch-2.html">





  <title>大数据开发工程师-全文检索引擎Elasticsearch-2 | TianYong's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">TianYong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">比你优秀的人都努力，有什么理由不努力！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="TTYONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TianYong's Blog">
    </span>

    
      <header class="post-header">
	  
	  



        
        
          <h2 class="post-title" itemprop="name headline">大数据开发工程师-全文检索引擎Elasticsearch-2</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-06-02T18:03:09+08:00">
                2023-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/" itemprop="url" rel="index">
                    <span itemprop="name">大数据开发工程师</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  29.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  135
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<script type="text/javascript" src="/js/src/bai.js"></script>



<h1 id="全文检索引擎Elasticsearch-2"><a href="#全文检索引擎Elasticsearch-2" class="headerlink" title="全文检索引擎Elasticsearch-2"></a>全文检索引擎Elasticsearch-2</h1><h2 id="3-Elasticsearch分词详解"><a href="#3-Elasticsearch分词详解" class="headerlink" title="3 Elasticsearch分词详解"></a>3 Elasticsearch分词详解</h2><h3 id="ES分词介绍"><a href="#ES分词介绍" class="headerlink" title="ES分词介绍"></a>ES分词介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ES中在添加数据，也就是创建索引的时候，会先对数据进行分词。</span><br><span class="line">在查询索引数据的时候，也会先根据查询的关键字进行分词。</span><br><span class="line">所以在ES中分词这个过程是非常重要的，涉及到查询的效率和准确度。</span><br><span class="line"></span><br><span class="line">假设有一条数据，数据中有一个字段是titile，这个字段的值为LexCorp BFG-9000。</span><br><span class="line">我们想要把这条数据在ES中创建索引，方便后期检索。</span><br><span class="line"></span><br><span class="line">创建索引和查询索引的大致流程是这样的：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111457924.png" alt="image-20230611145714539"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">图中左侧是创建索引的过程：</span><br><span class="line">首先对数据进行空白字符分割，将LexCorp BFG-9000切分为LexCorp和BFG-9000。</span><br><span class="line">然后进行单词切割，将LexCorp切分为Lex和Corp，BFG-9000切分为BFG和9000。</span><br><span class="line">最后执行小写转换操作，将英文单词全部转换为小写。</span><br><span class="line"></span><br><span class="line">图中右侧是查询索引的过程：</span><br><span class="line">后期想要查询LexCorp BFG-9000这条数据，但是具体的内容记不清了，大致想起来了一些关键词Lex corp bfg9000。</span><br><span class="line">接下来就根据这些关键词进行查询，</span><br><span class="line">首先还是对数据进行空白符分割，将Lex corp bfg9000切分为Lex、corp 和bfg9000。</span><br><span class="line">然后进行单词切割，Lex和corp不变，将bfg9000切分为bfg和9000。</span><br><span class="line">最后执行小写转换操作，将英文单词全部转换为小写。</span><br><span class="line">这样其实在检索的时候就可以忽略英文大小写了，因为前面在创建索引的时候也会对英文进行小写转换。</span><br><span class="line"></span><br><span class="line">到这可以发现，使用Lex corp bfg9000是可以查找到LexCorp BFG-9000这条数据的，因为在经过空白符分割、单词切割、小写转换之后，这两条数据是一样的，其实只要能有一个单词是匹配的，就可以把这条数据查找出来。</span><br><span class="line"></span><br><span class="line">了解了这个流程之后，我们以后在搜索引擎里面搜索一些内容的时候其实就知道要怎么快速高效的检索内容了，只需要输入一些关键词，中间最好用空格隔开，针对英文字符不用纠结大小写了。</span><br><span class="line"></span><br><span class="line">这些数据在ES中分词之后，其实在底层会产生倒排索引，注意了，倒排索引是ES能够提供快速检索能力的核心，下面来看一下这个倒排索引</span><br></pre></td></tr></table></figure>

<h3 id="倒排索引介绍"><a href="#倒排索引介绍" class="headerlink" title="倒排索引介绍"></a>倒排索引介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设有一批数据，数据中有两个字段，文档编号和文档内容。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111501138.png" alt="image-20230611150131888"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">针对这一批数据，在ES中创建索引之后，最终产生的倒排索引内容大致是这样的：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111501077.png" alt="image-20230611150153996"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">解释：</span><br><span class="line"></span><br><span class="line">单词ID：记录每个单词的单词编号。</span><br><span class="line">单词：对应的单词。</span><br><span class="line">文档频率：代表文档集合中有多少个文档包含某个单词。</span><br><span class="line">倒排列表：包含单词ID及其它必要信息。</span><br><span class="line">DocId：单词出现的文档id。</span><br><span class="line">TF：单词在某个文档中出现的次数。</span><br><span class="line">POS：单词在文档中出现的位置。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">以单词 加盟 为例，其单词编号为6，文档频率为3，代表整个文档集合中有3个文档包含这个单词，对应的倒排列表为&#123;(2;1;&lt;4&gt;),(3;1;&lt;7&gt;),(5;1;&lt;5&gt;)&#125;，含义是在文档2，3，5中出现过这个单词，在每个文档中都只出现过1次，单词 加盟 在第一个文档的POS（位置）是4，即文档的第四个单词是 加盟 ，其它的类似。</span><br><span class="line">这个倒排索引已经是一个非常完备的索引系统，实际搜索系统的索引结构基本如此。</span><br></pre></td></tr></table></figure>

<h3 id="分词器的作用"><a href="#分词器的作用" class="headerlink" title="分词器的作用"></a>分词器的作用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">前面分析了ES在创建索引和查询索引的时候都需要进行分词，分词需要用到分词器。下面来具体分析一下分词器的作用：</span><br><span class="line"></span><br><span class="line">分词器的作用是把一段文本中的词按照一定规则进行切分。</span><br><span class="line"></span><br><span class="line">分词器对应的是Analyzer类，这是一个抽象类，切分词的具体规则是由子类实现的。</span><br><span class="line">也就是说不同的分词器分词的规则是不同的！</span><br><span class="line"></span><br><span class="line">所以对于不同的语言，要用不同的分词器。</span><br><span class="line">在创建索引时会用到分词器，在搜索时也会用到分词器，这两个地方要使用同一个分词器，否则可能会搜索不出结果。</span><br></pre></td></tr></table></figure>

<h4 id="分词器的工作流程"><a href="#分词器的工作流程" class="headerlink" title="分词器的工作流程"></a>分词器的工作流程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">分词器的工作流程一般是这样的：</span><br><span class="line"></span><br><span class="line">1.切分关键词，把关键的、核心的单词切出来。</span><br><span class="line">2.去除停用词。</span><br><span class="line">3.对于英文单词，把所有字母转为小写（搜索时不区分大小写）</span><br><span class="line"></span><br><span class="line">针对停用词下面来详细分析一下：</span><br></pre></td></tr></table></figure>

<h5 id="停用词"><a href="#停用词" class="headerlink" title="停用词"></a>停用词</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">有些词在文本中出现的频率非常高，但是对文本所携带的信息基本不产生影响。</span><br><span class="line">例如：</span><br><span class="line">英文停用词：a、an、the、of等</span><br><span class="line">中文停用词：的、了、着、是、标点符号等</span><br><span class="line"></span><br><span class="line">文本经过分词之后，停用词通常被过滤掉，不会被进行索引。</span><br><span class="line">在检索的时候，用户的查询中如果含有停用词，检索系统也会将其过滤掉（因为用户输入的查询字符串也要进行分词处理）。</span><br><span class="line">排除停用词可以加快建立索引的速度，减小索引库文件的大小，并且还可以提高查询的准确度。</span><br><span class="line">如果不去除停用词，可能会存在这个情况：</span><br><span class="line">假设有一批文章数据，基本上每篇文章里面都有的这个词，那我在检索的时候只要输入了的这个词，那么所有文章都认为是满足条件的数据，但是这样是没有意义的。</span><br><span class="line"></span><br><span class="line">常见的英文停用词汇总：</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">about</span><br><span class="line">above</span><br><span class="line">after</span><br><span class="line">again</span><br><span class="line">against</span><br><span class="line">all</span><br><span class="line">am</span><br><span class="line">an</span><br><span class="line">and</span><br><span class="line">any</span><br><span class="line">are</span><br><span class="line">aren&#39;t</span><br><span class="line">as</span><br><span class="line">at</span><br><span class="line">be</span><br><span class="line">because</span><br><span class="line">been</span><br><span class="line">before</span><br><span class="line">being</span><br><span class="line">below</span><br><span class="line">between</span><br><span class="line">both</span><br><span class="line">but</span><br><span class="line">by</span><br><span class="line">can&#39;t</span><br><span class="line">cannot</span><br><span class="line">could</span><br><span class="line">couldn&#39;t</span><br><span class="line">did</span><br><span class="line">didn&#39;t</span><br><span class="line">do</span><br><span class="line">does</span><br><span class="line">doesn&#39;t</span><br><span class="line">doing</span><br><span class="line">don&#39;t</span><br><span class="line">down</span><br><span class="line">during</span><br><span class="line">each</span><br><span class="line">few</span><br><span class="line">for</span><br><span class="line">from</span><br><span class="line">further</span><br><span class="line">had</span><br><span class="line">hadn&#39;t</span><br><span class="line">has</span><br><span class="line">hasn&#39;t</span><br><span class="line">have</span><br><span class="line">haven&#39;t</span><br><span class="line">having</span><br><span class="line">he</span><br><span class="line">he&#39;d</span><br><span class="line">he&#39;ll</span><br><span class="line">he&#39;s</span><br><span class="line">her</span><br><span class="line">here</span><br><span class="line">here&#39;s</span><br><span class="line">hers</span><br><span class="line">herself</span><br><span class="line">him</span><br><span class="line">himself</span><br><span class="line">his</span><br><span class="line">how</span><br><span class="line">how&#39;s</span><br><span class="line">i</span><br><span class="line">i&#39;d</span><br><span class="line">i&#39;ll</span><br><span class="line">i&#39;m</span><br><span class="line">i&#39;ve</span><br><span class="line">if</span><br><span class="line">in</span><br><span class="line">into</span><br><span class="line">is</span><br><span class="line">isn&#39;t</span><br><span class="line">it</span><br><span class="line">it&#39;s</span><br><span class="line">its</span><br><span class="line">itself</span><br><span class="line">let&#39;s</span><br><span class="line">me</span><br><span class="line">more</span><br><span class="line">most</span><br><span class="line">mustn&#39;t</span><br><span class="line">my</span><br><span class="line">myself</span><br><span class="line">no</span><br><span class="line">nor</span><br><span class="line">not</span><br><span class="line">of</span><br><span class="line">off</span><br><span class="line">on</span><br><span class="line">once</span><br><span class="line">only</span><br><span class="line">or</span><br><span class="line">other</span><br><span class="line">ought</span><br><span class="line">our</span><br><span class="line">ours</span><br><span class="line">ourselves</span><br><span class="line">out</span><br><span class="line">over</span><br><span class="line">own</span><br><span class="line">same</span><br><span class="line">shan&#39;t</span><br><span class="line">she</span><br><span class="line">she&#39;d</span><br><span class="line">she&#39;ll</span><br><span class="line">she&#39;s</span><br><span class="line">should</span><br><span class="line">shouldn&#39;t</span><br><span class="line">so</span><br><span class="line">some</span><br><span class="line">such</span><br><span class="line">than</span><br><span class="line">that</span><br><span class="line">that&#39;s</span><br><span class="line">the</span><br><span class="line">their</span><br><span class="line">theirs</span><br><span class="line">them</span><br><span class="line">themselves</span><br><span class="line">then</span><br><span class="line">there</span><br><span class="line">there&#39;s</span><br><span class="line">these</span><br><span class="line">they</span><br><span class="line">they&#39;d</span><br><span class="line">they&#39;ll</span><br><span class="line">they&#39;re</span><br><span class="line">they&#39;ve</span><br><span class="line">this</span><br><span class="line">those</span><br><span class="line">through</span><br><span class="line">to</span><br><span class="line">too</span><br><span class="line">under</span><br><span class="line">until</span><br><span class="line">up</span><br><span class="line">very</span><br><span class="line">was</span><br><span class="line">wasn&#39;t</span><br><span class="line">we</span><br><span class="line">we&#39;d</span><br><span class="line">we&#39;ll</span><br><span class="line">we&#39;re</span><br><span class="line">we&#39;ve</span><br><span class="line">were</span><br><span class="line">weren&#39;t</span><br><span class="line">what</span><br><span class="line">what&#39;s</span><br><span class="line">when</span><br><span class="line">when&#39;s</span><br><span class="line">where</span><br><span class="line">where&#39;s</span><br><span class="line">which</span><br><span class="line">while</span><br><span class="line">who</span><br><span class="line">who&#39;s</span><br><span class="line">whom</span><br><span class="line">why</span><br><span class="line">why&#39;s</span><br><span class="line">with</span><br><span class="line">won&#39;t</span><br><span class="line">would</span><br><span class="line">wouldn&#39;t</span><br><span class="line">you</span><br><span class="line">you&#39;d</span><br><span class="line">you&#39;ll</span><br><span class="line">you&#39;re</span><br><span class="line">you&#39;ve</span><br><span class="line">your</span><br><span class="line">yours</span><br><span class="line">yourself</span><br><span class="line">yourselves</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">常见的中文停用词汇总：</span><br><span class="line"></span><br><span class="line">的</span><br><span class="line">一</span><br><span class="line">不</span><br><span class="line">在</span><br><span class="line">人</span><br><span class="line">有</span><br><span class="line">是</span><br><span class="line">为</span><br><span class="line">以</span><br><span class="line">于</span><br><span class="line">上</span><br><span class="line">他</span><br><span class="line">而</span><br><span class="line">后</span><br><span class="line">之</span><br><span class="line">来</span><br><span class="line">及</span><br><span class="line">了</span><br><span class="line">因</span><br><span class="line">下</span><br><span class="line">可</span><br><span class="line">到</span><br><span class="line">由</span><br><span class="line">这</span><br><span class="line">与</span><br><span class="line">也</span><br><span class="line">此</span><br><span class="line">但</span><br><span class="line">并</span><br><span class="line">个</span><br><span class="line">其</span><br><span class="line">已</span><br><span class="line">无</span><br><span class="line">小</span><br><span class="line">我</span><br><span class="line">们</span><br><span class="line">起</span><br><span class="line">最</span><br><span class="line">再</span><br><span class="line">今</span><br><span class="line">去</span><br><span class="line">好</span><br><span class="line">只</span><br><span class="line">又</span><br><span class="line">或</span><br><span class="line">很</span><br><span class="line">亦</span><br><span class="line">某</span><br><span class="line">把</span><br><span class="line">那</span><br><span class="line">你</span><br><span class="line">乃</span><br><span class="line">它</span><br><span class="line">吧</span><br><span class="line">被</span><br><span class="line">比</span><br><span class="line">别</span><br><span class="line">趁</span><br><span class="line">当</span><br><span class="line">从</span><br><span class="line">到</span><br><span class="line">得</span><br><span class="line">打</span><br><span class="line">凡</span><br><span class="line">儿</span><br><span class="line">尔</span><br><span class="line">该</span><br><span class="line">各</span><br><span class="line">给</span><br><span class="line">跟</span><br><span class="line">和</span><br><span class="line">何</span><br><span class="line">还</span><br><span class="line">即</span><br><span class="line">几</span><br><span class="line">既</span><br><span class="line">看</span><br><span class="line">据</span><br><span class="line">距</span><br><span class="line">靠</span><br><span class="line">啦</span><br><span class="line">了</span><br><span class="line">另</span><br><span class="line">么</span><br><span class="line">每</span><br><span class="line">们</span><br><span class="line">嘛</span><br><span class="line">拿</span><br><span class="line">哪</span><br><span class="line">那</span><br><span class="line">您</span><br><span class="line">凭</span><br><span class="line">且</span><br><span class="line">却</span><br><span class="line">让</span><br><span class="line">仍</span><br><span class="line">啥</span><br><span class="line">如</span><br><span class="line">若</span><br><span class="line">使</span><br><span class="line">谁</span><br><span class="line">虽</span><br><span class="line">随</span><br><span class="line">同</span><br><span class="line">所</span><br><span class="line">她</span><br><span class="line">哇</span><br><span class="line">嗡</span><br><span class="line">往</span><br><span class="line">哪</span><br><span class="line">些</span><br><span class="line">向</span><br><span class="line">沿</span><br><span class="line">哟</span><br><span class="line">用</span><br><span class="line">于</span><br><span class="line">咱</span><br><span class="line">则</span><br><span class="line">怎</span><br><span class="line">曾</span><br><span class="line">至</span><br><span class="line">致</span><br><span class="line">着</span><br><span class="line">诸</span><br><span class="line">自</span><br></pre></td></tr></table></figure>

<h5 id="中文分词方式"><a href="#中文分词方式" class="headerlink" title="中文分词方式"></a>中文分词方式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">针对中文而言，在分词的时候有多种分词规则：</span><br><span class="line">常见的有单字分词、二分法分词、词库分词等</span><br><span class="line">单字分词：&quot;我&quot;、&quot;们&quot;、&quot;是&quot;、&quot;中&quot;、&quot;国&quot;、&quot;人&quot;</span><br><span class="line">二分法分词：&quot;我们&quot;、&quot;们是&quot;、&quot;是中&quot;、&quot;中国&quot;、&quot;国人&quot;。</span><br><span class="line">词库分词：按照某种算法构造词，然后去匹配已建好的词库集合，如果匹配到就切分出来成为词语。</span><br><span class="line"></span><br><span class="line">从这里面可以看出来，其实最理想的中文分词方式是词库分词。</span><br></pre></td></tr></table></figure>

<h5 id="常见的中文分词器"><a href="#常见的中文分词器" class="headerlink" title="常见的中文分词器"></a>常见的中文分词器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">针对前面分析的几种中文分词方式，对应的有一些已经实现好的中分分词器。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111510363.png" alt="image-20230611151020118"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在词库分词方式领域里面，最经典的就是IK分词器，你懂得！</span><br></pre></td></tr></table></figure>

<h4 id="ES中文分词插件-es-ik"><a href="#ES中文分词插件-es-ik" class="headerlink" title="ES中文分词插件(es-ik)"></a>ES中文分词插件(es-ik)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在中文数据检索场景中，为了提供更好的检索效果，需要在ES中集成中文分词器，因为ES默认是按照英文的分词规则进行分词的，基本上可以认为是单字分词，对中文分词效果不理想。</span><br><span class="line">ES之前是没有提供中文分词器的，现在官方也提供了一些，但是在中文分词领域，IK分词器是不可撼动的，所以在这里我们主要讲一下如何在ES中集成IK这个中文分词器。</span><br><span class="line">首先下载es-ik插件，需要到github上下载。</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111515484.png" alt="image-20230611151532296"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111515497.png" alt="image-20230611151550453"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">最终的下载地址为：</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases&#x2F;download&#x2F;v7.13.4&#x2F;elasticsearch-analysis-ik-7.13.4.zip</span><br><span class="line"></span><br><span class="line">注意：在ES中安装IK插件的时候，需要在ES集群的所有节点中都安装。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1：将下载好的elasticsearch-analysis-ik-7.13.4.zip上传到bigdata01的&#x2F;data&#x2F;soft&#x2F; elasticsearch-7.13.4目录中。</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# ll elasticsearch-analysis-ik-7.13.4.zip </span><br><span class="line">-rw-r--r--. 1 root root 4504502 Sep  3  2021 elasticsearch-analysis-ik-7.13.4.zip</span><br><span class="line"></span><br><span class="line">2：将elasticsearch-analysis-ik-7.13.4.zip远程拷贝到bigdata02和bigdata03上。</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# scp -rq elasticsearch-analysis-ik-7.13.4.zip  bigdata02:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# scp -rq elasticsearch-analysis-ik-7.13.4.zip  bigdata03:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3：在bigdata01节点离线安装IK插件。</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# bin&#x2F;elasticsearch-plugin install file:&#x2F;&#x2F;&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;elasticsearch-analysis-ik-7.13.4.zip</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意：在安装的过程中会有警告信息提示需要输入y确认继续向下执行。</span><br><span class="line"></span><br><span class="line">最后看到如下内容就表示安装成功了。</span><br><span class="line">-&gt; Installed analysis-ik</span><br><span class="line">-&gt; Please restart Elasticsearch to activate any plugins installed</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">config目录下面的analysis-ik里面存储的是ik的配置文件信息。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# cd config&#x2F;</span><br><span class="line">[root@bigdata01 config]# ll analysis-ik&#x2F;</span><br><span class="line">total 8260</span><br><span class="line">-rwxrwxrwx. 1 root root 5225922 Feb 27 20:57 extra_main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word_full.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   10855 Feb 27 20:57 extra_single_word_low_freq.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     156 Feb 27 20:57 extra_stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     625 Feb 27 20:57 IKAnalyzer.cfg.xml</span><br><span class="line">-rwxrwxrwx. 1 root root 3058510 Feb 27 20:57 main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     123 Feb 27 20:57 preposition.dic</span><br><span class="line">-rwxrwxrwx. 1 root root    1824 Feb 27 20:57 quantifier.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     164 Feb 27 20:57 stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     192 Feb 27 20:57 suffix.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     752 Feb 27 20:57 surname.dic</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">plugins目录下面的analysis-ik里面存储的是ik的核心jar包。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# cd plugins&#x2F;</span><br><span class="line">[root@bigdata01 plugins]# ll analysis-ik&#x2F;</span><br><span class="line">total 1428</span><br><span class="line">-rwxrwxrwx. 1 root root 263965 Feb 27 20:56 commons-codec-1.9.jar</span><br><span class="line">-rwxrwxrwx. 1 root root  61829 Feb 27 20:56 commons-logging-1.2.jar</span><br><span class="line">-rwxrwxrwx. 1 root root  54626 Feb 27 20:56 elasticsearch-analysis-ik-7.13.4.jar</span><br><span class="line">-rwxrwxrwx. 1 root root 736658 Feb 27 20:56 httpclient-4.5.2.jar</span><br><span class="line">-rwxrwxrwx. 1 root root 326724 Feb 27 20:56 httpcore-4.4.4.jar</span><br><span class="line">-rwxrwxrwx. 1 root root   1807 Feb 27 20:56 plugin-descriptor.properties</span><br><span class="line">-rwxrwxrwx. 1 root root    125 Feb 27 20:56 plugin-security.policy</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4：在bigdata02节点离线安装IK插件。</span><br><span class="line"></span><br><span class="line">5：在bigdata03节点离线安装IK插件。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">6：如果集群正在运行，则需要停止集群。</span><br><span class="line">在bigdata01上停止。</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# jps</span><br><span class="line">1680 Elasticsearch</span><br><span class="line">2047 Jps</span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# kill 1680</span><br><span class="line"></span><br><span class="line">在bigdata02上停止。</span><br><span class="line"></span><br><span class="line">在bigdata03上停止。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">7：修改elasticsearch-7.13.4的plugins目录下analysis-ik子目录的权限。</span><br><span class="line">直接修改elasticsearch-7.13.4目录的权限即可。</span><br><span class="line">在bigdata01上执行。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 elasticsearch-7.13.4]# cd ..</span><br><span class="line">[root@bigdata01 soft]# chmod -R 777 elasticsearch-7.13.4</span><br><span class="line"></span><br><span class="line">在bigdata02上执行。</span><br><span class="line">在bigdata03上执行。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">8：重新启动ES集群。</span><br><span class="line">在bigdata01上执行。</span><br><span class="line">[root@bigdata01 soft]# su es</span><br><span class="line">[es@bigdata01 soft]$ cd &#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4</span><br><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ bin&#x2F;elasticsearch -d</span><br><span class="line"></span><br><span class="line">在bigdata02上执行。</span><br><span class="line">在bigdata03上执行。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">9：验证IK的分词效果。</span><br><span class="line">首先使用默认分词器测试中文分词效果。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 soft]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;emp&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;我们是中国人&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;我&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 1,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;们&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;是&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;中&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;国&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 4,</span><br><span class="line">      &quot;end_offset&quot; : 5,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;人&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 5,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 5</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">然后使用IK分词器测试中文分词效果。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 soft]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;emp&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;我们是中国人&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;我们&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;是&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;中国人&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;中国&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 5,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;国人&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 4,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在这里我们发现分出来的单词里面有一个是，这个单词其实可以认为是一个停用词，在分词的时候是不需要切分出来的。</span><br><span class="line">在这被切分出来了，那也就意味着在进行停用词过滤的时候没有过滤掉。</span><br><span class="line"></span><br><span class="line">针对ik这个词库而言，它的停用词词库里面都有哪些单词呢？</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata01 elasticsearch-7.13.4]# cd config&#x2F;analysis-ik&#x2F;</span><br><span class="line">[root@bigdata01 analysis-ik]# ll</span><br><span class="line">total 8260</span><br><span class="line">-rwxrwxrwx. 1 root root 5225922 Feb 27 20:57 extra_main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word_full.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   10855 Feb 27 20:57 extra_single_word_low_freq.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     156 Feb 27 20:57 extra_stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     625 Feb 27 20:57 IKAnalyzer.cfg.xml</span><br><span class="line">-rwxrwxrwx. 1 root root 3058510 Feb 27 20:57 main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     123 Feb 27 20:57 preposition.dic</span><br><span class="line">-rwxrwxrwx. 1 root root    1824 Feb 27 20:57 quantifier.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     164 Feb 27 20:57 stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     192 Feb 27 20:57 suffix.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     752 Feb 27 20:57 surname.dic</span><br><span class="line">[root@bigdata01 analysis-ik]# more stopword.dic </span><br><span class="line">a</span><br><span class="line">an</span><br><span class="line">and</span><br><span class="line">are</span><br><span class="line">as</span><br><span class="line">at</span><br><span class="line">be</span><br><span class="line">but</span><br><span class="line">by</span><br><span class="line">for</span><br><span class="line">if</span><br><span class="line">in</span><br><span class="line">into</span><br><span class="line">is</span><br><span class="line">it</span><br><span class="line">no</span><br><span class="line">not</span><br><span class="line">of</span><br><span class="line">on</span><br><span class="line">or</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ik的停用词词库是stopword.dic这个文件，这个文件里面目前都是一些英文停用词。</span><br><span class="line">我们可以手工在这个文件中把中文停用词添加进去，先添加 是 这个停用词。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata01 analysis-ik]# vi stopword.dic </span><br><span class="line">.....</span><br><span class="line">是</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">然后把这个文件的改动同步到集群中的所有节点上。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 analysis-ik]# scp -rq stopword.dic bigdata02:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;</span><br><span class="line">[root@bigdata01 analysis-ik]# scp -rq stopword.dic bigdata03:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">重启集群让配置生效。</span><br><span class="line"></span><br><span class="line">再使用IK分词器测试一下中文分词效果。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 analysis-ik]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;我们是中国人&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;我们&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;中国人&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;中国&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 5,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;国人&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 4,</span><br><span class="line">      &quot;end_offset&quot; : 6,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此时再查看会发现没有&quot;是&quot; 这个单词了，相当于在过滤停用词的时候把它过滤掉了。</span><br></pre></td></tr></table></figure>

<h3 id="es-ik添加自定义词库"><a href="#es-ik添加自定义词库" class="headerlink" title="es-ik添加自定义词库"></a>es-ik添加自定义词库</h3><h4 id="自定义词库"><a href="#自定义词库" class="headerlink" title="自定义词库"></a>自定义词库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">针对一些特殊的词语在分词的时候也需要能够识别。</span><br><span class="line">例如：公司产品的名称或者网络上新流行的词语</span><br><span class="line">假设我们公司开发了一款新产品，命名为：数据大脑，我们希望ES在分词的时候能够把这个产品名称直接识别成一个词语。</span><br><span class="line">现在使用ik分词器测试一下分词效果：</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;数据大脑&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;数据&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;大脑&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">结果发现ik分词器会把数据大脑分为 数据 和 大脑这两个单词。</span><br><span class="line">因为这个词语是我们自己造出来的，并不是通用的词语，所以ik分词器识别不出来也属于正常。</span><br><span class="line">想要让IK分词器识别出来，就需要自定义词库了，也就是把我们自己造的词语添加到词库里面，这样在分词的时候就可以识别到了。</span><br><span class="line">下面演示一下如何在IK中自定义词库：</span><br><span class="line">1：首先在ik插件对应的配置文件目录下创建一个自定义词库文件my.dic</span><br><span class="line">首先在bigdata01节点上操作。</span><br><span class="line">切换到es用户，进入到ik插件对应的配置文件目录</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# su es</span><br><span class="line">[es@bigdata01 root]$ cd &#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4</span><br><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ cd config</span><br><span class="line">[es@bigdata01 config]$ cd analysis-ik</span><br><span class="line">[es@bigdata01 analysis-ik]$ ll</span><br><span class="line">total 8260</span><br><span class="line">-rwxrwxrwx. 1 root root 5225922 Feb 27 20:57 extra_main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   63188 Feb 27 20:57 extra_single_word_full.dic</span><br><span class="line">-rwxrwxrwx. 1 root root   10855 Feb 27 20:57 extra_single_word_low_freq.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     156 Feb 27 20:57 extra_stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     625 Feb 27 20:57 IKAnalyzer.cfg.xml</span><br><span class="line">-rwxrwxrwx. 1 root root 3058510 Feb 27 20:57 main.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     123 Feb 27 20:57 preposition.dic</span><br><span class="line">-rwxrwxrwx. 1 root root    1824 Feb 27 20:57 quantifier.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     171 Feb 27 21:42 stopword.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     192 Feb 27 20:57 suffix.dic</span><br><span class="line">-rwxrwxrwx. 1 root root     752 Feb 27 20:57 surname.dic</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建自定义词库文件my.dic</span><br><span class="line">直接在文件中添加词语即可，每一个词语一行。</span><br><span class="line"></span><br><span class="line">[es@bigdata01 analysis-ik]$ vi my.dic</span><br><span class="line">数据大脑</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">注意：这个my.dic词库文件可以在Linux中直接使用vi命令创建，或者在Windows中创建之后上传到这里。</span><br><span class="line"></span><br><span class="line">-如果是在Linux中直接使用vi命令创建，可以直接使用。</span><br><span class="line">-如果是在Windows中创建的，需要注意文件的编码必须是UTF-8 without BOM 格式【UTF-8 无 BOM格式】</span><br><span class="line"></span><br><span class="line">以Notepad++为例：新版本的Notepad++里面的文件编码有这么几种，需要选择【使用UTF-8编码】，这个就是UTF-8 without BOM 格式。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111535279.png" alt="image-20230611153519003"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2：修改ik的IKAnalyzer.cfg.xml配置文件</span><br><span class="line">进入到ik插件对应的配置文件目录中，修改IKAnalyzer.cfg.xml配置文件</span><br><span class="line"></span><br><span class="line">[es@bigdata01 analysis-ik]$ vi IKAnalyzer.cfg.xml </span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http:&#x2F;&#x2F;java.sun.com&#x2F;dtd&#x2F;properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;&#x2F;comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key&#x3D;&quot;ext_dict&quot;&gt;my.dic&lt;&#x2F;entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key&#x3D;&quot;ext_stopwords&quot;&gt;&lt;&#x2F;entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">        &lt;!-- &lt;entry key&#x3D;&quot;remote_ext_dict&quot;&gt;words_location&lt;&#x2F;entry&gt; --&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key&#x3D;&quot;remote_ext_stopwords&quot;&gt;words_location&lt;&#x2F;entry&gt;--&gt;</span><br><span class="line">&lt;&#x2F;properties&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">注意：需要把my.dic词库文件添加到key&#x3D;&quot;ext_dict&quot;这个entry中，切记不要随意新增entry，随意新增的entry是不被IK识别的，并且entry的名称也不能乱改，否则也不会识别。</span><br><span class="line"></span><br><span class="line">如果需要指定多个自定义词库文件的话需要使用分号;隔开。</span><br><span class="line">例如：&lt;entry key&#x3D;&quot;ext_dict&quot;&gt;my.dic;your.dic&lt;&#x2F;entry&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3：将修改好的IK配置文件复制到集群中的所有节点中</span><br><span class="line"></span><br><span class="line">注意：如果是多个节点的ES集群，一定要把配置远程拷贝到其他节点。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">先从bigdata01上将my.dic拷贝到bigdata02和bigdata03</span><br><span class="line"></span><br><span class="line">[es@bigdata01 analysis-ik]$ scp -rq my.dic bigdata02:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;</span><br><span class="line">The authenticity of host &#39;bigdata02 (192.168.182.101)&#39; can&#39;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:SnzVynyweeRcPIorakoDQRxFhugZp6PNIPV3agX&#x2F;bZM.</span><br><span class="line">ECDSA key fingerprint is MD5:f6:1a:48:78:64:77:89:52:c4:ad:63:82:a5:d5:57:92.</span><br><span class="line">Are you sure you want to continue connecting (yes&#x2F;no)? yes</span><br><span class="line">es@bigdata02&#39;s password: </span><br><span class="line">[es@bigdata01 analysis-ik]$ scp -rq my.dic bigdata03:&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;</span><br><span class="line">The authenticity of host &#39;bigdata03 (192.168.182.102)&#39; can&#39;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:SnzVynyweeRcPIorakoDQRxFhugZp6PNIPV3agX&#x2F;bZM.</span><br><span class="line">ECDSA key fingerprint is MD5:f6:1a:48:78:64:77:89:52:c4:ad:63:82:a5:d5:57:92.</span><br><span class="line">Are you sure you want to continue connecting (yes&#x2F;no)? yes</span><br><span class="line">es@bigdata03&#39;s password:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：因为现在使用的是普通用户es，所以在使用scp的时候需要指定目标机器的用户名（如果是root可以省略不写），并且还需要手工输入密码，因为之前是基于root用户做的免密码登录。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">再从bigdata01上将IKAnalyzer.cfg.xml拷贝到bigdata02和bigdata03</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：如果后期想增加自定义停用词库，也需要按照这个思路进行添加，只不过停用词库需要配置到 key&#x3D;&quot;ext_stopwords&quot;这个entry中。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">4：重启ES验证一下自定义词库的分词效果</span><br><span class="line"></span><br><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;数据大脑&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;数据大脑&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;数据&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;大脑&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">现在发现数据大脑这个词语可以被识别出来了，说明自定义词库生效了。</span><br></pre></td></tr></table></figure>

<h4 id="热更新词库"><a href="#热更新词库" class="headerlink" title="热更新词库"></a>热更新词库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">针对前面分析的自定义词库，后期只要词库内容发生了变动，就需要重启ES才能生效，在实际工作中，频繁重启ES集群不是一个好办法</span><br><span class="line">所以ES提供了热更新词库的解决方案，在不重启ES集群的情况下识别新增的词语，这样就很方便了，也不会对线上业务产生影响。</span><br><span class="line">下面来演示一下热更新词库的使用：</span><br><span class="line">1：在bigdata04上部署HTTP服务</span><br><span class="line">在这使用tomcat作为Web容器，先下载一个tomcat 8.x版本。</span><br><span class="line">tomcat 8.0.52版本下载地址：</span><br><span class="line">https:&#x2F;&#x2F;archive.apache.org&#x2F;dist&#x2F;tomcat&#x2F;tomcat-8&#x2F;v8.0.52&#x2F;bin&#x2F;apache-tomcat-8.0.52.tar.gz</span><br><span class="line">上传到bigdata04上的&#x2F;data&#x2F;soft目录里面，并且解压</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata04 soft]# ll apache-tomcat-8.0.52.tar.gz </span><br><span class="line">-rw-r--r--. 1 root root 9435483 Sep 22  2021 apache-tomcat-8.0.52.tar.gz</span><br><span class="line">[root@bigdata04 soft]# tar -zxvf apache-tomcat-8.0.52.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tomcat的ROOT项目中创建一个自定义词库文件hot.dic，在文件中输入一行内容：测试</span><br><span class="line">[root@bigdata04 soft]# cd apache-tomcat-8.0.52</span><br><span class="line">[root@bigdata04 apache-tomcat-8.0.52]# cd webapps&#x2F;ROOT&#x2F;</span><br><span class="line">[root@bigdata04 ROOT]# vi hot.dic</span><br><span class="line">测试</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">启动Tomcat</span><br><span class="line"></span><br><span class="line">[root@bigdata04 ROOT]# cd &#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52</span><br><span class="line">[root@bigdata04 apache-tomcat-8.0.52]# bin&#x2F;startup.sh </span><br><span class="line">Using CATALINA_BASE:   &#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52</span><br><span class="line">Using CATALINA_HOME:   &#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52</span><br><span class="line">Using CATALINA_TMPDIR: &#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52&#x2F;temp</span><br><span class="line">Using JRE_HOME:        &#x2F;data&#x2F;soft&#x2F;jdk1.8</span><br><span class="line">Using CLASSPATH:       &#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52&#x2F;bin&#x2F;bootstrap.jar:&#x2F;data&#x2F;soft&#x2F;apache-tomcat-8.0.52&#x2F;bin&#x2F;tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">验证一下hot.dic文件是否可以通过浏览器访问：</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111553223.png" alt="image-20230611155315334">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">注意：页面会显示乱码，这是正常的，不用处理即可。</span><br><span class="line"></span><br><span class="line">2：修改ES集群中ik插件的IKAnalyzer.cfg.xml配置文件</span><br><span class="line">在bigdata01上修改。</span><br><span class="line">在key&#x3D;&quot;remote_ext_dict&quot;这个entry中添加hot.dic的远程访问链接</span><br><span class="line">http:&#x2F;&#x2F;bigdata04:8080&#x2F;hot.dic</span><br><span class="line"></span><br><span class="line">注意：一定要记得去掉key&#x3D;&quot;remote_ext_dict&quot;这个entry外面的注释，否则添加的内容是不生效的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[es@bigdata01 analysis-ik]$ vi IKAnalyzer.cfg.xml </span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http:&#x2F;&#x2F;java.sun.com&#x2F;dtd&#x2F;properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;&#x2F;comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key&#x3D;&quot;ext_dict&quot;&gt;my.dic&lt;&#x2F;entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key&#x3D;&quot;ext_stopwords&quot;&gt;&lt;&#x2F;entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">        &lt;entry key&#x3D;&quot;remote_ext_dict&quot;&gt;http:&#x2F;&#x2F;bigdata04:8080&#x2F;hot.dic&lt;&#x2F;entry&gt; </span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key&#x3D;&quot;remote_ext_stopwords&quot;&gt;words_location&lt;&#x2F;entry&gt;--&gt;</span><br><span class="line">&lt;&#x2F;properties&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3：将修改好的IK配置文件复制到集群中的所有节点中</span><br><span class="line"></span><br><span class="line">4：重启ES集群验证效果。</span><br><span class="line">因为修改了配置，所以需要重启集群。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">验证：</span><br><span class="line">对北京雾霾这个词语进行分词</span><br><span class="line"></span><br><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;北京雾霾&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;北京&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;雾&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;霾&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正常情况下 北京雾霾 会被分被拆分为多个词语，但是在这我希望ES能够把 北京雾霾 认为是一个完整的词语，又不希望重启ES。</span><br><span class="line">这样就可以修改前面配置的hot.dic文件，在里面增加一个词语：北京雾霾</span><br><span class="line">在bigdata04里面操作，此时可以在Linux中直接编辑文件。</span><br><span class="line"></span><br><span class="line">[root@bigdata04 apache-tomcat-8.0.52]# cd webapps&#x2F;ROOT&#x2F;</span><br><span class="line">[root@bigdata04 ROOT]# vi hot.dic </span><br><span class="line">测试</span><br><span class="line">北京雾霾</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">文件保存之后，在bigdata01上查看ES的日志会看到如下日志信息：</span><br><span class="line">[2027-03-09T18:43:12,700][INFO ][o.w.a.d.Dictionary       ] [bigdata01] start to reload ik dict.</span><br><span class="line">[2027-03-09T18:43:12,701][INFO ][o.w.a.d.Dictionary       ] [bigdata01] try load config from &#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;IKAnalyzer.cfg.xml</span><br><span class="line">[2027-03-09T18:43:12,929][INFO ][o.w.a.d.Dictionary       ] [bigdata01] [Dict Loading] &#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;config&#x2F;analysis-ik&#x2F;my.dic</span><br><span class="line">[2027-03-09T18:43:12,929][INFO ][o.w.a.d.Dictionary       ] [bigdata01] [Dict Loading] http:&#x2F;&#x2F;bigdata04:8080&#x2F;hot.dic</span><br><span class="line">[2027-03-09T18:43:12,934][INFO ][o.w.a.d.Dictionary       ] [bigdata01] ﻿测试</span><br><span class="line">[2027-03-09T18:43:12,935][INFO ][o.w.a.d.Dictionary       ] [bigdata01] 北京雾霾</span><br><span class="line">[2027-03-09T18:43:12,935][INFO ][o.w.a.d.Dictionary       ] [bigdata01] reload ik dict finished.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">再对北京雾霾这个词语进行分词</span><br><span class="line"></span><br><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;北京雾霾&quot;,&quot;tokenizer&quot;:&quot;ik_max_word&quot;&#125;&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;北京雾霾&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;北京&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;雾&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;霾&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">此时，发现北京雾霾这个词语就可以完整被切分出来了，到这为止，我们就成功实现了热更新自定义词库的功能。</span><br><span class="line"></span><br><span class="line">注意：默认情况下，最多一分钟之内就可以识别到新增的词语。</span><br><span class="line">通过查看es-ik插件的源码可以发现</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;blob&#x2F;master&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;wltea&#x2F;analyzer&#x2F;dic&#x2F;Monitor.java</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111559457.png" alt="image-20230611155917849"></p>
<h2 id="4-Elasticsearch查询详解"><a href="#4-Elasticsearch查询详解" class="headerlink" title="4 Elasticsearch查询详解"></a>4 Elasticsearch查询详解</h2><h3 id="ES-Search查询"><a href="#ES-Search查询" class="headerlink" title="ES Search查询"></a>ES Search查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在ES中查询单条数据可以使用Get，想要查询一批满足条件的数据的话，就需要使用Search了。</span><br><span class="line">下面来看一个案例，查询索引库中的所有数据，代码如下：</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Search详解</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsSearchOp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//获取RestClient连接</span></span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata01"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata02"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata03"</span>, <span class="number">9200</span>, <span class="string">"http"</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        <span class="comment">//指定索引库，支持指定一个或者多个，也支持通配符，例如：user*</span></span><br><span class="line">        searchRequest.indices(<span class="string">"user"</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//过滤条件</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//执行查询操作</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取查询返回的结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//获取数据总量</span></span><br><span class="line">        <span class="keyword">long</span> numHits = hits.getTotalHits().value;</span><br><span class="line">        System.out.println(<span class="string">"数据总数："</span>+numHits);</span><br><span class="line">        <span class="comment">//获取具体内容</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//迭代解析具体内容</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        client.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在执行代码之前先初始化数据：</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;1&#39; -d &#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:20&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;2&#39; -d &#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:15&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;3&#39; -d &#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:17&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;4&#39; -d &#39;&#123;&quot;name&quot;:&quot;jess&quot;,&quot;age&quot;:19&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;5&#39; -d &#39;&#123;&quot;name&quot;:&quot;mick&quot;,&quot;age&quot;:23&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;6&#39; -d &#39;&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:12&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;7&#39; -d &#39;&#123;&quot;name&quot;:&quot;john&quot;,&quot;age&quot;:28&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;8&#39; -d &#39;&#123;&quot;name&quot;:&quot;jojo&quot;,&quot;age&quot;:30&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;9&#39; -d &#39;&#123;&quot;name&quot;:&quot;bubu&quot;,&quot;age&quot;:16&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;10&#39; -d &#39;&#123;&quot;name&quot;:&quot;pig&quot;,&quot;age&quot;:21&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;11&#39; -d &#39;&#123;&quot;name&quot;:&quot;mary&quot;,&quot;age&quot;:19&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">在IDEA中执行代码，可以看到下面结果：</span><br><span class="line">数据总数：11</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:20&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:15&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:17&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jess&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;mick&quot;,&quot;age&quot;:23&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:12&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;john&quot;,&quot;age&quot;:28&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jojo&quot;,&quot;age&quot;:30&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;bubu&quot;,&quot;age&quot;:16&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;pig&quot;,&quot;age&quot;:21&#125;</span><br><span class="line"></span><br><span class="line">显示数据总数有11条，但是下面的明细内容只有10条，这是因为ES默认只会返回10条数据，如果默认返回所有满足条件的数据，对ES的压力就比较大了。</span><br></pre></td></tr></table></figure>

<h3 id="searchType详解"><a href="#searchType详解" class="headerlink" title="searchType详解"></a>searchType详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ES在查询数据的时候可以指定searchType，也就是搜索类型</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;指定searchType</span><br><span class="line">searchRequest.searchType(SearchType.QUERY_THEN_FETCH);</span><br><span class="line"></span><br><span class="line">searchType之前是可以指定为下面这4种：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111606352.png" alt="image-20230611160600236"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其中QUERY AND FETCH和DFS QUERY AND FETCH这两种searchType现在已经不支持了。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">这4种搜索类型到底有什么区别，下面我们来详细分析一下：</span><br><span class="line"></span><br><span class="line">在具体分析这4种搜索类型的区别之前，我们先分析一下分布式搜索的背景：</span><br><span class="line">ES天生就是为分布式而生的，但分布式有分布式的缺点，比如要搜索某个单词，但是数据却分别在5个分片（Shard)上面，这5个分片可能在5台主机上面。因为全文搜索天生就要排序（按照匹配度进行排名）,但数据却在5个分片上，如何得到最后正确的排序呢？ES是这样做的，大概分两步。</span><br><span class="line">第1步：ES客户端将会同时向5个分片发起搜索请求。</span><br><span class="line">第2步：这5个分片基于本分片的内容独立完成搜索，然后将符合条件的结果全部返回。</span><br><span class="line">大致流程如下图所示：</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111613627.png" alt="image-20230611161344874" style="zoom: 50%;">



<img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111614039.png" alt="image-20230611161408321" style="zoom:50%;">



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">然而这其中有两个问题。</span><br><span class="line">第一：数量问题。比如，用户需要搜索&quot;衣服&quot;，要求返回符合条件的前10条。但在5个分片中，可能都存储着衣服相关的数据。所以ES会向这5个分片都发出查询请求，并且要求每个分片都返回符合条件的10条记录。这种情况，ES中5个分片最多会收到10*5&#x3D;50条记录，这样返回给用户的结果数量会多于用户请求的数量。</span><br><span class="line">第二：排名问题。上面说的搜索，每个分片计算符合条件的前10条数据都是基于自己分片的数据进行打分计算的。计算分值使用的词频和文档频率等信息都是基于自己分片的数据进行的，而ES进行整体排名是基于每个分片计算后的分值进行排序的(相当于打分依据就不一样，最终对这些数据统一排名的时候就不准确了)，这就可能会导致排名不准确的问题。如果我们想更精确的控制排序，应该先将计算排序和排名相关的信息（词频和文档频率等打分依据）从5个分片收集上来，进行统一计算，然后使用整体的词频和文档频率为每个分片中的数据进行打分，这样打分依据就一样了。</span><br><span class="line"></span><br><span class="line">再举个例子解释一下【排名问题】：</span><br><span class="line">假设某学校有一班和二班两个班级。</span><br><span class="line">期末考试之后，学校要给全校前十名学员发奖金。</span><br><span class="line">但是一班和二班考试的时候使用的不是一套试卷。</span><br><span class="line">一班：使用的是A卷【A卷偏容易】</span><br><span class="line">二班：使用的是B卷【B卷偏难】</span><br><span class="line">结果就是一班的最高分是100分，最低分是80分。</span><br><span class="line">二班的最高分是70分，最低分是30分。</span><br><span class="line"></span><br><span class="line">这样全校前十名就都是一班的学员了。这显然是不合理的。</span><br><span class="line">因为一班和二班的试卷难易程度不一样，也就是打分依据不一样，所以不能放在一块排名，这个就解释了刚才的排名问题。</span><br><span class="line">如果想要保证排名准确的话，需要保证一班和二班使用的试卷内容一样。</span><br><span class="line">可以这样做，把A卷和B卷的内容组合到一块，作为C卷。</span><br><span class="line">一班和二班考试都使用C卷，这样他们的打分依据就一样了，最终再根据所有学员的成绩排名求前十名就准确合理了。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这两个问题，ES也没有什么较好的解决方法，最终把选择的权利交给用户，方法就是在搜索的时候指定searchType。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">1.QUERY AND FETCH(淘汰)</span><br><span class="line">向索引的所有分片都发出查询请求，各分片返回的时候把元素文档（document）和计算后的排名信息一起返回。</span><br><span class="line">这种搜索方式是最快的。因为相比下面的几种搜索方式，这种查询方法只需要去分片查询一次。但是各个分片返回的结果的数量之和可能是用户要求的数据量的N倍。</span><br><span class="line">优点：</span><br><span class="line">只需要查询一次</span><br><span class="line">缺点：</span><br><span class="line">返回的数据量不准确，可能返回(N*分片数量)的数据</span><br><span class="line">并且数据排名也不准确</span><br><span class="line"></span><br><span class="line">2.QUERY THEN FETCH（ES默认的搜索方式）</span><br><span class="line">如果你搜索时，没有指定搜索方式，就是使用的这种搜索方式。这种搜索方式，大概分两个步骤，</span><br><span class="line">第一步，先向所有的分片发出请求，各分片只返回文档id(注意，不包括文档document)和排名相关的信息(也就是文档对应的分值)，然后按照各分片返回的文档的分数进行重新排序和排名，取前size个文档。</span><br><span class="line">第二步，根据文档id去相关的分片取文档。这种方式返回的文档数量与用户要求的数量是相等的。</span><br><span class="line">优点：</span><br><span class="line">返回的数据量是准确的</span><br><span class="line">缺点：</span><br><span class="line">性能一般，</span><br><span class="line">并且数据排名不准确</span><br><span class="line"></span><br><span class="line">3.DFS QUERY AND FETCH(淘汰)</span><br><span class="line">这种方式比第一种方式多了一个DFS步骤，有这一步，可以更精确控制搜索打分和排名。</span><br><span class="line">也就是在进行查询之前，先对所有分片发送请求，把所有分片中的词频和文档频率等打分依据全部汇总到一块，再执行后面的操作、</span><br><span class="line">优点：</span><br><span class="line">数据排名准确</span><br><span class="line">缺点：</span><br><span class="line">性能一般</span><br><span class="line">返回的数据量不准确，可能返回(N*分片数量)的数据</span><br><span class="line"></span><br><span class="line">4.DFS QUERY THEN FETCH</span><br><span class="line">比第2种方式多了一个DFS步骤。</span><br><span class="line">也就是在进行查询之前，先对所有分片发送请求，把所有分片中的词频和文档频率等打分依据全部汇总到一块，再执行后面的操作、</span><br><span class="line">优点：</span><br><span class="line">返回的数据量是准确的</span><br><span class="line">数据排名准确</span><br><span class="line">缺点：</span><br><span class="line">性能最差【这个最差只是表示在这四种查询方式中性能最慢，也不至于不能忍受，如果对查询性能要求不是非常高，而对查询准确度要求比较高的时候可以考虑这个】</span><br></pre></td></tr></table></figure>

<h3 id="DFS是一个什么样的过程？"><a href="#DFS是一个什么样的过程？" class="headerlink" title="DFS是一个什么样的过程？"></a>DFS是一个什么样的过程？</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DFS其实就是在进行真正的查询之前，先把各个分片的词频率和文档频率收集一下，然后进行词搜索的时候，各分片依据全局的词频率和文档频率进行搜索和排名。显然如果使用DFS_QUERY_THEN_FETCH这种查询方式，效率是最低的，因为一个搜索，可能要请求3次分片。但使用DFS方法，搜索精度是最高的。</span><br><span class="line"></span><br><span class="line">总结一下，从性能考虑QUERY_AND_FETCH是最快的，DFS_QUERY_THEN_FETCH是最慢的。从搜索的准确度来说，DFS要比非DFS的准确度更高。</span><br><span class="line"></span><br><span class="line">目前官方舍弃了QUERY AND FETCH和DFS QUERY AND FETCH这两种类型，保留了QUERY THEN FETCH和DFS QUERY THEN FETCH，这两种都是可以保证数据量是准确的。如果对查询的精确度要求没那么高，就使用QUERY THEN FETCH，如果对查询数据的精确度要求非常高，就使用DFS QUERY THEN FETCH。</span><br></pre></td></tr></table></figure>

<h3 id="ES查询扩展"><a href="#ES查询扩展" class="headerlink" title="ES查询扩展"></a>ES查询扩展</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在查询数据的时候可以在searchRequest中指定一些参数，实现过滤、分页、排序、高亮等功能</span><br></pre></td></tr></table></figure>

<h4 id="EsSearchOp"><a href="#EsSearchOp" class="headerlink" title="EsSearchOp"></a>EsSearchOp</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.text.Text;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.Operator;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightField;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Search详解</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsSearchOp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//获取RestClient连接</span></span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata01"</span>,<span class="number">9200</span>,<span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata02"</span>,<span class="number">9200</span>,<span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata03"</span>,<span class="number">9200</span>,<span class="string">"http"</span>)));</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        <span class="comment">//指定索引库，支持指定一个或者多个，也支持通配符，例如：user*</span></span><br><span class="line">        searchRequest.indices(<span class="string">"user"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定查询条件</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//查询所有，可以不指定，默认就是查询索引库中的所有数据</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span></span><br><span class="line">        <span class="comment">//对指定字段的值进行过滤，注意：在查询数据的时候会对数据进行分词</span></span><br><span class="line">        <span class="comment">//如果指定多个query，后面的query会覆盖前面的query</span></span><br><span class="line">        <span class="comment">//针对字符串类型内容的查询，不支持通配符</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","tom"));</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("age","17"));//针对age的值，这里可以指定字符串或者数字都可以</span></span><br><span class="line">        <span class="comment">//针对字符串类型内容的查询，支持通配符，但是性能较差，可以认为是全表扫描</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.wildcardQuery("name","t*"));</span></span><br><span class="line">        <span class="comment">//区间查询，主要针对数据类型，可以使用from+to 或者gt,gte+lt,lte</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").from(0).to(20));</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").gte(0).lte(20));</span></span><br><span class="line">        <span class="comment">//不限制边界，指定为null即可</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").from(0).to(null));</span></span><br><span class="line">        <span class="comment">//同时指定多个条件，条件之间的关系支持and(must)、or(should)</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery("name","tom")).should(QueryBuilders.matchQuery("age",19)));</span></span><br><span class="line">        <span class="comment">//多条件组合查询的时候，可以设置条件的权重值，将满足高权重值条件的数据排到结果列表的前面</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery("name","tom").boost(1.0f)).should(QueryBuilders.matchQuery("age",19).boost(5.0f)));</span></span><br><span class="line">        <span class="comment">//对多个指定字段的值进行过滤，注意：多个字段的数据类型必须一致，否则会报错，如果查询的字段不存在不会报错</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.multiMatchQuery("tom","name","tag"));</span></span><br><span class="line">        <span class="comment">//这里通过queryStringQuery可以支持Lucene的原生查询语法，更加灵活，注意：AND、OR、TO之类的关键字必须大写</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:tom AND age:[15 TO 30]"));</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().must(QueryBuilders.matchQuery("name","tom")).must(QueryBuilders.rangeQuery("age").from(15).to(30)));</span></span><br><span class="line">        <span class="comment">//queryStringQuery支持通配符，但是性能也是比较差</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:t*"));</span></span><br><span class="line">        <span class="comment">//精确查询，查询的时候不分词，针对人名、手机号、主机名、邮箱号码等字段的查询时一般不需要分词</span></span><br><span class="line">        <span class="comment">//初始化一条测试数据name=刘德华，默认情况下在建立索引的时候刘德华 会被切分为刘、德、华这三个词</span></span><br><span class="line">        <span class="comment">//所以这里精确查询是查不出来的，使用matchQuery是可以查出来的</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华"));</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.termQuery("name","刘德华"));</span></span><br><span class="line">        <span class="comment">//正常情况下想要使用termQuery实现精确查询的字段不能进行分词</span></span><br><span class="line">        <span class="comment">//但是有时候会遇到某个字段已经分词建立索引了，后期还想要实现精确查询</span></span><br><span class="line">        <span class="comment">//重新建立索引也不现实，怎么办呢？</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:\"刘德华\""));</span></span><br><span class="line">        <span class="comment">//matchQuery默认会根据分词的结果进行 or 操作，满足任意一个词语的数据都会查询出来</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华"));</span></span><br><span class="line">        <span class="comment">//如果想要对matchQuery的分词结果实现and操作，可以通过operator进行设置</span></span><br><span class="line">        <span class="comment">//这种方式也可以解决某个字段已经分词建立索引了，后期还想要实现精确查询的问题（间接实现，其实是查询了满足刘、德、华这三个词语的内容）</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华").operator(Operator.AND));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//高亮查询name字段</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","tom"));</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华"));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        <span class="comment">//设置每页的起始位置，默认是0</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.from(0);</span></span><br><span class="line">        <span class="comment">//设置每页的数据量，默认是10</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.size(10);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.sort("age", SortOrder.DESC);</span></span><br><span class="line">        <span class="comment">//注意：age字段是数字类型，不需要分词，name字段是字符串类型（Text），默认会被分词，所以不支持排序和聚合操作</span></span><br><span class="line">        <span class="comment">//如果想要根据这些会被分词的字段进行排序或者聚合，需要指定使用他们的keyword类型，这个类型表示不会对数据分词</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.sort("name.keyword",SortOrder.DESC);</span></span><br><span class="line">        <span class="comment">//keyword类型的特性其实也适用于精确查询的场景，可以在matchQuery中指定字段的keyword类型实现精确查询，不管在建立索引的时候有没有被分词都不影响使用</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name.keyword","刘德华"));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//高亮</span></span><br><span class="line">        <span class="comment">//设置高亮字段</span></span><br><span class="line">        HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder()</span><br><span class="line">                .field(<span class="string">"name"</span>);<span class="comment">//支持多个高亮字段，使用多个field方法指定即可</span></span><br><span class="line">        <span class="comment">//设置高亮字段的前缀和后缀内容</span></span><br><span class="line">        highlightBuilder.preTags(<span class="string">"&lt;font color='red'&gt;"</span>);</span><br><span class="line">        highlightBuilder.postTags(<span class="string">"&lt;/font&gt;"</span>);</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//执行查询操作</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取查询返回的结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//获取数据总量</span></span><br><span class="line">        <span class="keyword">long</span> numHits = hits.getTotalHits().value;</span><br><span class="line">        System.out.println(<span class="string">"数据总数："</span>+numHits);</span><br><span class="line">        <span class="comment">//获取具体内容</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//迭代解析具体内容</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            <span class="comment">/*String sourceAsString = hit.getSourceAsString();</span></span><br><span class="line"><span class="comment">            System.out.println(sourceAsString);*/</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = sourceAsMap.get(<span class="string">"name"</span>).toString();</span><br><span class="line">            <span class="keyword">int</span> age = Integer.parseInt(sourceAsMap.get(<span class="string">"age"</span>).toString());</span><br><span class="line">            <span class="comment">//获取高亮字段内容</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">            <span class="comment">//获取name字段的高亮内容</span></span><br><span class="line">            HighlightField highlightField = highlightFields.get(<span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span>(highlightField!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                Text[] fragments = highlightField.getFragments();</span><br><span class="line">                name = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">for</span> (Text text: fragments) &#123;</span><br><span class="line">                    name += text;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取最终的结果数据</span></span><br><span class="line">            System.out.println(name+<span class="string">"---"</span>+age);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">首先看一下如何在查询的时候指定过滤条件</span><br><span class="line">核心代码如下：</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定查询条件</span></span><br><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"><span class="comment">//查询所有，可以不指定，默认就是查询索引库中的所有数据</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//对指定字段的值进行过滤，注意：在查询数据的时候会对数据进行分词</span></span><br><span class="line"><span class="comment">//如果指定多个query，后面的query会覆盖前面的query</span></span><br><span class="line"><span class="comment">//针对字符串(数字)类型内容的查询，不支持通配符</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","tom"));</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("age","17"));//针对age的值，这里可以指定字符串或者数字都可以</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//针对字符串类型内容的查询，支持通配符，但是性能较差，可以认为是全表扫描</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.wildcardQuery("name","t*"));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//区间查询，主要针对数据类型，可以使用from+to 或者gt,gte+lt,lte</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").from(0).to(20));</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").gte(0).lte(20));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//不限制边界，指定为null即可</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.rangeQuery("age").from(0).to(null));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//同时指定多个条件，条件之间的关系支持and(must)、or(should)</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery("name","tom")).should(QueryBuilders.matchQuery("age",19)));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//多条件组合查询的时候，可以设置条件的权重值，将满足高权重值条件的数据排到结果列表的前面</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery("name","tom").boost(1.0f)).should(QueryBuilders.matchQuery("age",19).boost(5.0f)));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//对多个指定字段的值进行过滤，注意：多个字段的数据类型必须一致，否则会报错，如果查询的字段不存在不会报错</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.multiMatchQuery("tom","name","tag")); // tag字段不存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这里通过queryStringQuery可以支持Lucene的原生查询语法，更加灵活，注意：AND、OR、TO之类的关键字必须大写</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:tom AND age:[15 TO 30]"));</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.boolQuery().must(QueryBuilders.matchQuery("name","tom")).must(QueryBuilders.rangeQuery("age").from(15).to(30)));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//queryStringQuery支持通配符，但是性能也是比较差</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:t*"));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//精确查询(查询时不分词)，查询的时候不分词，针对人名、手机号、主机名、邮箱号码等字段的查询时一般不需要分词</span></span><br><span class="line"><span class="comment">//初始化一条测试数据name=刘德华，默认情况下在建立索引的时候(这是建立索引，还没字段的分词器，还是默认的)刘德华 会被切分为刘、德、华这三个词</span></span><br><span class="line"><span class="comment">//所以这里精确查询是查不出来的，使用matchQuery是可以查出来的</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华"));</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.termQuery("name","刘德华"));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//正常情况下想要使用termQuery实现精确查询的字段不能进行分词</span></span><br><span class="line"><span class="comment">//但是有时候会遇到某个字段已经分词建立索引了，后期还想要实现精确查询</span></span><br><span class="line"><span class="comment">//重新建立索引也不现实，怎么办呢？</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.queryStringQuery("name:\"刘德华\"")); //这里里面是转义字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//matchQuery默认会根据分词的结果进行 or 操作，满足任意一个词语的数据都会查询出来</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华"));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果想要对matchQuery的分词结果实现and操作，可以通过operator进行设置</span></span><br><span class="line"><span class="comment">//这种方式也可以解决某个字段已经分词建立索引了，后期还想要实现精确查询的问题（间接实现，其实是查询了满足刘、德、华这三个词语的内容）</span></span><br><span class="line"><span class="comment">//searchSourceBuilder.query(QueryBuilders.matchQuery("name","刘德华").operator(Operator.AND));</span></span><br><span class="line"></span><br><span class="line">searchRequest.source(searchSourceBuilder);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">带权重</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306132345436.png" alt="image-20230613234458201"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用match，还是模糊查询</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306132358298.png" alt="image-20230613235809923"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">termQuery，查不到结果，因为他直接拿“刘德华”去查询，索引库里没有</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140001201.png" alt="image-20230614000114276"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用queryStringQuery实现精准查询</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140003432.png" alt="image-20230614000332868"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">默认情况下ES会对刘德华这个词语进行分词，效果如下（使用的默认分词器）：</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST  &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;emp&#x2F;_analyze?pretty&#39; -d &#39;&#123;&quot;text&quot;:&quot;刘德华&quot;&#125;&#39;      </span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;刘&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 1,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;德&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;华&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">初始化数据：</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;12&#39; -d &#39;&#123;&quot;name&quot;:&quot;刘德华&quot;,&quot;age&quot;:60&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]$ curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;user&#x2F;_doc&#x2F;13&#39; -d &#39;&#123;&quot;name&quot;:&quot;刘老二&quot;,&quot;age&quot;:20&#125;&#39;</span><br></pre></td></tr></table></figure>

<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ES每次返回的数据默认最多是10条，可以认为是一页的数据，这个数据量是可以控制的</span><br><span class="line">核心代码如下：</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;分页</span><br><span class="line">&#x2F;&#x2F;设置每页的起始位置，默认是0</span><br><span class="line">&#x2F;&#x2F;searchSourceBuilder.from(0);</span><br><span class="line">&#x2F;&#x2F;设置每页的数据量，默认是10</span><br><span class="line">&#x2F;&#x2F;searchSourceBuilder.size(10);</span><br></pre></td></tr></table></figure>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在返回满足条件的结果之前，可以按照指定的要求对数据进行排序，默认是按照搜索条件的匹配度返回数据的。(默认情况下，查询关键字的匹配度越高越靠前)</span><br><span class="line">核心代码如下：</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;排序</span><br><span class="line">&#x2F;&#x2F;按照age字段，倒序排序</span><br><span class="line">&#x2F;&#x2F;searchSourceBuilder.sort(&quot;age&quot;, SortOrder.DESC);</span><br><span class="line">&#x2F;&#x2F;注意：age字段是数字类型，不需要分词，name字段是字符串类型(Text)，默认会被分词，所以不支持排序和聚合操作</span><br><span class="line">&#x2F;&#x2F;如果想要根据这些会被分词的字段进行排序或者聚合，需要指定使用他们的keyword类型，这个类型表示不会对数据分词(ES默认会对字符串类型数据，建立两份索引，一份分词，一份不分词)</span><br><span class="line">&#x2F;&#x2F;searchSourceBuilder.sort(&quot;name.keyword&quot;, SortOrder.DESC);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;keyword类型的特性其实也适用于精确查询的场景，可以在matchQuery中指定字段的keyword类型实现精确查询，不管在建立索引的时候有没有被分词都不影响使用</span><br><span class="line">&#x2F;&#x2F;searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;name.keyword&quot;, &quot;刘德华&quot;));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match实现精确查询</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140026183.png" alt="image-20230614002640823"></p>
<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">针对用户搜索时的关键词，如果匹配到了，最终在页面展现的时候可以标红高亮显示，看起来比较清晰。</span><br><span class="line">设置高亮的核心代码如下：</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;高亮</span><br><span class="line">&#x2F;&#x2F;设置高亮字段</span><br><span class="line">HighlightBuilder highlightBuilder &#x3D; new HighlightBuilder()</span><br><span class="line">        .field(&quot;name&quot;);&#x2F;&#x2F;支持多个高亮字段，使用多个field方法指定即可</span><br><span class="line">&#x2F;&#x2F;设置高亮字段的前缀和后缀内容</span><br><span class="line">highlightBuilder.preTags(&quot;&lt;font color&#x3D;&#39;red&#39;&gt;&quot;);</span><br><span class="line">highlightBuilder.postTags(&quot;&lt;&#x2F;font&gt;&quot;);</span><br><span class="line">searchSourceBuilder.highlighter(highlightBuilder);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">别忘了前面完整代码中，要对高亮字段查询，才会有效果</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140044744.png" alt="image-20230614004401423"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306140043276.png" alt="image-20230614004343078"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">解析高亮内容的核心代码如下：</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;迭代解析具体内容</span><br><span class="line">for (SearchHit hit : searchHits) &#123;</span><br><span class="line">    &#x2F;*String sourceAsString &#x3D; hit.getSourceAsString();</span><br><span class="line">    System.out.println(sourceAsString);*&#x2F;</span><br><span class="line">    Map&lt;String, Object&gt; sourceAsMap &#x3D; hit.getSourceAsMap();</span><br><span class="line">    String name &#x3D; sourceAsMap.get(&quot;name&quot;).toString();</span><br><span class="line">    int age &#x3D; Integer.parseInt(sourceAsMap.get(&quot;age&quot;).toString());</span><br><span class="line">    &#x2F;&#x2F;获取高亮字段内容</span><br><span class="line">    Map&lt;String, HighlightField&gt; highlightFields &#x3D; hit.getHighlightFields();</span><br><span class="line">    &#x2F;&#x2F;获取name字段的高亮内容</span><br><span class="line">    HighlightField highlightField &#x3D; highlightFields.get(&quot;name&quot;);</span><br><span class="line">    if(highlightField!&#x3D;null)&#123;</span><br><span class="line">        Text[] fragments &#x3D; highlightField.getFragments();</span><br><span class="line">        name &#x3D; &quot;&quot;;</span><br><span class="line">        for (Text text : fragments) &#123;</span><br><span class="line">            name +&#x3D; text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;获取最终的结果数据</span><br><span class="line">    System.out.println(name+&quot;---&quot;+age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意：必须要设置查询的字段，否则无法实现高亮。</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;高亮查询name字段</span><br><span class="line">searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;name&quot;,&quot;tom&quot;));</span><br><span class="line">searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;name&quot;,&quot;刘德华&quot;));</span><br></pre></td></tr></table></figure>

<h3 id="评分依据-了解"><a href="#评分依据-了解" class="headerlink" title="评分依据(了解)"></a>评分依据(了解)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ES在返回满足条件的数据的时候，按照搜索条件的匹配度返回数据的，匹配度最高的数据排在最前面，这个匹配度其实就是ES中返回结果中的score字段的值。</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;获取数据的匹配度分值，值越大说明和搜索的关键字匹配度越高</span><br><span class="line">float score &#x3D; hit.getScore();</span><br><span class="line">&#x2F;&#x2F;获取最终的结果数据</span><br><span class="line">System.out.println(name+&quot;---&quot;+age+&quot;---&quot;+score);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">此时，我们搜索name&#x3D;刘华 的数据</span><br><span class="line">searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;name&quot;, &quot;刘华&quot;));</span><br><span class="line"></span><br><span class="line">结果如下：</span><br><span class="line">数据总数：2</span><br><span class="line">&lt;font color&#x3D;&#39;red&#39;&gt;刘&lt;&#x2F;font&gt;德&lt;font color&#x3D;&#39;red&#39;&gt;华&lt;&#x2F;font&gt;---60---2.591636</span><br><span class="line">&lt;font color&#x3D;&#39;red&#39;&gt;刘&lt;&#x2F;font&gt;老二---20---1.0036464</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">可以看到第一条数据的score分值为2.59</span><br><span class="line">第二条数据的score分值为1.00</span><br><span class="line"></span><br><span class="line">score分值具体是如何计算出来的呢？可以通过开启评分依据进行查看详细信息：</span><br><span class="line">首先开启评分依据：</span><br><span class="line">&#x2F;&#x2F;评分依据，true：开启，false：关闭</span><br><span class="line">searchSourceBuilder.explain(true);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">获取评分依据信息：</span><br><span class="line">&#x2F;&#x2F;获取Score的评分依据</span><br><span class="line">Explanation explanation &#x3D; hit.getExplanation();</span><br><span class="line">&#x2F;&#x2F;打印评分依据</span><br><span class="line">if(explanation!&#x3D;null)&#123;</span><br><span class="line">    System.out.println(explanation.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">再执行程序，就可以看到具体的评分依据信息了：</span><br><span class="line">数据总数：2</span><br><span class="line">&lt;font color&#x3D;&#39;red&#39;&gt;刘&lt;&#x2F;font&gt;德&lt;font color&#x3D;&#39;red&#39;&gt;华&lt;&#x2F;font&gt;---60---2.591636</span><br><span class="line">2.591636 &#x3D; sum of:</span><br><span class="line">  1.0036464 &#x3D; weight(name:刘 in 1) [PerFieldSimilarity], result of:</span><br><span class="line">    1.0036464 &#x3D; score(freq&#x3D;1.0), computed as boost * idf * tf from:</span><br><span class="line">      2.2 &#x3D; boost</span><br><span class="line">      1.4552872 &#x3D; idf, computed as log(1 + (N - n + 0.5) &#x2F; (n + 0.5)) from:</span><br><span class="line">        3.0 &#x3D; n, number of documents containing term</span><br><span class="line">        14.0 &#x3D; N, total number of documents with field</span><br><span class="line">      0.3134796 &#x3D; tf, computed as freq &#x2F; (freq + k1 * (1 - b + b * dl &#x2F; avgdl)) from:</span><br><span class="line">        1.0 &#x3D; freq, occurrences of term within document</span><br><span class="line">        1.2 &#x3D; k1, term saturation parameter</span><br><span class="line">        0.75 &#x3D; b, length normalization parameter</span><br><span class="line">        3.0 &#x3D; dl, length of field</span><br><span class="line">        1.4285715 &#x3D; avgdl, average length of field</span><br><span class="line">  1.5879896 &#x3D; weight(name:华 in 1) [PerFieldSimilarity], result of:</span><br><span class="line">    1.5879896 &#x3D; score(freq&#x3D;1.0), computed as boost * idf * tf from:</span><br><span class="line">      2.2 &#x3D; boost</span><br><span class="line">      2.3025851 &#x3D; idf, computed as log(1 + (N - n + 0.5) &#x2F; (n + 0.5)) from:</span><br><span class="line">        1.0 &#x3D; n, number of documents containing term</span><br><span class="line">        14.0 &#x3D; N, total number of documents with field</span><br><span class="line">      0.3134796 &#x3D; tf, computed as freq &#x2F; (freq + k1 * (1 - b + b * dl &#x2F; avgdl)) from:</span><br><span class="line">        1.0 &#x3D; freq, occurrences of term within document</span><br><span class="line">        1.2 &#x3D; k1, term saturation parameter</span><br><span class="line">        0.75 &#x3D; b, length normalization parameter</span><br><span class="line">        3.0 &#x3D; dl, length of field</span><br><span class="line">        1.4285715 &#x3D; avgdl, average length of field</span><br><span class="line"></span><br><span class="line">&lt;font color&#x3D;&#39;red&#39;&gt;刘&lt;&#x2F;font&gt;老二---20---1.0036464</span><br><span class="line">1.0036464 &#x3D; sum of:</span><br><span class="line">  1.0036464 &#x3D; weight(name:刘 in 2) [PerFieldSimilarity], result of:</span><br><span class="line">    1.0036464 &#x3D; score(freq&#x3D;1.0), computed as boost * idf * tf from:</span><br><span class="line">      2.2 &#x3D; boost</span><br><span class="line">      1.4552872 &#x3D; idf, computed as log(1 + (N - n + 0.5) &#x2F; (n + 0.5)) from:</span><br><span class="line">        3.0 &#x3D; n, number of documents containing term</span><br><span class="line">        14.0 &#x3D; N, total number of documents with field</span><br><span class="line">      0.3134796 &#x3D; tf, computed as freq &#x2F; (freq + k1 * (1 - b + b * dl &#x2F; avgdl)) from:</span><br><span class="line">        1.0 &#x3D; freq, occurrences of term within document</span><br><span class="line">        1.2 &#x3D; k1, term saturation parameter</span><br><span class="line">        0.75 &#x3D; b, length normalization parameter</span><br><span class="line">        3.0 &#x3D; dl, length of field</span><br><span class="line">        1.4285715 &#x3D; avgdl, average length of field</span><br></pre></td></tr></table></figure>

<h3 id="ES中分页的性能问题"><a href="#ES中分页的性能问题" class="headerlink" title="ES中分页的性能问题"></a>ES中分页的性能问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在使用ES实现分页查询的时候，不要一次请求过多或者页码过大的结果，这样会对服务器造成很大的压力，因为它们会在返回前排序。</span><br><span class="line">ES是分布式搜索，所以ES客户端的一个查询请求会发送到索引对应的多个分片中，每个分片都会生成自己的排序结果，最后再进行集中排序，以确保最终结果的正确性。</span><br><span class="line"></span><br><span class="line">我们假设在搜索一个拥有5个主分片的索引，当我们请求第一页数据的时候，每个分片产生自己前10名，然后将它们返回给请求节点，然后这个请求节点会将收到的50条结果重新排序以产生最终的前10名。</span><br><span class="line"></span><br><span class="line">现在想象一下我们如果要获得第1,000页的数据，也就是第10,001到第10,010条数据，每一个分片都会先产生自己的前10,010名，然后请求节点统一处理这50,050条数据，最后再丢弃掉其中的50,040条！</span><br><span class="line">现在我们就明白了，在分布式系统中，大页码请求所消耗的系统资源是呈指数式增长的。这也是为什么网络搜索引擎一般不会提供超过1,000条搜索结果的原因。</span><br><span class="line">例如：百度上的效果。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111650965.png" alt="image-20230611165023568"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当然还有一点原因是后面的搜索结果基本上也不是我们想要的数据了，我们在使用搜索引擎的时候，一般只会看第1页和第2页的数据。</span><br></pre></td></tr></table></figure>

<h3 id="aggregations聚合统计"><a href="#aggregations聚合统计" class="headerlink" title="aggregations聚合统计"></a>aggregations聚合统计</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ES中可以实现基于字段进行分组聚合的统计</span><br><span class="line">聚合操作支持count()、sum()、avg()、max()、min()等</span><br><span class="line"></span><br><span class="line">下面来看两个案例</span><br></pre></td></tr></table></figure>

<h4 id="统计相同年龄的学员个数"><a href="#统计相同年龄的学员个数" class="headerlink" title="统计相同年龄的学员个数"></a>统计相同年龄的学员个数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">需求：统计相同年龄的学员个数</span><br><span class="line">数据如下所示：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111657341.png" alt="image-20230611165752222"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">首先在ES中初始化这份数据：</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;2&#39; -d&#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;3&#39; -d&#39;&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;4&#39; -d&#39;&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;5&#39; -d&#39;&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;6&#39; -d&#39;&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聚合统计：统计相同年龄的学员个数</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsAggOp01</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//获取RestClient连接</span></span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata01"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata02"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata03"</span>, <span class="number">9200</span>, <span class="string">"http"</span>)));</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        searchRequest.indices(<span class="string">"stu"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定查询条件</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//指定分组信息，默认是执行count聚合</span></span><br><span class="line">        TermsAggregationBuilder aggregation = AggregationBuilders.terms(<span class="string">"age_term"</span>)</span><br><span class="line">                .field(<span class="string">"age"</span>);</span><br><span class="line">        searchSourceBuilder.aggregation(aggregation);</span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行查询操作</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取分组信息</span></span><br><span class="line">        Terms terms = searchResponse.getAggregations().get(<span class="string">"age_term"</span>);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = terms.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket: buckets) &#123;</span><br><span class="line">            System.out.println(bucket.getKey()+<span class="string">"---"</span>+bucket.getDocCount());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="统计每个学员的总成绩"><a href="#统计每个学员的总成绩" class="headerlink" title="统计每个学员的总成绩"></a>统计每个学员的总成绩</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">需求：统计每个学员的总成绩</span><br><span class="line">数据如下所示：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306111659147.png" alt="image-20230611165858836"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;subject&quot;:&quot;chinese&quot;,&quot;score&quot;:59&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;2&#39; -d&#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;subject&quot;:&quot;math&quot;,&quot;score&quot;:89&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;3&#39; -d&#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;subject&quot;:&quot;chinese&quot;,&quot;score&quot;:78&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;4&#39; -d&#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;subject&quot;:&quot;math&quot;,&quot;score&quot;:85&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;5&#39; -d&#39;&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;subject&quot;:&quot;chinese&quot;,&quot;score&quot;:97&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_doc&#x2F;6&#39; -d&#39;&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;subject&quot;:&quot;math&quot;,&quot;score&quot;:68&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregation;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.Sum;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聚合统计：统计每个学员的总成绩</span></span><br><span class="line"><span class="comment"> * Created by xuwei</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsAggOp02</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//获取RestClient连接</span></span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata01"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata02"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">"bigdata03"</span>, <span class="number">9200</span>, <span class="string">"http"</span>)));</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        searchRequest.indices(<span class="string">"score"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定查询条件</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//指定分组和求sum</span></span><br><span class="line">        TermsAggregationBuilder aggregation = AggregationBuilders.terms(<span class="string">"name_term"</span>)</span><br><span class="line">                .field(<span class="string">"name.keyword"</span>)<span class="comment">//指定分组字段，如果是字符串(Text)类型，则需要指定使用keyword类型</span></span><br><span class="line">                .subAggregation(AggregationBuilders.sum(<span class="string">"sum_score"</span>).field(<span class="string">"score"</span>));<span class="comment">//指定求sum,也支持avg、min、max等操作</span></span><br><span class="line">        searchSourceBuilder.aggregation(aggregation);</span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行查询操作</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取分组信息</span></span><br><span class="line">        Terms terms = searchResponse.getAggregations().get(<span class="string">"name_term"</span>);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = terms.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket: buckets) &#123;</span><br><span class="line">            <span class="comment">//获取sum聚合的结果</span></span><br><span class="line">            Sum sum = bucket.getAggregations().get(<span class="string">"sum_score"</span>);</span><br><span class="line">            System.out.println(bucket.getKey()+<span class="string">"---"</span>+sum.getValue());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="aggregations获取所有分组数据"><a href="#aggregations获取所有分组数据" class="headerlink" title="aggregations获取所有分组数据"></a>aggregations获取所有分组数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">默认情况下，ES只会返回10个分组的数据，如果分组之后的结果超过了10组，如何解决？</span><br><span class="line"></span><br><span class="line">可以通过在聚合操作中使用size方法进行设置，获取指定个数的数据组或者获取所有的数据组。</span><br><span class="line">在案例1的基础上再初始化一批测试数据：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;61&#39; -d&#39;&#123;&quot;name&quot;:&quot;s1&quot;,&quot;age&quot;:31&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;62&#39; -d&#39;&#123;&quot;name&quot;:&quot;s2&quot;,&quot;age&quot;:32&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;63&#39; -d&#39;&#123;&quot;name&quot;:&quot;s3&quot;,&quot;age&quot;:33&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;64&#39; -d&#39;&#123;&quot;name&quot;:&quot;s4&quot;,&quot;age&quot;:34&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;65&#39; -d&#39;&#123;&quot;name&quot;:&quot;s5&quot;,&quot;age&quot;:35&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;66&#39; -d&#39;&#123;&quot;name&quot;:&quot;s6&quot;,&quot;age&quot;:36&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;67&#39; -d&#39;&#123;&quot;name&quot;:&quot;s7&quot;,&quot;age&quot;:37&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;68&#39; -d&#39;&#123;&quot;name&quot;:&quot;s8&quot;,&quot;age&quot;:38&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_doc&#x2F;69&#39; -d&#39;&#123;&quot;name&quot;:&quot;s9&quot;,&quot;age&quot;:39&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">支持案例1的代码，查看返回的分组个数：</span><br><span class="line">18---3</span><br><span class="line">29---2</span><br><span class="line">19---1</span><br><span class="line">31---1</span><br><span class="line">32---1</span><br><span class="line">33---1</span><br><span class="line">34---1</span><br><span class="line">35---1</span><br><span class="line">36---1</span><br><span class="line">37---1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">发现结果中返回的分组个数是10个，没有全部都显示出来，这个其实和分页也没关系，尝试增加分页的代码发现也是无效的：</span><br><span class="line">&#x2F;&#x2F;增加分页参数，注意：分页参数针对分组数据是无效的。</span><br><span class="line">searchSourceBuilder.from(0).size(20);</span><br><span class="line"></span><br><span class="line">执行案例1的代码，结果发现还是10条数据。</span><br><span class="line">18---3</span><br><span class="line">29---2</span><br><span class="line">19---1</span><br><span class="line">31---1</span><br><span class="line">32---1</span><br><span class="line">33---1</span><br><span class="line">34---1</span><br><span class="line">35---1</span><br><span class="line">36---1</span><br><span class="line">37---1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通过在聚合操作上使用size方法进行设置：</span><br><span class="line">TermsAggregationBuilder aggregation &#x3D; AggregationBuilders.terms(&quot;age_term&quot;)</span><br><span class="line">        .field(&quot;age&quot;)</span><br><span class="line">        .size(20);&#x2F;&#x2F;获取指定分组个数的数据</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">执行案例1的代码：</span><br><span class="line">18---3</span><br><span class="line">29---2</span><br><span class="line">19---1</span><br><span class="line">31---1</span><br><span class="line">32---1</span><br><span class="line">33---1</span><br><span class="line">34---1</span><br><span class="line">35---1</span><br><span class="line">36---1</span><br><span class="line">37---1</span><br><span class="line">38---1</span><br><span class="line">39---1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时可以获取到所有分组的数据，因为结果一共有12个分组，在代码中通过size设置最多可以获取到20个分组的数据。</span><br><span class="line"></span><br><span class="line">如果前期不确定到底有多少个分组的数据，还想获取到所有分组的数据，此时可以在size中设置一个Integer的最大值，这样基本上就没什么问题了，但是注意：如果最后的分组个数太多，会给ES造成比较大的压力，所以官方在这做了限制，让用户手工指定获取多少分组的数据。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TermsAggregationBuilder aggregation &#x3D; AggregationBuilders.terms(&quot;age_term&quot;)</span><br><span class="line">        .field(&quot;age&quot;)</span><br><span class="line">        .size(Integer.MAX_VALUE);&#x2F;&#x2F;获取指定分组个数的数据</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：在ES7.x版本之前，想要获取所有的分组数据，只需要在size中指定参数为0即可。现在ES7.x版本不支持这个数值了。</span><br></pre></td></tr></table></figure>

<h2 id="5-Elasticsearch的高级特性"><a href="#5-Elasticsearch的高级特性" class="headerlink" title="5 Elasticsearch的高级特性"></a>5 Elasticsearch的高级特性</h2><h3 id="ES中的settings"><a href="#ES中的settings" class="headerlink" title="ES中的settings"></a>ES中的settings</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ES中的settings可以设置索引库的一些配置信息，主要是针对分片数量和副本数量</span><br><span class="line">其中分片数量只能在一开始创建索引库的时候指定，后期不能修改。</span><br><span class="line">副本数量可以随时修改。</span><br><span class="line"></span><br><span class="line">首先查看一下ES中目前已有的索引库的默认settings信息。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;emp&#x2F;_settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;emp&quot; : &#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;_tier_preference&quot; : &quot;data_content&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;provided_name&quot; : &quot;emp&quot;,</span><br><span class="line">        &quot;creation_date&quot; : &quot;1803648122805&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;uuid&quot; : &quot;kBpwz6kAQ2eS0uCISVcaew&quot;,</span><br><span class="line">        &quot;version&quot; : &#123;</span><br><span class="line">          &quot;created&quot; : &quot;7130499&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">此时分片和副本数量默认都是1。</span><br><span class="line">尝试手工指定分片和副本数量。</span><br><span class="line">针对不存在的索引，在创建的时候可以同时指定分片(5)和副本(1)数量：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test1&#x2F;&#39; -d&#39;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:5,&quot;number_of_replicas&quot;:1&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">查看这个索引库的settings信息：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test1&#x2F;_settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test1&quot; : &#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;_tier_preference&quot; : &quot;data_content&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;5&quot;,</span><br><span class="line">        &quot;provided_name&quot; : &quot;test1&quot;,</span><br><span class="line">        &quot;creation_date&quot; : &quot;1804844538706&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;uuid&quot; : &quot;WEUwvKVoRzWfna-KFntdqQ&quot;,</span><br><span class="line">        &quot;version&quot; : &#123;</span><br><span class="line">          &quot;created&quot; : &quot;7130499&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">针对已存在的索引，只能通过settings指定副本信息。</span><br><span class="line">将刚才创建的索引的副本数量修改为0。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test1&#x2F;_settings&#39; -d&#39;&#123;&quot;index&quot;:&#123;&quot;number_of_replicas&quot;:0&#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">查看这个索引库目前的settings信息：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test1&#x2F;_settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test1&quot; : &#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;_tier_preference&quot; : &quot;data_content&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;5&quot;,</span><br><span class="line">        &quot;provided_name&quot; : &quot;test1&quot;,</span><br><span class="line">        &quot;creation_date&quot; : &quot;1804844538706&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;0&quot;,</span><br><span class="line">        &quot;uuid&quot; : &quot;WEUwvKVoRzWfna-KFntdqQ&quot;,</span><br><span class="line">        &quot;version&quot; : &#123;</span><br><span class="line">          &quot;created&quot; : &quot;7130499&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES中的mapping"><a href="#ES中的mapping" class="headerlink" title="ES中的mapping"></a>ES中的mapping</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mapping表示索引库中数据的字段类型信息，类似于MySQL中的表结构信息。</span><br><span class="line"></span><br><span class="line">一般不需要手工指定mapping，因为ES会自动根据数据格式识别它的类型</span><br><span class="line"></span><br><span class="line">如果你需要对某些字段添加特殊属性（例如：指定分词器），就必须手工指定字段的mapping。</span><br><span class="line"></span><br><span class="line">下面先来看一下ES中的常用数据类型：</span><br></pre></td></tr></table></figure>

<h4 id="ES中的常用数据类型"><a href="#ES中的常用数据类型" class="headerlink" title="ES中的常用数据类型"></a>ES中的常用数据类型</h4><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112219264.png" alt="ES中的常用数据类型"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">字符串：支持text和keyword类型</span><br><span class="line">text类型支持分词，支持模糊、精确查询，但是不支持聚合和排序操作，text类型不限制存储的内容长度，适合大字段存储。</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;text.html</span><br><span class="line"></span><br><span class="line">keyword类型不支持分词，会直接对数据建立索引，支持模糊、精确查询，支持聚合和排序操作。keyword类型最大支持存储内容长度为32766个UTF-8类型的字符,可以通过设置ignore_above参数指定某个字段最大支持的字符长度，超过给定长度后的数据将不被索引，此时就无法通过termQuery精确查询返回结果了。keyword类型适合存储手机号、姓名等不需要分词的数据。</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;keyword.html</span><br><span class="line"></span><br><span class="line">数字：最常用的就是long和double了，整数使用long、小数使用double。当然也支持integer、short、byte、float这些数据类型。</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;number.html</span><br><span class="line"></span><br><span class="line">日期：最常用的就是date类型了，date类型可以支持到毫秒，如果特殊情况下需要精确到纳秒需要使用date_nanos这个类型。</span><br><span class="line">其中date日期类型可以自定义日期格式，通过format参数指定：</span><br><span class="line">&#123;“type”:“date”,“format”:“yyyy-MM-dd”&#125;</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;date.html</span><br><span class="line"></span><br><span class="line">布尔型：支持true或者false。</span><br><span class="line"></span><br><span class="line">二进制：该字段存储编码为Base64字符串的二进制值。如果想要存储图片，可以存储图片地址，或者图片本身，存储图片本身的话就需要获取图片的二进制值进行存储了。</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;binary.html</span><br></pre></td></tr></table></figure>

<h4 id="查看mapping"><a href="#查看mapping" class="headerlink" title="查看mapping"></a>查看mapping</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ES中还支持一些其他数据类型，感兴趣的话可以到文档里面看一下：</span><br><span class="line">https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.13&#x2F;mapping-types.html</span><br><span class="line"></span><br><span class="line">下面查询一下目前已有的索引库score的mapping信息：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;score&#x2F;_mapping?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;score&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;score&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;subject&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过返回的mapping信息可以看到score这个索引库里面有3个字段，name、score和subject。</span><br><span class="line">1：name是text类型，其中还通过fields属性指定了一个keyword类型，表示name字段会按照text类型和keyword类型存储2份。</span><br><span class="line"></span><br><span class="line">针对fields属性的解释官网里面有详细介绍，见下图：</span><br><span class="line">大致意思是说，一个字段可以设置多种数据类型，这样ES会按照多种数据类型的特性对这个字段进行存储和建立索引。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112222083.png" alt="image-20230611222209691"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;ignore_above&quot; : 256，表示keyword类型最大支持的字符串长度是256。</span><br><span class="line">ES默认会把字符串类型的数据同时指定text类型和keyword类型。</span><br><span class="line">想要实现分词检索的时候需要使用text类型，在代码层面直接指定这个name字段就表示使用text类型。</span><br><span class="line">想要实现精确查询的时候需要使用keyword类型，在代码层面指定name.keyword表示使用name的keyword类型。</span><br><span class="line"></span><br><span class="line">其实前面我们在讲排序的时候也用到了这个keyword类型的特性，因为直接指定name字段会使用text类型，text类型不支持排序和聚合，所以使用的是name.keyword。</span><br><span class="line"></span><br><span class="line">2：score是long类型，整数默认会被识别为long类型。</span><br><span class="line">3：subject也是text类型，和name是一样的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：ES 7.x版本之前字符串默认只会被识别为text类型，不会附加一个keyword类型。</span><br></pre></td></tr></table></figure>

<h4 id="手工创建mapping"><a href="#手工创建mapping" class="headerlink" title="手工创建mapping"></a>手工创建mapping</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">下面我们首先操作一个不存在的索引库的mapping信息：</span><br><span class="line">指定name为text类型(手工指定字符串类型时，就不会再支持keyword类型了)，并且使用ik分词器。</span><br><span class="line">age为integer类型。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test2&#39; -d&#39;&#123;&quot;mappings&quot;:&#123;&quot;properties&quot;:&#123;&quot;name&quot;:&#123;&quot;type&quot;:&quot;text&quot;,&quot;analyzer&quot;: &quot;ik_max_word&quot;&#125;,&quot;age&quot;:&#123;&quot;type&quot;:&quot;integer&quot;&#125;&#125;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">查看这个索引库的mapping信息。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test2&#x2F;_mapping?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test2&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot; : &quot;ik_max_word&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新mapping"><a href="#更新mapping" class="headerlink" title="更新mapping"></a>更新mapping</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在这个已存在的索引库中增加mapping信息。</span><br><span class="line"></span><br><span class="line">注意：只能新增字段，不能修改已有字段的类型，否则会报错。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test2&#x2F;_mapping&#39; -d&#39;&#123;&quot;properties&quot;:&#123;&quot;age&quot;:&#123;&quot;type&quot;:&quot;long&quot;&#125;&#125;&#125;&#39;</span><br><span class="line">&#123;&quot;error&quot;:&#123;&quot;root_cause&quot;:[&#123;&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;mapper [age] cannot be changed from type [integer] to [long]&quot;&#125;],&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;mapper [age] cannot be changed from type [integer] to [long]&quot;&#125;,&quot;status&quot;:400&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可以假设一下，假设支持修改已有字段的类型，之前name是text类型，如果我修改为long类型，这样就会出现矛盾了，所以ES不支持修改已有字段的类型。</span><br><span class="line">在已存在的索引库中增加一个flag字段，类型为boolean类型</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test2&#x2F;_mapping&#39; -d&#39;&#123;&quot;properties&quot;:&#123;&quot;flag&quot;:&#123;&quot;type&quot;:&quot;boolean&quot;&#125;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">查看索引库的最新mapping信息。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test2&#x2F;_mapping?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test2&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;flag&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot; : &quot;ik_max_word&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES的偏好查询-分片查询方式"><a href="#ES的偏好查询-分片查询方式" class="headerlink" title="ES的偏好查询(分片查询方式)"></a>ES的偏好查询(分片查询方式)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ES中的索引数据最终都是存储在分片里面的，分片有多个，并且分片还分为主分片和副本分片。</span><br><span class="line"></span><br><span class="line">ES在查询索引库中的数据时，具体是到哪些分片里面查询数据呢？</span><br><span class="line"></span><br><span class="line">在具体分析这个之前，我们先分析一下ES的分布式查询过程：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112228956.png" alt="image-20230611222857840"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这个表示是一个3个节点的ES集群，集群内有一个索引库，索引库里面有P0和P1两个主分片，这两个主分片分别都有2个副本分片，R0和R1。</span><br><span class="line"></span><br><span class="line">查询过程主要包含三个步骤：</span><br><span class="line"></span><br><span class="line">1.客户端发送一个查询请求到Node 3，Node 3会创建一个空优先队列，主要为了存储结果数据。</span><br><span class="line">2.Node 3将查询请求转发到索引的主分片或副本分片中。每个分片在本地执行查询并将查询到的结果添加到本地的有序优先队列中。</span><br><span class="line">具体这里面Node 3将查询请求转发到索引的哪个分片中，可以是随机的，也可以由我们程序员来控制。默认是randomize across shards：表示随机从分片中取数据。</span><br><span class="line">3.每个分片返回各自优先队列中所有文档的ID和排序值给到Node 3，Node 3合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注意：当客户端的一个搜索请求被发送到某个节点时，这个节点就变成了协调节点。 这个节点的任务是广播查询请求到所有相关分片，并将它们查询到的结果整合成全局排序后的结果集合，这个结果集合会返回给客户端。</span><br><span class="line">这里面的Node3节点其实就是协调节点。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">接下来我们来具体分析一下如何控制查询请求到分片之间的分发规则：</span><br><span class="line">先创建一个具有5个分片，0个副本的索引库</span><br><span class="line">分片太少不好验证效果。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;&#39; -d&#39;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:5,&quot;number_of_replicas&quot;:0&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112239645.png" alt="image-20230611223918180"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在索引库中初始化一批测试数据：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;2&#39; -d&#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;3&#39; -d&#39;&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;4&#39; -d&#39;&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;5&#39; -d&#39;&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;pre&#x2F;_doc&#x2F;6&#39; -d&#39;&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这些测试数据在索引库的分片中的分布情况是这样的：</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242368.png" alt="image-20230611224210088"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242380.png" alt="image-20230611224227978"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112242573.png" alt="image-20230611224242367"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在代码层面通过preference(...)来设置具体的分片查询方式：</span><br><span class="line">&#x2F;&#x2F;指定分片查询方式</span><br><span class="line">searchRequest.preference();&#x2F;&#x2F;默认随机</span><br></pre></td></tr></table></figure>

<h4 id="local"><a href="#local" class="headerlink" title="_local"></a>_local</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">表示查询操作会优先在本地节点(协调节点)的分片中查询，没有的话再到其它节点中查询。</span><br><span class="line">这种方式可以提高查询性能，假设一个索引库有5个分片，这5个分片都在Node3节点里面，客户端的查询请求正好也分配到了Node3节点上，这样在查询这5个分片的数据就都在Node3节点上进行查询了，每个分片返回结果数据的时候就不需要跨网络传输数据了，可以节省网络传输的时间。</span><br><span class="line">但是这种方式也会有弊端，如果这个节点在某一时刻接收到的查询请求比较多的时候，会对当前节点造成比较大的压力，因为这些查询请求都会优先查询这个节点上的分片数据。</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_local&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">此时是可以查到所有数据的。</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure>



<h4 id="only-local"><a href="#only-local" class="headerlink" title="_only_local"></a>_only_local</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">表示查询只会在本地节点的分片中查询。</span><br><span class="line">这种方式只会在查询请求所在的节点上进行查询，查询速度比较快，但是数据可能不完整，因为我们无法保证索引库的分片正好都在这一个节点上。</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_only_local&quot;);</span><br><span class="line"></span><br><span class="line">数据总数：2</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br><span class="line"></span><br><span class="line">注意：大家在自己本地试验的时候，结果和我的可能不一样，因为请求不一定会分到哪一个节点上面。</span><br></pre></td></tr></table></figure>



<h4 id="only-nodes"><a href="#only-nodes" class="headerlink" title="_only_nodes"></a>_only_nodes</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">表示只在指定的节点中查询。</span><br><span class="line">可以控制只在指定的节点中查询某一个索引库的分片信息。</span><br><span class="line">但是注意：这里指定的节点列表里面，必须包含指定索引库的所有分片，如果从这些节点列表中获取到的索引库的分片个数不完整，程序会报错。</span><br><span class="line">这种情况适用于在某种特殊情况下，集群中的个别节点压力比较大，短时间内又无法恢复，那么我们在查询的时候可以规避掉这些节点，只选择一些正常的节点进行查询。</span><br><span class="line">前提是索引库的分片有副本，如果没有副本，只有一个主分片，就算主分片的节点压力比较大，那也只能查询这个节点了。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在这里面需要指定节点ID，节点ID应该如何获取呢？</span><br><span class="line"></span><br><span class="line">通过ES中针对节点信息的RestAPI可以快速获取：</span><br><span class="line">http:&#x2F;&#x2F;bigdata01:9200&#x2F;_nodes?pretty</span><br><span class="line">返回的信息有点多，建议在浏览器中访问。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112251246.png" alt="image-20230611225100064"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">最终可以获取到三个节点的ID：</span><br><span class="line"></span><br><span class="line">注意：这个节点ID是集群随机生成的一个字符串，所以每个人的集群节点ID都是不一样的。</span><br><span class="line"></span><br><span class="line">目前这个索引库的分片分布在3个节点上</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112253294.png" alt="image-20230611225316854"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在这里可以指定一个或者多个节点ID，多个节点ID之间使用逗号分割即可</span><br><span class="line">首先指定bigdata01节点的ID</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_only_nodes:KzjZauWGRt6hJRKTgZ7BcA&quot;);</span><br><span class="line"></span><br><span class="line">注意：执行这个查询会报错，错误提示找不到pre索引库的2号分片的数据，2号分片是在bigdata03节点上</span><br><span class="line">&#123;&quot;error&quot;:&#123;&quot;root_cause&quot;:[&#123;&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;no data nodes with criteria [l7H4B3pdRm6ckBWd7ODS5Q] found for shard: [pre][2]&quot;&#125;],&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;no data nodes with criteria [l7H4B3pdRm6ckBWd7ODS5Q] found for shard: [pre][2]&quot;&#125;,&quot;status&quot;:400&#125;</span><br><span class="line"></span><br><span class="line">再把bigdata03的节点ID添加到里面</span><br><span class="line">searchRequest.preference(&quot;_only_nodes:l7H4B3pdRm6ckBWd7ODS5Q,KzjZauWGRt6hJRKTgZ7BcA&quot;);</span><br><span class="line">执行发现还是会报错，提示找不到pre索引库的3号分片，3号分片是在bigdata02节点上的</span><br><span class="line">&#123;&quot;error&quot;:&#123;&quot;root_cause&quot;:[&#123;&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;no data nodes with criterion [l7H4B3pdRm6ckBWd7ODS5Q,KzjZauWGRt6hJRKTgZ7BcA] found for shard: [pre][3]&quot;&#125;],&quot;type&quot;:&quot;illegal_argument_exception&quot;,&quot;reason&quot;:&quot;no data nodes with criterion [l7H4B3pdRm6ckBWd7ODS5Q,KzjZauWGRt6hJRKTgZ7BcA] found for shard: [pre][3]&quot;&#125;,&quot;status&quot;:400&#125;</span><br><span class="line"></span><br><span class="line">再把bigdata02的节点ID添加到里面</span><br><span class="line">searchRequest.preference(&quot;_only_nodes:l7H4B3pdRm6ckBWd7ODS5Q,KzjZauWGRt6hJRKTgZ7BcA,nS_RptvTQDuRYTplia24WA&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">此时执行就可以正常执行了：</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：在ES7.x版本之前，_only_nodes后面可以只指定某一个索引库部分分片所在的节点信息，如果不完整，不会报错，只是返回的数据是不完整的。</span><br></pre></td></tr></table></figure>

<h4 id="prefer-nodes"><a href="#prefer-nodes" class="headerlink" title="_prefer_nodes"></a>_prefer_nodes</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">表示优先在指定的节点上查询。</span><br><span class="line">优先在指定的节点上查询索引库分片中的数据</span><br><span class="line">如果某个节点比较空闲，尽可能的多在这个节点上查询，减轻集群中其他节点的压力，尽可能实现负载均衡。</span><br><span class="line">这里可以指定一个或者多个节点</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_prefer_nodes:l7H4B3pdRm6ckBWd7ODS5Q&quot;);</span><br><span class="line"></span><br><span class="line">最终可以查询到完整的结果：</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure>

<h4 id="shards-常用"><a href="#shards-常用" class="headerlink" title="_shards(常用)"></a>_shards(常用)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">表示只查询索引库中指定分片的数据。</span><br><span class="line">在查询的时候可以指定只查询索引库中指定分片中的数据，其实有点类似于Hive中的分区表的特性。</span><br><span class="line">如果我们提前已经知道需要查询的数据都在这个索引库的哪些分片里面，在这里提前指定对应分片编号，这样查询请求就只会到这些分片里面进行查询，这样可以提高查询效率，减轻集群压力。</span><br><span class="line">可以指定一个或者多个分片编号，分片编号是从0开始的。</span><br><span class="line"></span><br><span class="line">searchRequest.preference(&quot;_shards:0,1&quot;);</span><br><span class="line"></span><br><span class="line">最终可以看到这两个分区里面的数据：</span><br><span class="line">数据总数：3</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那我们如何控制将某一类型的数据添加到指定分片呢？</span><br><span class="line"></span><br><span class="line">不要着急，一会就会讲到。</span><br></pre></td></tr></table></figure>

<h4 id="custom-string"><a href="#custom-string" class="headerlink" title="custom-string"></a>custom-string</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">自定义一个参数，不能以下划线(_)开头。</span><br><span class="line">有时候我们希望多次查询使用索引库中相同的分片，因为分片会有副本，正常情况下如果不做控制，那么两次查询的时候使用的分片可能会不一样，第一次查询可能使用的是主分片，第二次查询可能使用的是副本分片。</span><br><span class="line"></span><br><span class="line">大家可能会有疑问，不管是主分片，还是副本分片，这些分片里面的数据是完全一样的，就算两次查询使用的不是相同分片又会有什么问题吗？</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">会有问题的！如果searchType使用的是QUERY_THEN_FETCH，此时分片里面的数据在计算打分依据的时候是根据当前节点里面的词频和文档频率，两次查询使用的分片不是同一个，这样就会导致在计算打分依据的时候使用的样本不一致，最终导致两次相同的查询条件返回的结果不一样。</span><br><span class="line">当然了，如果你使用的是DFS_QUERY_THEN_FETCH就不会有这个问题了，但是DFS_QUERY_THEN_FETCH对性能损耗会大一些，所以并不是所有情况下都使用这种searchType。</span><br><span class="line"></span><br><span class="line">通过自定义参数的设置，只要两次查询使用的自定义参数是同一个，这样就可以保证这两次查询使用的分片是一样的，那么这两次查询的结果肯定是一样的。</span><br><span class="line"></span><br><span class="line">注意：自定义参数不能以_开头。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">searchRequest.preference(&quot;abc&quot;);&#x2F;&#x2F;自定义参数</span><br><span class="line"></span><br><span class="line">查询到的结果还是完整的。</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES中的routing路由功能"><a href="#ES中的routing路由功能" class="headerlink" title="ES中的routing路由功能"></a>ES中的routing路由功能</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ES在添加数据时，会根据id或者routing参数进行hash，得到hash值再与该索引库的分片数量取模，得到的值即为存入的分片编号</span><br><span class="line"></span><br><span class="line">如果多条数据使用相同的routing，那么最终计算出来的分片编号都是一样的，那么这些数据就可以存储到相同的分片里面了。</span><br><span class="line"></span><br><span class="line">后期查询的只需要到指定分片中查询即可，可以显著提高查询性能。</span><br><span class="line"></span><br><span class="line">如果在面试的时候面试官问你如何在ES中实现极速查询，其实就是问这个routing路由功能的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下面来演示一下：</span><br><span class="line">创建一个新的索引库，指定5个分片，0个副本。</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;&#39; -d&#39;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:5,&quot;number_of_replicas&quot;:0&#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">初始化数据：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;1?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;2?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;3?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;4?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;5?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;rout&#x2F;_doc&#x2F;6?routing&#x3D;class1&#39; -d&#39;&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">如果是使用的JavaAPI，那么需要通过使用routing函数指定。</span><br><span class="line"></span><br><span class="line">private static void addIndexByJson(RestHighLevelClient client) throws IOException &#123;</span><br><span class="line">    IndexRequest request &#x3D; new IndexRequest(&quot;emp&quot;);</span><br><span class="line">    request.id(&quot;10&quot;);</span><br><span class="line">    String jsonString &#x3D; &quot;&#123;&quot; +</span><br><span class="line">            &quot;\&quot;name\&quot;:\&quot;jessic\&quot;,&quot; +</span><br><span class="line">            &quot;\&quot;age\&quot;:20&quot; +</span><br><span class="line">            &quot;&#125;&quot;;</span><br><span class="line">    request.source(jsonString, XContentType.JSON);</span><br><span class="line">    request.routing(&quot;class1&quot;);</span><br><span class="line">    &#x2F;&#x2F;执行</span><br><span class="line">    client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看数据在分片中的分布情况，发现所有数据都在0号分片里面，说明routing参数生效了。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112320577.png" alt="image-20230611232004430"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">通过代码查询的时候，可以通过偏好查询指定只查询0号分片里面的数据。</span><br><span class="line"></span><br><span class="line">SearchRequest searchRequest &#x3D; new SearchRequest();</span><br><span class="line">searchRequest.indices(&quot;rout&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;指定分片查询方式</span><br><span class="line">searchRequest.preference(&quot;_shards:0&quot;);</span><br><span class="line"></span><br><span class="line">这样就可以查看所有的数据：</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">通过偏好查询中的_shard手工指定分片编号在使用的时候不太友好，需要我们单独维护一份数据和分片之间的关系，比较麻烦。</span><br><span class="line">还有一种比较简单常用的方式是在查询的时候设置相同的路由参数，这样就可以快速查询到使用这个路由参数添加的数据了。</span><br><span class="line">底层其实是会计算这个路由参数对应的分片编号，最终到指定的分片中查询数据。</span><br><span class="line"></span><br><span class="line">SearchRequest searchRequest &#x3D; new SearchRequest();</span><br><span class="line">&#x2F;&#x2F;指定索引库，支持指定一个或者多个，也支持通配符，例如：user*</span><br><span class="line">searchRequest.indices(&quot;rout&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;指定分片查询方式</span><br><span class="line">&#x2F;&#x2F;searchRequest.preference(&quot;_shards:0&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;指定路由参数</span><br><span class="line">searchRequest.routing(&quot;class1&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">结果如下</span><br><span class="line">数据总数：6</span><br><span class="line">&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:29&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jessica&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;dave&quot;,&quot;age&quot;:19&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lilei&quot;,&quot;age&quot;:18&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lili&quot;,&quot;age&quot;:29&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">我们把routing参数修改一下，改为class2</span><br><span class="line">&#x2F;&#x2F;指定路由参数</span><br><span class="line">searchRequest.routing(&quot;class2&quot;);</span><br><span class="line"></span><br><span class="line">此时结果如下：</span><br><span class="line">数据总数：0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">从这可以看出来，这个routing参数确实生效了。</span><br><span class="line"></span><br><span class="line">注意：routing机制使用不好可能会导致数据倾斜，就是有的分片里面数据很多，有的分片里面数据很少。</span><br></pre></td></tr></table></figure>

<h3 id="ES的索引库模板-了解"><a href="#ES的索引库模板-了解" class="headerlink" title="ES的索引库模板(了解)"></a>ES的索引库模板(了解)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在实际工作中针对一批大量数据存储的时候需要使用多个索引库，如果手工指定每个索引库的配置信息的话就很麻烦了。</span><br><span class="line">配置信息其实主要就是settings和mapping。</span><br><span class="line">可以通过提前创建一个索引库模板，后期在创建索引库的时候，只要索引库的命名符合一定的要求就可以直接套用模板中的配置。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">下面看一个案例：</span><br><span class="line">首先创建两个索引库模板：</span><br><span class="line">第一个索引库模板：</span><br><span class="line">[root@bigdata01 ~]#curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_template&#x2F;t_1&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;template&quot; : &quot;*&quot;,</span><br><span class="line">    &quot;order&quot; : 0,</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;properties&quot;:&#123;</span><br><span class="line">            &quot;name&quot;:&#123;&quot;type&quot;:&quot;text&quot;&#125;,</span><br><span class="line">            &quot;age&quot;:&#123;&quot;type&quot;:&quot;integer&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">第二个索引库模板：</span><br><span class="line">[root@bigdata01 ~]#curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_template&#x2F;t_2&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;template&quot; : &quot;te*&quot;,</span><br><span class="line">    &quot;order&quot; : 1,</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;properties&quot;:&#123;</span><br><span class="line">            &quot;name&quot;:&#123;&quot;type&quot;:&quot;text&quot;&#125;,</span><br><span class="line">            &quot;age&quot;:&#123;&quot;type&quot;:&quot;long&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">注意：order值大的模板内容会覆盖order值小的。</span><br><span class="line"></span><br><span class="line">第一个索引库模板默认会匹配所有的索引库，第二个索引库模板只会匹配索引库名称以te开头的索引库，通过template属性配置的。</span><br><span class="line">如果我们创建的索引库名称满足第二个就会使用第二个模板，不满足的话才会使用第一个模板。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下面创建一个索引库，索引库名称为：test10</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl  -XPUT &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;test10&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">查看索引库test10的setting和mapping信息。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test10&#x2F;_settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test10&quot; : &#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;_tier_preference&quot; : &quot;data_content&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;provided_name&quot; : &quot;test10&quot;,</span><br><span class="line">        &quot;creation_date&quot; : &quot;1804935156129&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;uuid&quot; : &quot;iJLdIRwQSpagzEtIu0LDEw&quot;,</span><br><span class="line">        &quot;version&quot; : &#123;</span><br><span class="line">          &quot;created&quot; : &quot;7130499&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;test10&#x2F;_mapping?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test10&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">接下来再创建一个索引库，索引库名称为hello</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl  -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;hello&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;hello&#x2F;_settings?pretty&#39; </span><br><span class="line">&#123;</span><br><span class="line">  &quot;hello&quot; : &#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;_tier_preference&quot; : &quot;data_content&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;provided_name&quot; : &quot;hello&quot;,</span><br><span class="line">        &quot;creation_date&quot; : &quot;1804935301339&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;uuid&quot; : &quot;xkg-XXSQSHKcJ_5nxyTPTQ&quot;,</span><br><span class="line">        &quot;version&quot; : &#123;</span><br><span class="line">          &quot;created&quot; : &quot;7130499&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;hello&#x2F;_mapping?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;hello&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">通过结果可以看出来hello这个索引库使用到了第一个索引库模板。</span><br><span class="line"></span><br><span class="line">后期想要查看索引库模板内容可以这样查看：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_template&#x2F;t_*?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;t_1&quot; : &#123;</span><br><span class="line">    &quot;order&quot; : 0,</span><br><span class="line">    &quot;index_patterns&quot; : [</span><br><span class="line">      &quot;*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;2&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot; : &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;t_2&quot; : &#123;</span><br><span class="line">    &quot;order&quot; : 1,</span><br><span class="line">    &quot;index_patterns&quot; : [</span><br><span class="line">      &quot;te*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot; : &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">想要删除索引库模板可以这样做：</span><br><span class="line">[root@bigdata01 ~]# curl -XDELETE &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_template&#x2F;t_2&#39;</span><br></pre></td></tr></table></figure>

<h3 id="ES的索引库别名-了解"><a href="#ES的索引库别名-了解" class="headerlink" title="ES的索引库别名(了解)"></a>ES的索引库别名(了解)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在工作中使用ES收集应用的运行日志，每个星期创建一个索引库，这样时间长了就会创建很多的索引库，操作和管理的时候很不方便。</span><br><span class="line">由于新增索引数据只会操作当前这个星期的索引库，所以为了使用方便，我们就创建了两个索引库别名：curr_week和last_3_month。</span><br><span class="line"></span><br><span class="line">-curr_week：这个别名指向当前这个星期的索引库，新增数据使用这个索引库别名。</span><br><span class="line">-last_3_month：这个别名指向最近三个月的所有索引库，因为我们的需求是需要查询最近三个月的日志信息。</span><br><span class="line"></span><br><span class="line">后期只需要修改这两个别名和索引库之间的指向关系即可，应用层代码不需要任何改动。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">下面来演示一下这个案例：</span><br><span class="line">假设ES已经收集了一段时间的日志数据，每一星期都会创建一个索引库，所以目前创建了4个索引库：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;&#39; </span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260308&#x2F;&#39; </span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260315&#x2F;&#39; </span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260322&#x2F;&#39; </span><br><span class="line"></span><br><span class="line">分别向每个索引库里面初始化1条测试数据:</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;log&quot;:&quot;info-&gt;20260301&quot;&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260308&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;log&quot;:&quot;info-&gt;20260308&quot;&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260315&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;log&quot;:&quot;info-&gt;20260315&quot;&#125;&#39;</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260322&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;log&quot;:&quot;info-&gt;20260322&quot;&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">为了使用方便，我们创建了两个索引库别名：curr_week和last_3_month。</span><br><span class="line">curr_week指向最新的索引库：log_20260322</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_aliases&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260322&quot;, &quot;alias&quot; : &quot;curr_week&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">last_3_month指向之前3个月内的索引库：</span><br><span class="line">可以同时增加多个索引别名。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_aliases&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260301&quot;, &quot;alias&quot; : &quot;last_3_month&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260308&quot;, &quot;alias&quot; : &quot;last_3_month&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260315&quot;, &quot;alias&quot; : &quot;last_3_month&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">以后使用的时候，想要操作当前星期内的数据就使用curr_week这个索引库别名就行了。</span><br><span class="line">查询一下curr_week里面的数据：</span><br><span class="line">这里面就1条数据，和使用索引库log_20260322查询的结果是一样的。</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;curr_week&#x2F;_search?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 987,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 2,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;log_20260322&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;log&quot; : &quot;info-&gt;20260322&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">再使用last_3_month查询一下数据：</span><br><span class="line">这里面返回了log_20260301、log_20260308和log_20260315这3个索引库里面的数据。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;last_3_month&#x2F;_search?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 73,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 6,</span><br><span class="line">    &quot;successful&quot; : 6,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 3,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;log_20260301&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;log&quot; : &quot;info-&gt;20260301&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;log_20260308&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;log&quot; : &quot;info-&gt;20260308&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;log_20260315&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;log&quot; : &quot;info-&gt;20260315&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">过了一个星期之后，又多了一个新的索引库：log_20260329</span><br><span class="line">创建这个索引库并初始化一条数据</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260329&#x2F;&#39; </span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260329&#x2F;_doc&#x2F;1&#39; -d&#39;&#123;&quot;log&quot;:&quot;info-&gt;20260329&quot;&#125;&#39;</span><br><span class="line"></span><br><span class="line">此时就需要修改curr_week别名指向的索引库了，需要先删除之前的关联关系，再增加新的。</span><br><span class="line">删除curr_week和log_20260322之间的关联关系。</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_aliases&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;remove&quot; : &#123; &quot;index&quot; : &quot;log_20260322&quot;, &quot;alias&quot; : &quot;curr_week&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;&#39;</span><br><span class="line"></span><br><span class="line">新增curr_week和log_20260329之间的关联关系</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_aliases&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260329&quot;, &quot;alias&quot; : &quot;curr_week&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;&#39;</span><br><span class="line"></span><br><span class="line">此时再查询curr_week中的数据其实就是查询索引库log_20260329里面的数据了。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">然后再把索引库log_20260322添加到last_3_month别名中：</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_aliases&#39; -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;log_20260322&quot;, &quot;alias&quot; : &quot;last_3_month&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">这些关联别名映射关系和移除别名映射关系的操作需要写个脚本定时执行，这样就可以实现别名自动关联到指定索引库了。</span><br><span class="line"></span><br><span class="line">假设时间长了，我们如果忘记了这个别名下对应的都有哪些索引库，可以使用下面的方法查看一下：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_alias&#x2F;curr_week?pretty&#39;  </span><br><span class="line">&#123;</span><br><span class="line">  &quot;log_20260329&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;curr_week&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_alias&#x2F;last_3_month?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;log_20260315&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;last_3_month&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;log_20260308&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;last_3_month&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;log_20260301&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;last_3_month&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;log_20260322&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;last_3_month&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果想知道哪些别名指向了这个索引，可以这样查看：</span><br><span class="line">[root@bigdata01 ~]#  curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_alias&#x2F;*?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;log_20260301&quot; : &#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">      &quot;last_3_month&quot; : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">注意：针对3个月以前的索引基本上就很少再使用了，为了减少对ES服务器的性能损耗（主要是内存的损耗），建议把这些长时间不使用的索引库close掉，close之后这个索引库里面的索引数据就不支持读写操作了，close并不会删除索引库里面的数据，后期想要重新读写这个索引库里面的数据的话，可以通过open把索引库打开。</span><br><span class="line"></span><br><span class="line">将log_20260301索引库close掉：</span><br><span class="line">[root@bigdata01 ~]# curl -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_close&#39;</span><br><span class="line"></span><br><span class="line">此时再查看这个索引库的数据就查询不到了：</span><br><span class="line">会提示这个索引库已经被close掉了。</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_search?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;error&quot; : &#123;</span><br><span class="line">    &quot;root_cause&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot; : &quot;index_closed_exception&quot;,</span><br><span class="line">        &quot;reason&quot; : &quot;closed&quot;,</span><br><span class="line">        &quot;index_uuid&quot; : &quot;VGfSvKVJRjy5h3aCcsveKQ&quot;,</span><br><span class="line">        &quot;index&quot; : &quot;log_20260301&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot; : &quot;index_closed_exception&quot;,</span><br><span class="line">    &quot;reason&quot; : &quot;closed&quot;,</span><br><span class="line">    &quot;index_uuid&quot; : &quot;VGfSvKVJRjy5h3aCcsveKQ&quot;,</span><br><span class="line">    &quot;index&quot; : &quot;log_20260301&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot; : 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">注意：这些close之后的索引库需要从索引库别名中移除掉，否则会导致无法使用从索引库别名查询数据，因为这个索引库别名中映射的有已经close掉的索引库。</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;last_3_month&#x2F;_search?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;error&quot; : &#123;</span><br><span class="line">    &quot;root_cause&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot; : &quot;index_closed_exception&quot;,</span><br><span class="line">        &quot;reason&quot; : &quot;closed&quot;,</span><br><span class="line">        &quot;index_uuid&quot; : &quot;VGfSvKVJRjy5h3aCcsveKQ&quot;,</span><br><span class="line">        &quot;index&quot; : &quot;log_20260301&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot; : &quot;index_closed_exception&quot;,</span><br><span class="line">    &quot;reason&quot; : &quot;closed&quot;,</span><br><span class="line">    &quot;index_uuid&quot; : &quot;VGfSvKVJRjy5h3aCcsveKQ&quot;,</span><br><span class="line">    &quot;index&quot; : &quot;log_20260301&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot; : 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">接下来将log_20260301索引库重新open（打开）。</span><br><span class="line">[root@bigdata01 ~]# curl -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_open&#39;</span><br><span class="line"></span><br><span class="line">索引库open之后就可以查询了</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;log_20260301&#x2F;_search?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 5,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 2,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;log_20260301&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;log&quot; : &quot;info-&gt;20260301&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">索引库别名也可以正常使用了</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">索引库close掉之后，虽然对ES服务器没有性能损耗了，但是对ES集群的磁盘占用还是存在的，所以可以根据需求，将一年以前的索引库彻底删除掉。</span><br></pre></td></tr></table></figure>

<h3 id="ES-SQL"><a href="#ES-SQL" class="headerlink" title="ES SQL"></a>ES SQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">针对ES中的结构化数据，使用SQL实现聚合统计会很方便，可以减少很多工作量。</span><br><span class="line"></span><br><span class="line">ES SQL支持常见的SQL语法，包括分组、排序、函数等，但是目前不支持JOIN。</span><br><span class="line"></span><br><span class="line">在使用的时候可以使用SQL命令行、RestAPI、JDBC、ODBC等方式操作。</span><br><span class="line">本地测试的时候使用SQL命令行更加方便。</span><br><span class="line">想要实现跨语言调用使用RestAPI更加方便。</span><br><span class="line">Java程序员使用JDBC方式更方便。</span><br></pre></td></tr></table></figure>

<h4 id="ES-SQL命令行下的使用"><a href="#ES-SQL命令行下的使用" class="headerlink" title="ES SQL命令行下的使用"></a>ES SQL命令行下的使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[es@bigdata01 elasticsearch-7.13.4]$ bin&#x2F;elasticsearch-sql-cli http:&#x2F;&#x2F;bigdata01:9200</span><br><span class="line">sql&gt; select * from user;</span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">20             |tom            </span><br><span class="line">15             |tom            </span><br><span class="line">17             |jack           </span><br><span class="line">19             |jess           </span><br><span class="line">23             |mick           </span><br><span class="line">12             |lili           </span><br><span class="line">28             |john           </span><br><span class="line">30             |jojo           </span><br><span class="line">16             |bubu           </span><br><span class="line">21             |pig            </span><br><span class="line">19             |mary           </span><br><span class="line">60             |刘德华            </span><br><span class="line">20             |刘老二</span><br><span class="line">sql&gt; select * from user where age &gt; 20;</span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">23             |mick           </span><br><span class="line">28             |john           </span><br><span class="line">30             |jojo           </span><br><span class="line">21             |pig            </span><br><span class="line">60             |刘德华</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果想要实现模糊查询，使用sql中的like是否可行？</span><br><span class="line">sql&gt; select * from user where name like &#39;刘华&#39;;                     </span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">sql&gt; select * from user where name like &#39;刘%&#39;;  </span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">60             |刘德华            </span><br><span class="line">20             |刘老二</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">like这种方式其实就是普通的查询了，无法实现分词查询。</span><br><span class="line">想要实现分词查询，需要使用match。</span><br><span class="line"></span><br><span class="line">sql&gt; select * from user where match(name,&#39;刘华&#39;);       </span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">60             |刘德华            </span><br><span class="line">20             |刘老二</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">退出ES SQL命令行，需要输入exit；</span><br></pre></td></tr></table></figure>

<h4 id="RestAPI下ES-SQL的使用。"><a href="#RestAPI下ES-SQL的使用。" class="headerlink" title="RestAPI下ES SQL的使用。"></a>RestAPI下ES SQL的使用。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">查询user索引库中的数据，根据age倒序排序，获取前5条数据。</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_sql?format&#x3D;txt&#39; -d&#39;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;:&quot;select * from user order by age desc limit 5&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br><span class="line">      age      |     name      </span><br><span class="line">---------------+---------------</span><br><span class="line">60             |刘德华            </span><br><span class="line">30             |jojo           </span><br><span class="line">28             |john           </span><br><span class="line">23             |mick           </span><br><span class="line">21             |pig</span><br></pre></td></tr></table></figure>

<h4 id="JDBC操作ES-SQL"><a href="#JDBC操作ES-SQL" class="headerlink" title="JDBC操作ES SQL"></a>JDBC操作ES SQL</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">首先添加ES sql-jdbc的依赖。</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.elasticsearch.plugin&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;x-pack-sql-jdbc&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;7.13.4&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.imooc.es;</span><br><span class="line"></span><br><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.DriverManager;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.Statement;</span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * JDBC操作ES SQL</span><br><span class="line"> * Created by xuwei</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class EsJdbcOp &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        &#x2F;&#x2F;指定jdbcUrl</span><br><span class="line">        String jdbcUrl &#x3D; &quot;jdbc:es:&#x2F;&#x2F;http:&#x2F;&#x2F;bigdata01:9200&#x2F;?timezone&#x3D;UTC+8&quot;;</span><br><span class="line">        Properties properties &#x3D; new Properties();</span><br><span class="line">        &#x2F;&#x2F;获取JDBC连接</span><br><span class="line">        Connection conn &#x3D; DriverManager.getConnection(jdbcUrl, properties);</span><br><span class="line">        Statement stmt &#x3D; conn.createStatement();</span><br><span class="line">        ResultSet results &#x3D; stmt.executeQuery(&quot;select name,age from user order by age desc limit 5&quot;);</span><br><span class="line">        while (results.next())&#123;</span><br><span class="line">            String name &#x3D; results.getString(1);</span><br><span class="line">            int age &#x3D; results.getInt(2);</span><br><span class="line">            System.out.println(name+&quot;--&quot;+age);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;关闭连接</span><br><span class="line">        stmt.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注意：jdbc这种方式目前无法免费使用，需要购买授权。</span><br><span class="line"></span><br><span class="line">Exception in thread &quot;main&quot; java.sql.SQLInvalidAuthorizationSpecException: current license is non-compliant for [jdbc]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以在工作中常用的是RestAPI这种方式。</span><br></pre></td></tr></table></figure>

<h3 id="ES优化策略"><a href="#ES优化策略" class="headerlink" title="ES优化策略"></a>ES优化策略</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.ES中Too many open files的问题。</span><br><span class="line"></span><br><span class="line">ES中的索引数据都是存储在磁盘文件中的，每一条数据在底层都会产生一份索引片段文件</span><br><span class="line">这些索引数据默认的存储目录是在ES安装目录下的data目录里面。</span><br><span class="line"></span><br><span class="line">[es@bigdata01 index]$ pwd</span><br><span class="line">&#x2F;data&#x2F;soft&#x2F;elasticsearch-7.13.4&#x2F;data&#x2F;nodes&#x2F;0&#x2F;indices&#x2F;28q_rMHAR4GJBImzb40woA&#x2F;0&#x2F;index</span><br><span class="line">[es@bigdata01 index]$ ll</span><br><span class="line">total 52</span><br><span class="line">-rw-rw-r--. 1 es es  479 Mar 12 15:21 _0.cfe</span><br><span class="line">-rw-rw-r--. 1 es es 3302 Mar 12 15:21 _0.cfs</span><br><span class="line">-rw-rw-r--. 1 es es  363 Mar 12 15:21 _0.si</span><br><span class="line">-rw-rw-r--. 1 es es  479 Mar 12 15:21 _1.cfe</span><br><span class="line">-rw-rw-r--. 1 es es 2996 Mar 12 15:21 _1.cfs</span><br><span class="line">-rw-rw-r--. 1 es es  363 Mar 12 15:21 _1.si</span><br><span class="line">-rw-rw-r--. 1 es es  923 Mar 12 16:28 _2_1.fnm</span><br><span class="line">-rw-rw-r--. 1 es es  103 Mar 12 16:28 _2_1_Lucene80_0.dvd</span><br><span class="line">-rw-rw-r--. 1 es es  160 Mar 12 16:28 _2_1_Lucene80_0.dvm</span><br><span class="line">-rw-rw-r--. 1 es es  479 Mar 12 16:28 _2.cfe</span><br><span class="line">-rw-rw-r--. 1 es es 3718 Mar 12 16:28 _2.cfs</span><br><span class="line">-rw-rw-r--. 1 es es  363 Mar 12 16:28 _2.si</span><br><span class="line">-rw-rw-r--. 1 es es  533 Mar 12 16:33 segments_4</span><br><span class="line">-rw-rw-r--. 1 es es    0 Mar 12 15:21 write.lock</span><br><span class="line"></span><br><span class="line">注意：路径中的28q_rMHAR4GJBImzb40woA表示是索引库的UUID。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202306112348016.png" alt="image-20230611234857593"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ES在查询索引库里面数据的时候需要读取所有的索引片段，如果索引库中数据量比较多，那么ES在查询的时候就需要读取很多索引片段文件，此时可能就会达到Linux系统的极限，因为Linux会限制系统内最大文件打开数。</span><br><span class="line">这个最大文件打开数的的配置在安装ES集群的时候我们已经修改过了：</span><br><span class="line">主要就是这些参数：</span><br><span class="line">[root@bigdata01 soft]# vi &#x2F;etc&#x2F;security&#x2F;limits.conf </span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br><span class="line"></span><br><span class="line">理论上来说，不管我们将最大文件打开数修改为多大，在使用的时候都有可能会出问题，因为ES中的数据是越来越多的，那如何解决？</span><br><span class="line">其实也不用过于担心，因为ES中默认会有一个自动的索引片段合并机制，这样可以保证ES中不会产生过多的索引片段。</span><br><span class="line">只要是单个索引片段文件小于5G的，在自动索引片段合并机制触发的时候都会进行合并。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">2.索引合并优化，清除标记为删除状态的索引数据。</span><br><span class="line"></span><br><span class="line">咱们前面分析过，ES中的删除并不是真正的删除，只是会给数据标记一个删除状态，索引片段在合并的时候，是会把索引片段中标记为删除的数据真正删掉，这样也是可以提高性能的，因为标记为删除状态的数据是会参与查询的，只不过会被过滤掉。</span><br><span class="line"></span><br><span class="line">索引片段合并除了可以避免产生Too many open files这个问题，其实它也是可以显著提升查询性能的，因为我们读取一个中等大小的文件肯定是比读取很多个小文件效率更高的</span><br><span class="line"></span><br><span class="line">除了等待自动的索引片段合并，也可以手工执行索引片段合并操作，但是要注意：索引片段合并操作是比较消耗系统IO资源的，不要在业务高峰期执行，也没必要频繁调用，可以每天凌晨执行一次。</span><br><span class="line"></span><br><span class="line">[root@bigdata01 ~]# curl -XPOST &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;stu&#x2F;_forcemerge&#39;</span><br><span class="line">合并之后会的索引片段就变成了这样，这些文件其实属于一个索引片段，都是以_3开头的：</span><br><span class="line">[es@bigdata01 index]$ ll</span><br><span class="line">total 72</span><br><span class="line">-rw-rw-r--. 1 es es 158 Mar 14 15:47 _3.fdm</span><br><span class="line">-rw-rw-r--. 1 es es 527 Mar 14 15:47 _3.fdt</span><br><span class="line">-rw-rw-r--. 1 es es  64 Mar 14 15:47 _3.fdx</span><br><span class="line">-rw-rw-r--. 1 es es 922 Mar 14 15:47 _3.fnm</span><br><span class="line">-rw-rw-r--. 1 es es 202 Mar 14 15:47 _3.kdd</span><br><span class="line">-rw-rw-r--. 1 es es  69 Mar 14 15:47 _3.kdi</span><br><span class="line">-rw-rw-r--. 1 es es 200 Mar 14 15:47 _3.kdm</span><br><span class="line">-rw-rw-r--. 1 es es 159 Mar 14 15:47 _3_Lucene80_0.dvd</span><br><span class="line">-rw-rw-r--. 1 es es 855 Mar 14 15:47 _3_Lucene80_0.dvm</span><br><span class="line">-rw-rw-r--. 1 es es  78 Mar 14 15:47 _3_Lucene84_0.doc</span><br><span class="line">-rw-rw-r--. 1 es es  92 Mar 14 15:47 _3_Lucene84_0.pos</span><br><span class="line">-rw-rw-r--. 1 es es 305 Mar 14 15:47 _3_Lucene84_0.tim</span><br><span class="line">-rw-rw-r--. 1 es es  74 Mar 14 15:47 _3_Lucene84_0.tip</span><br><span class="line">-rw-rw-r--. 1 es es 261 Mar 14 15:47 _3_Lucene84_0.tmd</span><br><span class="line">-rw-rw-r--. 1 es es  59 Mar 14 15:47 _3.nvd</span><br><span class="line">-rw-rw-r--. 1 es es 103 Mar 14 15:47 _3.nvm</span><br><span class="line">-rw-rw-r--. 1 es es 575 Mar 14 15:47 _3.si</span><br><span class="line">-rw-rw-r--. 1 es es 316 Mar 14 15:47 segments_5</span><br><span class="line">-rw-rw-r--. 1 es es   0 Mar 12 15:21 write.lock</span><br><span class="line"></span><br><span class="line">如果一个索引库中的数据已经非常多了，手工执行索引片段合并操作可能会产生一些非常大的索引片段（超过5G的），如果继续向这个索引库里面写入新的数据，那么ES的自动索引片段合并机制就不会再考虑这些非常大的索引片段了（超过5G的），这样会导致索引库中保留了非常大的索引片段，从而降低搜索性能。</span><br><span class="line"></span><br><span class="line">这种问题该如何解决呢？往下面继续看！</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">3.分片和副本个数调整</span><br><span class="line"></span><br><span class="line">分片多的话，可以提升建立索引的能力，单个索引库，建议使用5-20个分片比较合适。</span><br><span class="line">分片数过少或过多，都会降低检索效率。</span><br><span class="line">分片数过多会导致检索时打开比较多的文件，另外也会导致多台服务器之间的通讯。</span><br><span class="line">而分片数过少会导致单个分片索引过大，所以检索速度也会慢。</span><br><span class="line">建议单个分片存储20G左右的索引数据【最高也不要超过50G，否则性能会很差】</span><br><span class="line">所以，大致有一个公式：分片数量&#x3D;数据总量&#x2F;20G</span><br><span class="line"></span><br><span class="line">当数据规模超过单个索引库最大存储能力的时候，只需要新建一个索引库即可，所以ES中的海量数据存储能力是需要依靠多个索引库的，这样就可以解决前面所说的索引库中单个索引片段过大的问题。</span><br><span class="line"></span><br><span class="line">副本多的话，理论上来说可以提升检索的能力，但是如果设置很多副本的话也会对服务器造成额外的压力，因为主分片需要给所有副本分片同步数据，所以建议最多设置1-2个副本即可。</span><br><span class="line"></span><br><span class="line">注意：从ES7.x版本开始，集群中每个节点默认支持最多1000个了片，这块主要是考虑到单个节点的性能问题，如果集群内每个节点的性能都比较强，当然也是支持修改的。</span><br><span class="line"></span><br><span class="line">先查看一下现在集群默认的参数配置：</span><br><span class="line">现在里面的参数都是空的。</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_cluster&#x2F;settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot; : &#123; &#125;,</span><br><span class="line">  &quot;transient&quot; : &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">修改节点支持的最大分片数量</span><br><span class="line">[root@bigdata01 ~]# curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_cluster&#x2F;settings&#39;  -d &#39;&#123; &quot;persistent&quot;: &#123; &quot;cluster.max_shards_per_node&quot;: &quot;10000&quot; &#125; &#125;&#39;</span><br><span class="line"></span><br><span class="line">重新查询集群最新的参数配置：</span><br><span class="line">[root@bigdata01 ~]# curl -XGET &#39;http:&#x2F;&#x2F;bigdata01:9200&#x2F;_cluster&#x2F;settings?pretty&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot; : &#123;</span><br><span class="line">    &quot;cluster&quot; : &#123;</span><br><span class="line">      &quot;max_shards_per_node&quot; : &quot;10000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;transient&quot; : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4.初始化数据时，建议将副本数设置为0。</span><br><span class="line"></span><br><span class="line">如果是在项目初期，ES集群刚安装好，需要向里面批量初始化大量数据，此时建议将副本数设置为0，这样是可以显著提高入库效率的。</span><br><span class="line">如果有副本的话，在批量初始化数据的同时，索引库的主分片还需要负责向副本分片同步数据，这样会影响数据的入库性能。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5. 针对不使用的index，建议close，减少性能损耗。</span><br><span class="line">具体的操作方式在前面讲索引库别名的时候已经讲过了。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">6.调整ES的JVM内存大小，单个ES实例最大不超过32G。</span><br><span class="line"></span><br><span class="line">单个ES实例官方建议最大使用32G内存，如果超过这个内存ES也使用不了，这样会造成资源浪费。</span><br><span class="line">所以在前期申请ES集群机器的时候，建议单机内存在32G左右即可。</span><br><span class="line">如果由于历史遗留问题导致每台机器的内存都很大，假设是128G的，如果在这台机器上只部署一个ES实例，会造成内存资源浪费，此时有一种取巧的方式，在同一台机器上部署多个ES实例，只需要让这台机器中的每个ES实例监听不同的端口就行了。</span><br><span class="line">这样这个128G内存的机器理论上至少可以部署4个ES实例。</span><br><span class="line">但是这样会存在一个弊端，如果后期这台机器出现了故障，那么ES集群会同时丢失4个节点，可能会丢数据，所以还是尽量避免这种情况。</span><br></pre></td></tr></table></figure>





























<hr>
<blockquote>
</blockquote>

      
    </div>
    
    
    
	
	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html">大数据开发工程师-全文检索引擎Elasticsearch-2</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 TTYONG 的个人博客">TTYONG</a></p>
  <p><span>发布时间:</span>2023年06月02日 - 18:06</p>
  <p><span>最后更新:</span>2023年06月19日 - 18:06</p>
  <p><span>原始链接:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html" title="大数据开发工程师-全文检索引擎Elasticsearch-2">http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8EElasticsearch-2.html" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
    });
    });  
</script>



      
	</div>



    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>多少都是爱</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_reward.jpg" alt="TTYONG 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay_reward.jpg" alt="TTYONG 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Elasticsearch/" rel="tag"><i class="fa fa-tag"></i> Elasticsearch</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E4%B8%83%E5%91%A8-Flink%E6%9E%81%E9%80%9F%E4%B8%8A%E6%89%8B%E7%AF%87-Flink%E6%96%B0%E7%89%88%E6%9C%AC1-12%E4%BB%A5%E4%B8%8A-3.html" rel="next" title="大数据开发工程师-第十七周-Flink极速上手篇-Flink新版本1.12以上-3">
                <i class="fa fa-chevron-left"></i> 大数据开发工程师-第十七周-Flink极速上手篇-Flink新版本1.12以上-3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-ES+HBase%E5%AE%9E%E7%8E%B0%E4%BB%BF%E7%99%BE%E5%BA%A6%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E-1.html" rel="prev" title="大数据开发工程师-ES+HBase实现仿百度搜索引擎-1">
                大数据开发工程师-ES+HBase实现仿百度搜索引擎-1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
      
        
          <ul class="sidebar-nav motion-element">
            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
              文章目录
            </li>
            <li class="sidebar-nav-overview" data-target="site-overview">
              站点概览
            </li>
          </ul>
        
      

	<section class="site-overview sidebar-panel">
	  <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
		<img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="TTYONG">
		<p class="site-author-name" itemprop="name">TTYONG</p>
		 
			<p class="site-description motion-element" itemprop="description"></p>
		 
	  </div>
	  <nav class="site-state motion-element">

		
		  <div class="site-state-item site-state-posts">
			<a href="/archives/%7C%7C%20archive">
			  <span class="site-state-item-count">375</span>
			  <span class="site-state-item-name">日志</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-categories">
			<a href="/categories/index.html">
			  <span class="site-state-item-count">51</span>
			  <span class="site-state-item-name">分类</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-tags">
			<a href="/tags/index.html">
			  <span class="site-state-item-count">107</span>
			  <span class="site-state-item-name">标签</span>
			</a>
		  </div>
		

	  </nav>

	  
		<div class="feed-link motion-element">
		  <a href="/atom.xml" rel="alternate">
			<i class="fa fa-rss"></i>
			RSS
		  </a>
		</div>
	  

	  <div class="links-of-author motion-element">
		
		  
			<span class="links-of-author-item">
			  <a href="2364076207@qq.com || envelope" target="_blank" title="E-Mail">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				E-Mail
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://wpa.qq.com/msgrd?v=3&uin=2364076207&site=qq&menu=yes || qq" target="_blank" title="QQ" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				QQ
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://weibo.com/p/1005051833844383/home || weixin" target="_blank" title="WeiXin" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				WeiXin
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://www.zhihu.com/people/he-he-ty || zhihu" target="_blank" title="ZhiHu" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				ZhiHu
			  </a>
			</span>
		  
		
	  </div>

	  
	  

	  
	  
		<div class="links-of-blogroll motion-element links-of-blogroll-block">
		  <div class="links-of-blogroll-title">
			<i class="fa  fa-fw fa-link"></i>
			友链
		  </div>
		  <ul class="links-of-blogroll-list">
			
			  <li class="links-of-blogroll-item">
				<a href="https://www.baidu.com/" target="_blank" rel="external nofollow noopener noreferrer">百度</a>
			  </li>
			
		  </ul>
		</div>
	  

	  


	</section>
	
	  
	  <!--noindex-->
		<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
		  <div class="post-toc">

			
			  
			

			
			  <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#全文检索引擎Elasticsearch-2"><span class="nav-number">1.</span> <span class="nav-text">全文检索引擎Elasticsearch-2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Elasticsearch分词详解"><span class="nav-number">1.1.</span> <span class="nav-text">3 Elasticsearch分词详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES分词介绍"><span class="nav-number">1.1.1.</span> <span class="nav-text">ES分词介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#倒排索引介绍"><span class="nav-number">1.1.2.</span> <span class="nav-text">倒排索引介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分词器的作用"><span class="nav-number">1.1.3.</span> <span class="nav-text">分词器的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分词器的工作流程"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">分词器的工作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#停用词"><span class="nav-number">1.1.3.1.1.</span> <span class="nav-text">停用词</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#中文分词方式"><span class="nav-number">1.1.3.1.2.</span> <span class="nav-text">中文分词方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#常见的中文分词器"><span class="nav-number">1.1.3.1.3.</span> <span class="nav-text">常见的中文分词器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ES中文分词插件-es-ik"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">ES中文分词插件(es-ik)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#es-ik添加自定义词库"><span class="nav-number">1.1.4.</span> <span class="nav-text">es-ik添加自定义词库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义词库"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">自定义词库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#热更新词库"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">热更新词库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Elasticsearch查询详解"><span class="nav-number">1.2.</span> <span class="nav-text">4 Elasticsearch查询详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-Search查询"><span class="nav-number">1.2.1.</span> <span class="nav-text">ES Search查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#searchType详解"><span class="nav-number">1.2.2.</span> <span class="nav-text">searchType详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DFS是一个什么样的过程？"><span class="nav-number">1.2.3.</span> <span class="nav-text">DFS是一个什么样的过程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES查询扩展"><span class="nav-number">1.2.4.</span> <span class="nav-text">ES查询扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EsSearchOp"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">EsSearchOp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分页"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排序"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高亮"><span class="nav-number">1.2.4.5.</span> <span class="nav-text">高亮</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#评分依据-了解"><span class="nav-number">1.2.5.</span> <span class="nav-text">评分依据(了解)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES中分页的性能问题"><span class="nav-number">1.2.6.</span> <span class="nav-text">ES中分页的性能问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aggregations聚合统计"><span class="nav-number">1.2.7.</span> <span class="nav-text">aggregations聚合统计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#统计相同年龄的学员个数"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">统计相同年龄的学员个数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#统计每个学员的总成绩"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">统计每个学员的总成绩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#aggregations获取所有分组数据"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">aggregations获取所有分组数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Elasticsearch的高级特性"><span class="nav-number">1.3.</span> <span class="nav-text">5 Elasticsearch的高级特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES中的settings"><span class="nav-number">1.3.1.</span> <span class="nav-text">ES中的settings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES中的mapping"><span class="nav-number">1.3.2.</span> <span class="nav-text">ES中的mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ES中的常用数据类型"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">ES中的常用数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看mapping"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">查看mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手工创建mapping"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">手工创建mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新mapping"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">更新mapping</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES的偏好查询-分片查询方式"><span class="nav-number">1.3.3.</span> <span class="nav-text">ES的偏好查询(分片查询方式)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#local"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">_local</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#only-local"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">_only_local</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#only-nodes"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">_only_nodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prefer-nodes"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">_prefer_nodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shards-常用"><span class="nav-number">1.3.3.5.</span> <span class="nav-text">_shards(常用)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#custom-string"><span class="nav-number">1.3.3.6.</span> <span class="nav-text">custom-string</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES中的routing路由功能"><span class="nav-number">1.3.4.</span> <span class="nav-text">ES中的routing路由功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES的索引库模板-了解"><span class="nav-number">1.3.5.</span> <span class="nav-text">ES的索引库模板(了解)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES的索引库别名-了解"><span class="nav-number">1.3.6.</span> <span class="nav-text">ES的索引库别名(了解)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-SQL"><span class="nav-number">1.3.7.</span> <span class="nav-text">ES SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ES-SQL命令行下的使用"><span class="nav-number">1.3.7.1.</span> <span class="nav-text">ES SQL命令行下的使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RestAPI下ES-SQL的使用。"><span class="nav-number">1.3.7.2.</span> <span class="nav-text">RestAPI下ES SQL的使用。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDBC操作ES-SQL"><span class="nav-number">1.3.7.3.</span> <span class="nav-text">JDBC操作ES SQL</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES优化策略"><span class="nav-number">1.3.8.</span> <span class="nav-text">ES优化策略</span></a></li></ol></li></ol></li></ol></div>
			

		  </div>
		</section>
	  <!--/noindex-->
	  
	

	

  </div>
</aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2020.3.4 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TTYONG</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">794.4k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow>Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next rel="external nofollow">NexT.Pisces</a> v5.1.4</div>



-->  


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <div id="gitalk-container"></div>
  <script src="/js/src/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'd3f3299eb0cc69c8f171',
      clientSecret: '23bf8796e5dda2daf0a1b12964d89f4cc88f9ddf',
      repo: 'comments_repository',
      owner: 'ttyong',
      admin: ['ttyong'],
      id: md5(location.pathname),
      distractionFreeMode: 'false'
    })
    gitalk.render('gitalk-container')
  </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  
  

  

  

  

  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>
  
  
  
  

  <canvas id="evanyou"></canvas>
  <style>
    #evanyou {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
  <script src="/js/src/evan-you.js"></script>




  <script src="/js/src/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>




  <script async src="/js/cursor/fireworks.js"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
