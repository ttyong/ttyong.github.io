<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<script src="https://cdn.jsdelivr.net/gh/wallleap/cdn/js/piao.js"></script>
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="baidu-site-verification" content="s8Pe1TBqyy">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/animal_bear_panda_32px_4023_easyicon.net.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/animal_bear_panda_16px_4023_easyicon.net.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="直播平台三度关系推荐v1.0,">





  <link rel="alternate" href="/atom.xml" title="TianYong's Blog" type="application/atom+xml">






<meta name="description" content="第十八周 直播平台三度关系推荐v1.0-2数据采集架构详细设计 1234567大家好，下面呢，我们就从我们整体架构里面的第一个模块数据采集模块开始。注意，在实际过程中，数据采集模块不是只针对某一个项目而言的，而是一个公共的采集平台，所有项目依赖的数据全部都来源于数据采集模块，所以在设计采集模块的时候要考虑通用性。不能仅仅是为了这一个项目而服务。咱们前面在分析整体架构的时候说过，filebea">
<meta property="og:type" content="article">
<meta property="og:title" content="大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2">
<meta property="og:url" content="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html">
<meta property="og:site_name" content="TianYong&#39;s Blog">
<meta property="og:description" content="第十八周 直播平台三度关系推荐v1.0-2数据采集架构详细设计 1234567大家好，下面呢，我们就从我们整体架构里面的第一个模块数据采集模块开始。注意，在实际过程中，数据采集模块不是只针对某一个项目而言的，而是一个公共的采集平台，所有项目依赖的数据全部都来源于数据采集模块，所以在设计采集模块的时候要考虑通用性。不能仅仅是为了这一个项目而服务。咱们前面在分析整体架构的时候说过，filebea">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304242348422.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181718754.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181712187.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181716837.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181715348.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181725293.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181741539.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251045006.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181742580.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251102183.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251055893.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251101505.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251101273.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251104599.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136630.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136684.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136744.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251125314.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251130414.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251133562.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251133869.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251159150.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251200726.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251209159.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251211306.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251212200.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251218213.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251222076.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251225756.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252144970.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252145763.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252156385.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252211650.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252219426.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252220669.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252225085.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252227824.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252230600.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252231054.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252235554.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252237920.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252240353.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252308990.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252309870.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252309790.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252316813.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252328190.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252328755.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252350277.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252351285.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252351462.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252352125.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252354258.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260002090.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260003322.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260003085.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260004849.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260033394.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260034352.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260034803.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261043614.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305201757733.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261105667.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261109573.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261109688.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261111274.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261111021.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261117713.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261118389.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261118328.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261119828.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261122789.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261127580.png">
<meta property="og:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261133414.png">
<meta property="article:published_time" content="2023-04-24T07:37:28.000Z">
<meta property="article:modified_time" content="2023-05-20T10:28:05.377Z">
<meta property="article:author" content="TTYONG">
<meta property="article:tag" content="直播平台三度关系推荐v1.0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304242348422.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://tianyong.fun/大数据开发工程师-第十八周-直播平台三度关系推荐v1-0-2.html">





  <title>大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2 | TianYong's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">TianYong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">比你优秀的人都努力，有什么理由不努力！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="TTYONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TianYong's Blog">
    </span>

    
      <header class="post-header">
	  
	  



        
        
          <h2 class="post-title" itemprop="name headline">大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-24T15:37:28+08:00">
                2023-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/" itemprop="url" rel="index">
                    <span itemprop="name">大数据开发工程师</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  22.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  81
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<script type="text/javascript" src="/js/src/bai.js"></script>

<h1 id="第十八周-直播平台三度关系推荐v1-0-2"><a href="#第十八周-直播平台三度关系推荐v1-0-2" class="headerlink" title="第十八周 直播平台三度关系推荐v1.0-2"></a>第十八周 直播平台三度关系推荐v1.0-2</h1><h2 id="数据采集架构详细设计"><a href="#数据采集架构详细设计" class="headerlink" title="数据采集架构详细设计"></a>数据采集架构详细设计</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304242348422.png" alt="image-20230424234832289"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">大家好，下面呢，我们就从我们整体架构里面的第一个模块数据采集模块开始。注意，在实际过程中，数据采集模块不是只针对某一个项目而言的，而是一个公共的采集平台，所有项目依赖的数据全部都来源于数据采集模块，所以在设计采集模块的时候要考虑通用性。不能仅仅是为了这一个项目而服务。</span><br><span class="line"></span><br><span class="line">咱们前面在分析整体架构的时候说过，filebeat采集的数据到达kafka以后，会通过flume再做一下分发，为什么要有这个分发这个过程呢？这个分发过程实现了什么功能呢？我们来看一下这张图。这个图里面呢，针对数据采集模块做了详细的分析，把数据采集模块呢，又划分了三层，数据采集聚合层，数据分发省数据落盘层。</span><br><span class="line"></span><br><span class="line">在这个数据采集聚合层，我们为了保证采集程序的通用性，不至于每次新增一个业务指标的数据，就去重新增加一个采集进程，或者修改采集程序的配置文件。所以呢，我们定义了一个规则。所有的日志数据全部保存在服务器的一个特定的目录下面。我会让filebeat的监控这个目录下面的所有文件。如果后期有新增业务日志，那么就会在这个目录下新增一种日志文件，filebeat就可以自动识别。但是这个时候会有一个问题。filebeat的输出只有一个。多种类型的日志数据会被filebeat采集到同一个topic中。如果各种类型的日志数据全部混到一块儿，会导致后期处理数据的时候比较麻烦。本来呢，我只想计算一种数据，但是这个时候我就需要读取这个大的topic。它里面呢，包含了很多种数据类型。这里面的一个数据量也很大，那我计算的时候呢，我就需要把它里面所有数据全部都读出来，然后再过滤。这样在计算的时候就会影响计算效率，也间接的浪费了计算资源。所以针对这个问题，我们又定义了一个规则，所有的日志数据全部使用json格式，并且呢，在json中增加一个type字段，标识数据的类型，这样每一条数据都有自己的类型标识，然后汇聚到kafka中的一个大的topic中。为了后面使用方便，我们就需要把这个大的topic中的数据啊，根据业务类型进行拆分，把不同类型的数据啊分发到不同的topic中。那这块的话，其实就是我们这个数据分发层要干的事情，相当于filebeat呢，它呢会把这个数据啊，全部都采集到kafka里面这个大topic里面。所有业务类型的日全部都采集到这一个topic里面。</span><br><span class="line"></span><br><span class="line">然后呢，我们接着就可以使用这个flume，对kafka中这个大topic中的数据进行分发。利用flume中的拦截器解析数据中的那个type字段的值，把type字段的值作为输出topic的一个名称。这样就可以把相同类型的数据分发到同一个topic中了。当然了，这些topic呢，我们需要提前创建。如果想要提高这个数据分发的能力，我们还可以在这儿启动多个flume进程。只需要保证多个flume中指定相同的group.id就可以了。这样就可以并行执行这个数据分发操作。那把这个数据分发到对应的topic里面以后呀，后面的实施计算程序就可以直接消费这个topic进行计算了。不需要再去读取那个大的topic，这样就可以提高计算性能。并且呢，我们还可以把需要备份的topic里面的数据啊，使用flume进行落盘，把它保存到Hdfs里面。这个呢，就是数据采集架构的详细设计。</span><br></pre></td></tr></table></figure>

<h2 id="数据来源分析"><a href="#数据来源分析" class="headerlink" title="数据来源分析"></a>数据来源分析</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181718754.png" alt="image-20230425104401098"></p>
<h3 id="服务端日志数据"><a href="#服务端日志数据" class="headerlink" title="服务端日志数据"></a>服务端日志数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面我们来分析一下，针对这个项目，我们需要采集哪些业务类型的数据，以及这些数据来源于什么地方。首先是服务端日志数据。什么是服务端日志呢？可以这样理解。就是我们在APP中点击一些按钮的时候，例如我们要关注一个主播，这个时候当我们点击这个关注按钮之后。APP呢，它会去请求对应的接口。接口中的代码逻辑就是将我们关注的数据保存到数据库里面。同时，这个接口也会记录一份日志。因为这个接口呢，是为APP提供后台服务的，所以它记录的日志我们称之为服务端日志。接着我们来简单画一个图来看一下。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181712187.png" alt="image-20230518171257153"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这个呢，是隔壁老王。那是我们的一个用户。画的形象一点。这是我们的一个APP。我们这个APP里面呢，它有一个关注功能。这时候呢，你看老王啊，他会点击这个关注功能。要关注某一个主播。当他点击这个关注功能之后，这个APP里面这个关注功能，它对应的它会调用一个接口。那我们这块呢，有一个后台服务器。这个服务器里面呢，部署的有一个接口服务，就是这种HTTP接口。那对应的这个关注功能，其实呢，还会调那个接口。所以你在这呢，点击APP里面这个关注按钮。它底层啊，其实会调这个接口。这个接口呢，其实呢，它会操作一个数据库。相遇老王在这儿呢，关注了一个主播，最终啊调这个接口。接口呢去操作这个数据库，最终把老王关注了，谁把这个数据呢存到数据库里面。就是这个逻辑啊。那这个时候注意我们在这个接入服务里面呢，因为它俩现在也是一个外部项目，所以什么它里面可以记录日志，那这里面记录的日志呢。我们就把它称为是服务端日志。</span><br><span class="line"></span><br><span class="line">那在我们这个项目里面，针对服务端日志。主要包含实时粉丝、观众数据以及视频数据。这个实时粉丝关注数据啊，是因为用户呢，在点击关注以及取消关注的时候，都需要调用服务端接口。所以这个数据呢，会在服务端通过日志记录。还有就是这个视频数据。下面这个视频啊，其实就是直播。当主播关闭直播的时候，会调用服务端接口上报本次直播的相关指标数据。其实服务端记录的还有很多其他类型的数据，只不过说呢，我们这个项目目前呢，只需要这两种数据。</span><br></pre></td></tr></table></figure>

<h3 id="服务端数据库数据"><a href="#服务端数据库数据" class="headerlink" title="服务端数据库数据"></a>服务端数据库数据</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181716837.png" alt="image-20230518171613701"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们来看一下服务端数据库中的数据。注意服务端数据库中的数据啊，其实啊，就是我们刚才图里面这个数据库里面的数据。来看一下。就这块儿。就相当于啊，我们App某一些功能呢，它会调用这个后台的接口，然后调用这个接口之后呢，最终啊，其实操作的是这个数据库。我们所说的这个服务端数据库的数据，其实说的就是这块它里面的数据。那在这个项目里面，我们主要获取历史粉丝关注数据，以及呢主播等级数据。这里面我们需要历史粉丝关注数据，因为我们在做这个项目的时候，我们的直播平台已经运营了两三年了。所以说，我们需要把历史粉丝关注数据初始化到图数据库中。这些历史数据服务端存储在数据库中，所以说我们需要从数据库里面去取。还有就是这个主播的等级数据。其实这个数据呢，在服务端日志中也有，但是我们考虑到服务端数据库中的数据是最准确的。特别是针对用户相关的数据，最好是以服务端数据库中的为准。所以说呢，我们就从那个服务端数据库中，每天凌晨啊，定时把昨天等级发生了变化的这个主播等级数据呢，导入到hdfs，方便我们后面的离线计算时。</span><br></pre></td></tr></table></figure>

<h3 id="客户端日志数据"><a href="#客户端日志数据" class="headerlink" title="客户端日志数据"></a>客户端日志数据</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181715348.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">最后呢，我们来看一下客户端日志数据。刚才我们分析了服务端日志。</span><br><span class="line"></span><br><span class="line">那什么是客户端日志呢？其实啊，就是用户在APP客户端操作的时候。直接通过埋点上报的日志数据，这种数据称之为客户端日志数据。我们在这再画一下这个图。如果说呀，你在这做了一些操作，你说呢，我不调用这个后台这个接口。我呢通过买点直接上报用户这个行为说你关注了谁对吧，直接通过买点上报。这个时候的话，在这呢，我们会有一个。这个日志接口服务器。他这个呢，就是直接通过这个埋点上报。那最终啊，可以把这个用户的行为数据啊，直接上报到这个日志接口服务器里面。然后就没有，然后。他不会去操作数据库啊。里面啊，一般上报的都是一些用户的行为。咱们刚才你看服务端日志呢，现在这啊，我们是要调这个接口，最终呢，是要操作数据库的，要把我们这个关注行为。就是谁关注，谁要把这个数据给它保存到数据库里面。</span><br><span class="line"></span><br><span class="line">而这种呢，通过埋点上报呢，其实呢，他就不会和那个数据库打交道。所以说这种话一般称之为是客服端日志。是通过客户端直接上报的，不需要和这个服务端这个接口去交互的。这里记录的日志，我们称之为后端日志。</span><br><span class="line"></span><br><span class="line">那这个服务端日志和客端日志有什么区别吗？为什么再分成两种日志呢？以及说为什么有的地方我们使用客户端日志，为什么有的地方我们使用服务端日志呢。针对我们这个APP里面啊，它这个关注功能服务端记录的这个日志啊，会更加准确。因为服务端接口里面，它会涉及到对于数据库的一个操作里面会有事务。只有这条数据真正保存成功的时候，才会记录日志，如果说你在操作数据库保存失败了。现在你会回滚，这时候就不需要去记录这个操作日志了。你顶多记录一条失败的日志。但是客户端日志，只要用户在APP里面点击了一次关注功能，他就会上报一次日志。最终啊，这个日志接收服务器啊，就会接收到这个日志，并且呢，把它记录下来。他可能呢，会由于网络等原因啊，导致最终关注失败，但是呢，你这条日志。你是发过来了，并且呢，这块啊也记录下来。所以相对来说，服务端数据的准确性是比这个客户端日志这个准确性高的。</span><br><span class="line"></span><br><span class="line">如果说一份数据在服务端日志中和客户端日志中同时都有。那我们肯定要优先选择服务端中的日志数据。一般啊，我们在客户端通过埋点上报的数据啊，都是一些用户行为数据，这些数据啊，就算有一些误差也没有多大影响。它不涉及到一些和数据库交互的一些操作。那在我们这个项目中，针对客户端日志，我们只要获取用户活跃数据。活跃呢表示啊，只要用户每天打开APP就认为用户活跃，用户的这些行为数据呢，会在客户端通过埋点上报管。</span><br><span class="line"></span><br><span class="line">那这些呢，就是我们项目中需要的一些基础数据，主要是这五份儿数据。那刚才我们分析到服务端日志，服务端数据库数据，以及客户端日志，那这个这个图里面啊，其实这样这个呢，就是服务端日志数据。这块呢，就是服务端数据库里面的数据。那这块呢，其实就是客户端的一些日志数据。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181725293.png" alt="image-20230518172542961"></p>
<h2 id="模拟产生数据"><a href="#模拟产生数据" class="headerlink" title="模拟产生数据"></a>模拟产生数据</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181741539.png" alt="image-20230518174114092"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251045006.png" alt="image-20230425104534521"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">前面我们分析了具体需要什么数据，以及数据从哪里来，下面我们来看一下如何通过代码模拟产生这些数据。先看这个图。我们通过执行generate date这个项目中的这五个入口类，可以模拟产生这五种数据。就是咱们前面分析的那五种数据。那在这里注意一下，因为我们不能直接使用企业中的真实数据啊，所以在这里我会根据企业中真实数据的格式去模拟生成。最终的效果是没有区别的。</span><br><span class="line"></span><br><span class="line">我们来看一下这些对应的代码。生成服务端数据和客户端数据代码如下：</span><br><span class="line"></span><br><span class="line">【服务端日志】实时粉丝关注数据: GenerateRealTimeFollowData</span><br><span class="line">【服务端日志】视频数据：GenerateVideoInfoData</span><br><span class="line">【服务端数据库】历史粉丝关注数据：GenerateHistoryFollowData</span><br><span class="line">【服务端数据库】主播等级数据：GenerateUserLevelData</span><br><span class="line">【客户端日志】用户活跃数据：GenerateUserActiveData</span><br><span class="line">在执行这些代码的时候还是需要使用之前在微信公众号中获取的校验码</span><br><span class="line"></span><br><span class="line">注意：在执行这些代码之前，我们需要先把基础环境搞定了</span><br><span class="line">这些代码在执行的时候会调用服务端接口和客户端日志接收服务，以及还会向MySQL中写入数据</span><br><span class="line">所以需要把这两个服务部署起来，以及在MySQL中初始化数据库和对应的表。</span><br><span class="line"></span><br><span class="line">所以说我们需要提前把这个两个接口服务，以及mysql中数据库和对的表都给它初始化好，都给它部署起来。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">第一步：</span><br><span class="line">对data_collect项目编译打包</span><br><span class="line"></span><br><span class="line">部署data_collect</span><br><span class="line">将生成的jar包上传到bigdata04机器的&#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;data_collect目录下，如果目录不存在则创建</span><br><span class="line"></span><br><span class="line">[root@bigdata04 soft]# mkdir -p &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;data_collect</span><br><span class="line"># 中间省略了上传jar包的过程</span><br><span class="line">[root@bigdata04 soft]# cd video_recommend&#x2F;data_collect&#x2F;</span><br><span class="line">[root@bigdata04 data_collect]# ll</span><br><span class="line">total 16932</span><br><span class="line">-rw-r--r--. 1 root root 17336051 Aug 29  2020 data_collect-1.0-SNAPSHOT.jar</span><br><span class="line">[root@bigdata04 data_collect]# nohup java -jar data_collect-1.0-SNAPSHOT.jar &amp;</span><br><span class="line"></span><br><span class="line">测试服务是否正常</span><br><span class="line">注意：这个服务监听的端口是8080</span><br><span class="line">[root@bigdata04 data_collect]# jps -ml</span><br><span class="line">1598 data_collect-1.0-SNAPSHOT.jar</span><br><span class="line">[root@bigdata04 data_collect]# curl -XGET &#39;http:&#x2F;&#x2F;localhost:8080&#x2F;v1&#x2F;t1?name&#x3D;test&#39;</span><br><span class="line">&#123;&quot;status&quot;:200,&quot;msg&quot;:&quot;success&quot;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">第二步：</span><br><span class="line">对server_inter项目编译打包</span><br><span class="line"></span><br><span class="line">部署server_inter</span><br><span class="line">将生成的jar包上传到bigdata04机器的&#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;server_inter目录下，如果目录不存在则创建</span><br><span class="line"></span><br><span class="line">[root@bigdata04 data_collect]# mkdir -p &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;server_inter</span><br><span class="line"># 中间省略了上传jar包的过程</span><br><span class="line">[root@bigdata04 data_collect]# cd ..&#x2F;server_inter&#x2F;</span><br><span class="line">[root@bigdata04 server_inter]# ll</span><br><span class="line">total 16932</span><br><span class="line">-rw-r--r--. 1 root root 17336083 Aug 29  2020 server_inter-1.0-SNAPSHOT.jar</span><br><span class="line">[root@bigdata04 server_inter]# nohup java -jar server_inter-1.0-SNAPSHOT.jar &amp;</span><br><span class="line"></span><br><span class="line">测试服务是否正常</span><br><span class="line"></span><br><span class="line">注意：这个服务监听的端口是8081</span><br><span class="line">[root@bigdata04 server_inter]# jps -ml</span><br><span class="line">1673 server_inter-1.0-SNAPSHOT.jar</span><br><span class="line">1598 data_collect-1.0-SNAPSHOT.jar</span><br><span class="line">[root@bigdata04 server_inter]# curl -XGET &#39;http:&#x2F;&#x2F;localhost:8081&#x2F;s1&#x2F;t1?name&#x3D;test&#39;</span><br><span class="line">&#123;&quot;status&quot;:200,&quot;msg&quot;:&quot;success&quot;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第三步：</span><br><span class="line">初始化数据库脚本</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305181742580.png" alt="image-20230518174258258"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">接下来执行代码，开始模拟产生数据</span><br><span class="line">1：【服务端日志】实时粉丝关注数据: GenerateRealTimeFollowData</span><br><span class="line">注意：修改服务端接口地址，我是在bigdata04机器上部署的</span><br><span class="line">代码执行之后，可以看到服务端记录的日志数据</span><br><span class="line">[root@bigdata04 ~]# cd &#x2F;data&#x2F;log&#x2F;</span><br><span class="line">[root@bigdata04 log]# more server_inter.log </span><br><span class="line">&#123;&quot;followuid&quot;:&quot;2002&quot;,&quot;followeruid&quot;:&quot;2001&quot;,&quot;type&quot;:&quot;user_follow&quot;,&quot;times</span><br><span class="line">tamp&quot;:1598684303487,&quot;desc&quot;:&quot;unfollow&quot;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2：【服务端日志】视频数据：GenerateVideoInfoData</span><br><span class="line">注意：修改服务端接口地址，我是在bigdata04机器上部署的</span><br><span class="line">代码执行之后，可以看到服务端记录的日志数据</span><br><span class="line">[root@bigdata04 log]# tail -1 server_inter.log         </span><br><span class="line">&#123;&quot;area&quot;:&quot;A_US&quot;,&quot;watchnumpv&quot;:364,&quot;follower&quot;:364,&quot;hosts&quot;:364,&quot;watchnumuv&quot;:364,&quot;gifter&quot;:364,&quot;nofollower&quot;:364,&quot;length&quot;:464,&quot;rating&quot;:&quot;A&quot;,&quot;smlook&quot;:364,&quot;type&quot;:&quot;video_info&quot;,&quot;gold&quot;:364,&quot;uid&quot;:&quot;2009&quot;,&quot;nickname&quot;:&quot;jack38&quot;,&quot;looktime&quot;:364,&quot;id&quot;:&quot;1769913940296&quot;,&quot;exp&quot;:364,&quot;timestamp&quot;:1769913940000&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3：【服务端数据库】历史粉丝关注数据：GenerateHistoryFollowData</span><br><span class="line">注意：执行这个代码的时候需要注意修改项目中的db.properties中数据库的地址信息</span><br><span class="line">代码执行之后，可以到数据库中看到数据</span><br><span class="line">查看数据库中的follower_00这个表，发现里面有数据了</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4：【服务端数据库】主播等级数据：GenerateUserLevelData</span><br><span class="line">注意：执行这个代码的时候需要注意修改项目中的db.properties中数据库的地址信息</span><br><span class="line">代码执行之后，可以到数据库中看到数据</span><br><span class="line">查看数据库中的cl_level_user这个表，发现里面有数据了</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5：【客户端日志】用户活跃数据：GenerateUserActiveData</span><br><span class="line">注意：修改客户端日志接收服务器地址，我是在bigdata04机器上部署的</span><br><span class="line">代码执行之后，可以看到客户端埋点上报的日志数据</span><br><span class="line">[root@bigdata04 log]# head -1 data_collect.log </span><br><span class="line">&#123;&quot;uid&quot;:&quot;1000&quot;,&quot;ver&quot;:&quot;3.6.41&quot;,&quot;countryCode&quot;:&quot;VN&quot;,&quot;ip&quot;:&quot;171.247.0.154&quot;,&quot;UnixtimeStamp&quot;:&quot;1598587868773&quot;,&quot;mcc&quot;:&quot;452&quot;,&quot;type&quot;:&quot;user_active&quot;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">至此，项目中需要的数据都可以正常产生了。</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来第一步我们先对这个data collect这个项目给他呢编译打包。嗯。CDDB。video。recommend。C的这个data collect。肯定package。港地skip test。好，编译成功。那把它上传到我们这个服务器上面，注意在这呢，我统一都上传到我们这个BD的零四这台机器上面。那接着呢，我统一再建一个目录。每个点啊。V6。recommend。所以说呢，针对这个项目相关的一些架包啊，那些东西全部都放到这个目录里面，这样方便管理维护啊。那我们进到这个目录下面，注意现在里面呢，我在创建一个目录。叫data collect。那这里面呢，就放我们这个data这个接口，这个夹包。打开这个图形化界面。把我们刚才生成那个架包给他传上去。it soft。在这。把这个家包传上来。好，那下面呢，我们把它启动起来。Java杠架。后面呢，直接指定那个另一个加包就行了，注意我们需要把它放到后台运行，所以说呢，前面加个no ho。后面呢，加个and符，这样就可以了。GPS一下。看到没有，这个架已经启动了，你可以这样GPS杠ML。这样看起来更加清晰，对吧，就这个data collect。那下面呢，我们来测试一下这个服务啊是否正常，因为它是一个接口服务。这里面呢，我们其实开放的有一个测试的一个接口。看到没有？你直接调用这个就行，它是一个测试结果，当然你在这需要传一个参数啊，它需要提出一个参数name。他会把它打印出来，这样可以确认一下你这个服务是否正常啊。这个怎么验证呢？它是一个HTTP请求，你可以选择在我们的浏览器里面去操作，或者说呢，我们直接在这个控制台里面也是可以的，通过curl这个命令杠X。盖着操作啊。HTTP冒号双斜线logo。冒号，注意它这个端口呢，是8080。我在这指定了。看到没有8080啊。VT对吧。name。等于test吧。你看状态是200是OK的啊，说明我那个服务呢是正常启动了。那接下来第二步，我们把这个server这个项目呢，给它编译打包。有这个项目。他是负责写收我们那个服务日志的。嗯。clean港。开始。好，编译成功。把它传上来。注意，那我们在这需要创建一个目录啊。你可以在这直接对吧，右键这样创建也是可以的啊都可以。serve。因此。嗯。好，上传成功。那这个呢，我们要把它启动一下。no Hu Java刚加。安福。嗯。先确认这个服务是不是在啊在吗。好，这个呢，我们也来验证一下。大家注意它这个接口名称呢，就不是这个，你可以到这儿来确认一下。这是S1T1对吧，以及呢，它的端口注意。因为我们是在同一台服务器上启动的，所以说呢，这两个项目啊，它监听的端口肯定是不能重复的啊，这个我给它改成80812。四上这个是8081。后面的是S1T1对吧。嗯。好，OK啊，还是这个size。好，那这样的话，这两个接口服务呢，就搞定了，这个以这个都部署好了。那接着第三步，我们需要把这个MY面这个数据库啊，还有表啊，给它触发好，这个呢，给大家提供了有这个触发脚本也比较方便啊。现在这右键。进行一个so文件。直接把这个脚本。指另外就行了。就是in my circle tables啊。这个脚本。好，执行成功。在这刷新一下。好，它呢，会产生这么些表啊。OK，这个后面我们具体用的时候再来具体查看。那接下来呢，我们就需要去执行这些代码了。这样的话呢，就可以模拟产生数据了。首先呢，我们先产生这个实时粉丝关注数据。就这个服务端呢。啊，服务端日志。模拟生成实时粉丝关注和取消关注数据。注意了，大家在下面呀，在执行我这个代码的时候，需要注意，你们需要改点东西。注意在上面，你看这个是调用我线上这个接口来获取这个模拟数据，获取到之后呢，注意。下面呢，会调用我们本地刚才部署的那个接口服务。因为这个呢是服务端日志，所以说它会调那个服务端接口。我呢是在BD的零四这台机箱部署的。对吧，这个服装接口，它这个对应的端口号是8081。对吧。后面这些东西呢，都不用改，你们下去改的话，主要改一下这个对吧，你在哪一台机器上去部署的这个什么server这个接入服务，那你在这就把那个IP或者主机名写到这就可以了。所以接着的话，就可以模拟产生这个服务端的这个调用请求，最终呢，去调用这个服务端这个接口，让这个接口呢记录日志。那你说这个接口，它具体把日志记录到哪个目录下面呢？注意，在这也能看懂啊。在resources这个目录下面有一个log back点查明。看到没有，我把这个日呢记到这个Di这个母下面了。然后他这块呢，具体的一个日志文件名称是server下换in加log。那对应的这个对collect看了也有。它日志呢，也是放到这个电log这个目录下面。然后它的日文名称呢，叫data collect。所以说这个到时候可以通过这个文件名就知道到底是哪个接口服务记录的日志啊，也好分析。那我们这个代码呢，都是OK的，以及这些接口这些东西呢，我们也不需要改，对吧，也都是OK的，下面呢，我们来执行一下。注意这个代码呢，它是实时产生数据，现在呢，你在这执行一次，它会产生一条数据，就是模拟那个实时产生啊。看到没有接口调用成功，注意这块是我在这记录的日志啊。借口立项成功，它最终产生的日是这个。好，那我们来看一下，我们具体去调这个服务端接口，这个服务端接口有没有把这个日给记录下来了，我们来确认一下。在这重新克隆一个绘画。对，log。到这个木下面。看到没有？这个里面其实已经有值了，对吧，我们可以在这摸看一下啊。没问题吧，他已经记录下来了，说明我们这个流程目前是通的啊。这个呢，就是服务端的实时粉丝关注数据。那接下来往下面看。这个generate video for。这个也是服务端日志对吧，是模拟生成视频相关的数据。就是你这个主播开播结束之后呢，其实它就会调用服务端接口。把当前这个直播的相关的一些信息上报过去啊。那注意你这个在用的时候也是一样的流程，对吧，这个上面还是就我那个接口。那下面的话呢，你需要在这对应改一下对吧。好，那我在这来执行一下。注意这个呢，一次性我可以采用多条数据啊。你看接口交换成功是OK的。那下面注意我们来确认一下数据。因为这时候它里面产生数据比较多，我就使用T杠一吧，查看里面最新的一条数据。对吧。也怪了。OK，所以说这个呢，是服务端的这两种类型的数据都采集过来了。往下面看。那接着呢，我们来看一下这个服务端数据库里面的数据。首先呢，是这个。就是这个历史，粉丝关注数据。注意。这个电板执行之后呢，它会把这个数据啊，初始化到我们那个数据库里面啊。注意，你在执行这个代码之前，你需要先执行我这个脚本。进行这个数据库和表的一个初始化。初始化之后的话就可以直接执行了，这里面别的不需要改动了，注意你要改点东西。看到没有，要改一下数据库啊。你的一个数据库在哪，把那个IP地址啊，以数据库啊，一个名称啊，对吧，用户名啊，密码啊对吧，这些东西都改一下就可以了。来，我们来执行一下。从那个里面你可以看出来，他最终把数据啊，写到这个FOLLOW00这个表里面。好，我们到这来看一下。好，数据呢，都写进来了。这些测数据啊。这个呢，其实就是历史的一个粉丝关注出去了。那接下来注意我们来看这个主播等级的。也是这个服务端数据库里面数据模拟生成主播等级数据啊。它也是操作数据库。那这里面的话，他会把数据写到这个level user这个表里面来执行一下。OK，我们来确认一下。好，数据都写进了。那这样的话，相当于服务端数据库里面这两份数据呢，我们也都给他触发好了。那其实还剩一份数据，就是这个客端数据，就是那个用户活跃的。gena use active。对吧，客端是模拟生成用户活跃数据。这个呢，还是通过调用我这个接口获取数据。那下面注意这时候呢，它会调用我们那个客户端的那个日志收集服务器，对吧，其实就是一个client。他们最终会调用他，把数据上报给他。所以你的用处呢，也要改成这个，看一下你这个data client，你部署到哪个机器，把这个改一下就可以了。来执行一下。好，这个data可爱呢，他接收到用户上报的这些数据之后呢，他呢也会把它记录日志记录到本地。嗯。嗯。在这他又起到这个did collect点里面。我们取头一条还杠一。看到没有，就这个这个类型是user active，看到没有，都是接格式的啊。那到此为止呢，项目中需要的数据呢，我们都可以正常产生了。</span><br></pre></td></tr></table></figure>



<h3 id="客服端日志接收服务"><a href="#客服端日志接收服务" class="headerlink" title="客服端日志接收服务"></a>客服端日志接收服务</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251102183.png" alt="image-20230425110236188"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251055893.png" alt="image-20230425105526920"></p>
<h3 id="服务端http接口"><a href="#服务端http接口" class="headerlink" title="服务端http接口"></a>服务端http接口</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251101505.png" alt="image-20230425110135498"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251101273.png" alt="image-20230425110105056"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251104599.png" alt="image-20230425110444470"></p>
<h3 id="实时粉丝关注"><a href="#实时粉丝关注" class="headerlink" title="实时粉丝关注"></a>实时粉丝关注</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136630.png" alt="image-20230425111454589"></p>
<h3 id="视频数据"><a href="#视频数据" class="headerlink" title="视频数据"></a>视频数据</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136684.png" alt="image-20230425111654573"></p>
<h3 id="历史粉丝关注"><a href="#历史粉丝关注" class="headerlink" title="历史粉丝关注"></a>历史粉丝关注</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251136744.png" alt="image-20230425112531665"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251125314.png" alt="image-20230425112548087"></p>
<h3 id="历史主播等级"><a href="#历史主播等级" class="headerlink" title="历史主播等级"></a>历史主播等级</h3><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251130414.png" alt="image-20230425113019519"></p>
<h3 id="客户端用户活跃日志"><a href="#客户端用户活跃日志" class="headerlink" title="客户端用户活跃日志"></a>客户端用户活跃日志</h3><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251133562.png" alt="image-20230425113331494" style="zoom:67%;">

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251133869.png" alt="image-20230425113349659"></p>
<h2 id="数据采集聚合"><a href="#数据采集聚合" class="headerlink" title="数据采集聚合"></a>数据采集聚合</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251159150.png" alt="image-20230425115912855"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">咱们前面把数据产生好了，下面就可以进行数据采集了，首先呢是使用这个filebeat呢，将所有日志数据采集到kafka的一个topic中中，把这个日志数据采集到kafka里面。日志数据有三份，服务端有两份，客户端日志有一份。注意，在这具体执行之前，我们需要先把这个zookeeper以及kafka这两个服务给它启动起来。</span><br><span class="line"></span><br><span class="line">启动zk</span><br><span class="line">[root@bigdata01 apache-zookeeper-3.5.8-bin]# bin&#x2F;zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;data&#x2F;soft&#x2F;apache-zookeeper-3.5.8-bin&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">[root@bigdata02 apache-zookeeper-3.5.8-bin]# bin&#x2F;zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;data&#x2F;soft&#x2F;apache-zookeeper-3.5.8-bin&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">[root@bigdata03 apache-zookeeper-3.5.8-bin]# bin&#x2F;zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;data&#x2F;soft&#x2F;apache-zookeeper-3.5.8-bin&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line">启动kafka</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-server-start.sh -daemon config&#x2F;server.properties</span><br><span class="line">[root@bigdata02 kafka_2.12-2.4.1]# bin&#x2F;kafka-server-start.sh -daemon config&#x2F;server.properties</span><br><span class="line">[root@bigdata03 kafka_2.12-2.4.1]# bin&#x2F;kafka-server-start.sh -daemon config&#x2F;server.properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">好，那接下来呢，我们需要在kafka中呢，去创建一些topic。我们主要创建哪些topic呢？就根据我们前面啊，在那个架构图里面分析的，首先第一个是一个大的topic，它里面呢，包含所有的这种日数据。all_type_data_r2p40，因为它是一个大topic里面数据量比较大，所以说呢，我们给它多分一些分区，后期的话呢，就可以提高你一个消费能力了。这个里面呢，存储所有采集过来的日志数据。</span><br><span class="line">我们后面其实还有一个数据分发层，分发层的话，相当于把这里面的数据啊，这个它分发出来。我们服务端有两种数据，一个呢是这个实时的一个粉丝的关注和取消关注数据。</span><br><span class="line">这个它具体那个类型的名称呢，叫user_follow。这个topic这个名称后面为什么不加这种后缀了呀。这是因为啊，这个数据它相当于是我们的原始json数据里面的某一个自动的值，就那个type自动的值，这个日志啊，是之前记录下来的，所以后期我们再用的话，就把它直接拿过来用就行了，就不要再去改它这个值了，改起来就比较麻烦了。并且呢，你这个对应起来也不太好对应，所以说呢，我们就使用那个原始那个数据里面那个type值作为这个topic贝这个名称。</span><br><span class="line"></span><br><span class="line">那下面还有一个video_info。这个里面存储视频信息</span><br><span class="line"></span><br><span class="line">还有一个客户端的。user_active就是用户的活跃数据。存储客户端上报的用户活跃数据。</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-topics.sh --create --zookeeper localhost:2181 --partitions 40 --replication-factor 2 --topic all_type_data_r2p40</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-topics.sh --create --zookeeper localhost:2181 --partitions 5 --replication-factor 2 --topic user_follow</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-topics.sh --create --zookeeper localhost:2181 --partitions 5 --replication-factor 2 --topic video_info</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-topics.sh --create --zookeeper localhost:2181 --partitions 5 --replication-factor 2 --topic user_active</span><br><span class="line">[root@bigdata01 kafka_2.12-2.4.1]# bin&#x2F;kafka-topics.sh --create --zookeeper localhost:2181 --partitions 5 --replication-factor 2 --topic default_r2p5</span><br><span class="line"></span><br><span class="line">注意后面还有一个default_r2p5，所以这个topic是干什么呢？注意现在啊，我们要把这个里面的数据给它分发到这几个topic里面。那在分发的时候有可能有一些数据啊，它里面没有type字段呀，或者说那个type字段的值不是这三个里面的。也就是说那个数据异常，这样的话，你需要把那个异常数据放到这个topic。这里面的存储无法具体分配到对应topic的异常数据。</span><br><span class="line"></span><br><span class="line">所以说呢，我们下面就需要去创建这些topic。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251200726.png" alt="image-20230425120032836"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们呢，就可以使用filebeat的去采集数据了，注意现在filebeat呢，我们还没有安装呢。需要安装到哪些机器上面呢？注意你要看你之前那个客户端的那个接口，以及服务端的接口，你都部署到哪些服务器上面，我在这呢，都给它部署到这个bigdata04上面了。因为filebeat呢，要采集data_collect这个接口记录的日志，以及server_inter这个接口记录的日志，所以说呢，你后期这两个接口你部署到哪台机器上面，那么你在对应的机器上就需要部署这个filebeat去采集数据。</span><br><span class="line"></span><br><span class="line">解压一下</span><br><span class="line">注意这个filebeat就是一个采集工具。所以说呢，使用起来很简单，我们只需要在里面指定输入和输出就可以。我们先修改它的配置文件，在这个目录下面有一个这个filebeat.yml这个配置文件</span><br><span class="line"></span><br><span class="line">注意它是一个YML格式的，不是那种XML这种格式的啊，这是种新型的那种配置文件格式。</span><br><span class="line"></span><br><span class="line">你可以在这配置它的输入。你看它这有一个什么呀，这个类型是日志的，但是目前这个呢没有开启。我们在这呢，想先测试一下。在测试的时候呢，我就在这个配置文件里面，把这个输入啊，给它指定成标准的一个输入，就是键盘输入，输出的话呢，就把它指定成控制台。这样分析起来好分析，也比较直观。那怎么加呢？注意其实我们在这里面需要加一个输入，就是配置一个输入。对吧，你就按照它这个格式去写就行了，冒号注意后面一个空格，注意这个空格是不能少的。找那个输出。没有output。输出注意你看它默认呢，现在开启了一个什么呀，这个输出呢，是把数据输出的这个elasticserch，那现在我们先不用这个，你把它注掉。就指定那个console，注意下面呢，我们来加一些参数，注意下面这个缩进，我能不能使用那个tab，不行，必须使用空格。你可以使用两个或者四个。pretty。注意这个表示什么意思啊，它表示啊，会把你这个输出的结果啊，给你格式化一下，要不然是非常乱的啊。大家后期啊，在改这个配置文件的时候一定要注意啊，首先是这个冒号后面这个空格不能少，还有呢，就是说你这个在做缩进的时候不能使用制表符，要使用空格，官方建议使用四个，你用两个啊三个啊都可以啊。那下面呢，我们需要把这个配置好的这个配置文件呢，给它上传上去行吗？保存一下。如果说你对这个文件熟悉了之后，你可以直接在这里面去改都是可以的。不熟悉的话，建议呢，你还是把这个配送件拿到本地去，改完之后呢再传上来。直接覆盖就行啊。那这样的话就可以啊，下面我们就可以启动filebeat</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251209159.png" alt="image-20230425120937212"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251211306.png" alt="image-20230425121132023"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251212200.png" alt="image-20230425121239236"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bigdata04 filebeat-7.4.2-linux-x86_64]# .&#x2F;filebeat -c filebeat.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251218213.png" alt="image-20230425121824126"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输出了一堆东西。虽然是一堆啊，还是有格式的，是一个阶层格式的，注意这个呢，就是因为我们在这加了这个属性，等于true，它呢会对你返回的数据呢，你做一个格式化。反馈的数据，你看就这个message里面内容，其他内容呢，都是它里面默认加的啊。接着你想停掉的话，直接CTRLC对吧。</span><br><span class="line"></span><br><span class="line">接下来我们需要继续修改配置文件，因为我们是希望filebeat的可以采集日志文件中的数据，将数据呢采集到kafka中。把刚才我们那个配置啊都给它删掉。然后呢，我们把这个基于日志的这个类型啊，给它开启了。这样的话它就可以读取文件了，你看path里面指定一些路径，注意你可以指定一个或者多个都可以。你指定一个的话，你可以这样，你指定一个目录下面可以使用那种通配符也是OK的啊。所以说的话，它可以监控多个目录里面的多个文件。这是输入就配置好了</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251222076.png" alt="image-20230425122235895"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">接下来我们需要配置输出。这是一个输出组件，注意在这我们需要指定那个kafka的一个输出组件，那在这都需要指定什么配置呢？这个信息呢，到他那个官网上面是可以找到的啊，所以在边我就直接拿过来，你看output.kafka，把数据呢，输入到卡夫卡里面，直行卡卡的一个博物块地址对吧。123。还有这个topic，我们要把这个数据呢写到这里面。下面这几个配置你不用改就行了，这个呢表示啊，它往这个topic里面这些分区写数据的一个规则。这个表示卡里面那个艾机制是吧。这个呢是就是往里面写数据的时候，对这个数据15度压缩，这块呢，使用那个机会压缩可以提高性能。这个呢，表示呢，每一条数据最大的一个字节数量。好这样就可以了，你们下用的时候呢，有可能要改这以及这对吧，如果说你都和我的一样的话，其实都不用改。OK，这样的话就可以了，下面呢，把这个配置文件重新再传一下。</span><br><span class="line"></span><br><span class="line">这样就可以实现将服务端日志和客户端日志全部都采集到kafka中的all_type_data_r2p40这个topic中了。</span><br><span class="line"></span><br><span class="line">注意：filebeat需要部署在所有服务端接口机器和客户端日志收集机器上，</span><br><span class="line"></span><br><span class="line">在实际工作中，服务端接口机器会有多个，我们当时的服务端接口机器有100多台，客户端日志收集机器是有6台，在部署的时候是通过运维同学开发的部署工具批量部署的，要不然一个一个部署会疯的。</span><br><span class="line">在这由于服务端接口和客户单日志收集服务都在bigdata04上面，所以我就只需要在bigdata04上部署一套即可。</span><br><span class="line"></span><br><span class="line">在这里我们暂时先不启动filebeat进程，等我们把采集模块中所有的配置全部修改好了以后，从后面挨个开始启动进程，这样不会漏数据。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304251225756.png" alt="image-20230425122506901"></p>
<h2 id="数据分发"><a href="#数据分发" class="headerlink" title="数据分发"></a>数据分发</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面呢，我们来看一下数据分发层，就是使用实现对采集到kafka指定topic里面的数据啊进行分发。咱们前面呢，把这个日数据采集过来啊，全部都放到kafka一个大的topic里面了，所以说下面呢，我们需要使用flume对这个大的topic里面数据啊进行分发，分发到一些小的topic里面，这样可以方便使用。注意，那这样的话，我们就需要在这个flume里面增加一配置文件，就是从那个大的topic里面消费数据，通过拦截器获取数据中的一个type自段的值作为输出kafka的一个topic的名称。这个配置文件呢，在这儿我已经写好了，我们来直接看一下</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#source+channle+sink的名字</span><br><span class="line">agent.sources &#x3D; kafkaSource</span><br><span class="line">agent.channels &#x3D; fileChannl</span><br><span class="line">agent.sinks &#x3D; kafkaSink</span><br><span class="line"></span><br><span class="line"># 指定source使用的channel</span><br><span class="line">agent.sources.kafkaSource.channels &#x3D; fileChannl</span><br><span class="line"># 指定sink需要使用的channel的</span><br><span class="line">agent.sinks.kafkaSink.channel &#x3D; fileChannl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------- kafkaSource相关配置-----------------</span><br><span class="line">agent.sources.kafkaSource.type &#x3D; org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">agent.sources.kafkaSource.batchSize &#x3D; 1000</span><br><span class="line">agent.sources.kafkaSource.batchDurationMillis &#x3D; 1000</span><br><span class="line">agent.sources.kafkaSource.kafka.bootstrap.servers &#x3D; bigdata01:9092,bigdata02:9092,bigdata03:9092</span><br><span class="line">agent.sources.kafkaSource.kafka.topics &#x3D; all_type_data_r2p40</span><br><span class="line">agent.sources.kafkaSource.kafka.consumer.group.id &#x3D; flume_con_id_1</span><br><span class="line"></span><br><span class="line">#----------------- 拦截器 -------------------</span><br><span class="line"># 定义拦截器</span><br><span class="line">agent.sources.kafkaSource.interceptors &#x3D; i2 i1</span><br><span class="line"># 设置拦截器类型</span><br><span class="line">agent.sources.kafkaSource.interceptors.i1.type &#x3D; regex_extractor</span><br><span class="line"># 设置正则表达式，匹配指定的数据，这样设置会在数据的header中增加topic&#x3D;aaa</span><br><span class="line">agent.sources.kafkaSource.interceptors.i1.regex &#x3D; &quot;type&quot;:&quot;(\\w+)&quot;</span><br><span class="line">agent.sources.kafkaSource.interceptors.i1.serializers &#x3D; s1</span><br><span class="line">agent.sources.kafkaSource.interceptors.i1.serializers.s1.name &#x3D; topic</span><br><span class="line"># 避免遇到数据中没有type字段的，给这些数据赋一个默认topic【注意：这个拦截器必须设置】</span><br><span class="line">agent.sources.kafkaSource.interceptors.i2.type &#x3D; static</span><br><span class="line">agent.sources.kafkaSource.interceptors.i2.key &#x3D; topic</span><br><span class="line">agent.sources.kafkaSource.interceptors.i2.preserveExisting &#x3D; false</span><br><span class="line">agent.sources.kafkaSource.interceptors.i2.value &#x3D; default_r2p5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#------- fileChannel相关配置-------------------------</span><br><span class="line"># channel类型</span><br><span class="line">agent.channels.fileChannl.type &#x3D; file</span><br><span class="line">agent.channels.fileChannl.checkpointDir &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;all_type_data&#x2F;checkpoint</span><br><span class="line">agent.channels.kafka2HdfsShow.dataDirs &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;all_type_data&#x2F;data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#---------kafkaSink 相关配置------------------</span><br><span class="line">agent.sinks.kafkaSink.type &#x3D; org.apache.flume.sink.kafka.KafkaSink</span><br><span class="line">agent.sinks.kafkaSink.kafka.topic &#x3D; default</span><br><span class="line">agent.sinks.kafkaSink.kafka.bootstrap.servers &#x3D; bigdata01:9092,bigdata02:9092,bigdata03:9092</span><br><span class="line">agent.sinks.kafkaSink.kafka.flumeBatchSize &#x3D; 1</span><br><span class="line">agent.sinks.kafkaSink.kafka.producer.acks &#x3D; 1</span><br><span class="line">agent.sinks.kafkaSink.kafka.producer.linger.ms &#x3D; 1</span><br><span class="line">agent.sinks.kafkaSink.kafka.producer.compression.type &#x3D; snappy</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来就把它呢传上去就可以了，注意如果说我们需要在一台机器中启动多个flume进程的时候，最好在里面复制多个conf目录，因为如果在一个conf目录中启动多个agent的进程的话，多个agent的进程的日志信息会混到一块，后期排查问题会很麻烦啊，这个我们之前呢讲过了对吧啊，所以说呢，在这。进到这个。都门面。我们来复制一个。打靠谱。告不告？卡不卡？高不高相以我们从卡夫卡里面读出去，再把数据写到卡夫卡里面。进到里面。改一下他这个log的这个配置文件。把那个改一下，搞搞不搞搞卡不卡。好，这样的话就可以了。嗯。OK，那接下来我们在这里面来创建这个配置文件，就是刚才我们分析的这个。敢不敢杠后杠？敢不敢点。com？嗯。我们就组织一下。好，这样就可以了，注意这块搞定之后呢，我们就需要往下面走了，在这啊，我们也先不启动啊，那我们把这个数据落盘这块也搞定之后呢，从后往前启动。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252144970.png" alt="image-20230425214444152"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252145763.png" alt="image-20230425214458087"></p>
<h2 id="数据落盘"><a href="#数据落盘" class="headerlink" title="数据落盘"></a>数据落盘</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252156385.png" alt="image-20230425215638800"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">接下来我们来看一下这个数据落盘层。我们需要使用采集指定topic各种数据进行落盘，便于离线计算。你看咱们前面呢，把这个数据呢，全部都采集到kafka这个大的topic里面，接下来做了一个分发，分发之后后面我们就要做这个落盘了。把我们需要落盘的数据呢，给它呢，落到这个HDFS上面，注意如果这里面这个大topic里面的所有类型的数据呢，我们都需要落盘的话，我们就可以直接读取这个大topic里面的所有数据，然后呢，使用这个拦截器。根据数据类型把它们呢保存到hdfs的多个目录中，这样呢比较方便，不过在我们这个项目中，这个大的topic里面一共有三种类型的数据，其中呢，有两种数据我们是需要进行落盘后期进行离线计算的。有一种数据呢是不需要的，只有实时计算上讲会用的，所以说我们可以使用两个flume agent来对我们需要的数据执行落盘操作。当然了，我们也可以啊，只使用一个flume agent的，那你这里面啊，也可以使用拦截器，只获取我们需要落盘的那两种数据，这样也是可以的，这个呢，给大家留一个作业，大家下去自己研究一下。使用flume拦截器如何呢？获取我们需要的两种数据，然后呢，分别把它呢落盘到hdfs的不同目录下面。</span><br><span class="line"></span><br><span class="line">那我在这呢，就使用两个agent来实现了，我们需要落盘的这两个topic呀，分别是这个user_active和这个video_info。所以说呢，在这我还需要复制两个目录。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252211650.png" alt="image-20230425221141206"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那我们进去去改一下那个logo的配置。那接下来我们还需要在这两个目录里面创建对应的一个配置文件，这两个配置文件啊，我也提前写好了，我们来看一下。</span><br><span class="line"></span><br><span class="line">因为这个东西啊，它就是一个体力活。咱们前面用过很多次了啊，没有什么技术含量。首先看这个user active，这都没什么好处了。S呢，是一个卡夫卡S，你读取这个user active。那个group使用这个be China。注意，下面是这个H里边的think。按T分目录存储就行了，放到对目录下面一个user。这就可以。那这个呢，是一个video。对吧，它读取的是一个video in这个topic。然后呢，就是说放到这个data木下面有个video。对吧，这是那个年月日。看天分，母乳好。那我在这呢，把这个复制一下。这是一个user active。脸卡不卡？到as。到。user。active。com。好，这个搞定。下一个先进到这个目录里面这个音符，把这个呢复制一下。VI、卡夫卡杠杠、video info。好。好，那这两个呢，我们都配置好了。所以接下来我们需要先确认一下这个含毒不集群啊，是否启动。对吧，我们之前已经起来了啊。好，那到此为止啊，这个采集相关的这个配置呢，我们都修改好了，下面呢，我们就要来启动一下。我们要从后往前启动，所以说呢，我们先启动这个数据落盘的这个辅助。我们来启动一下。诺哈普。b my name。agent康复指定配置文件跟目录。这个是com user active先求这个。进行配置文件刚刚。靠谱。在康复，然后呢。有点active下面有一个。啊，不搞搞HS user active com这个文件。agent。好，接下来呢，是第二个，我把前面这些能敷的呢复制过来。这个呢是video。刚刚看。六。下面有一个卡杠，杠HS杠video杠infor.com。最后是这个大纲内。agents。嗯。确认一下。这是一个，这是一个对吧，这两个呢都起来，嗯。这就是这两个数据落盘的一个a的进程啊，那接下来再往回推，我们需要把那个数据分发那个给它起下来。说。NG到康复。到卡夫卡，到卡夫卡。刚刚康复杠。这个木下面有一个。卡夫卡，卡夫卡点。com。我们之前少写一个这个F的这个强迫症，我给他改一下啊。来确认一下，确实少一个F，这个也不影响啊，只不过看起来有点别扭。好。这就可以了。怎么呢，重新来启动的啊，刚才也没启动成功啊no。b agent。等到。卡夫卡，卡夫卡，然后呢，刚刚。哎。卡夫卡，卡夫卡下面有一个卡夫卡，卡夫卡加。祷告，name isn&#39;。好。可以确认一下啊。对吧，这个也启动好。那最后呢，我们就要启动那个Bob的采集程了。接着来启动。牛逼了，杠C。比点两秒。注意啊，针对这个feel进程啊，正式启动的时候也需要使用这个no ho，把它放到后台运行在这里，我们为了一会儿使用方便，所以说我先在前台启动了，对吧。我们按一个回车把它启动起来，那接下来呢，我们就可以启动生成数据的程序了。注意在这呢，我们先执行那个generate real time for这个实时生成那个粉丝关注和取消关注的数据啊。来执行一下。</span><br></pre></td></tr></table></figure>

<h3 id="kafka-hdfs-user-active-conf"><a href="#kafka-hdfs-user-active-conf" class="headerlink" title="kafka-hdfs-user-active.conf"></a>kafka-hdfs-user-active.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#source+channel+sink的名字</span><br><span class="line">agent.sources &#x3D; kafkaSource</span><br><span class="line">agent.channels &#x3D; kafka2Hdfs</span><br><span class="line">agent.sinks &#x3D; hdfsSink</span><br><span class="line"></span><br><span class="line"># 指定source使用的channel名字</span><br><span class="line">agent.sources.kafkaSource.channels &#x3D; kafka2Hdfs</span><br><span class="line"># 指定sink需要使用的channel的名字</span><br><span class="line">agent.sinks.hdfsSink.channel &#x3D; kafka2Hdfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------- kafkaSource相关配置-----------------</span><br><span class="line"># 定义消息源类型</span><br><span class="line">agent.sources.kafkaSource.type &#x3D; org.apache.flume.source.kafka.KafkaSource</span><br><span class="line"># 定义kafka所在zk的地址</span><br><span class="line">agent.sources.kafkaSource.kafka.bootstrap.servers &#x3D; bigdata01:9092,bigdata02:9092,bigdata03:9092</span><br><span class="line"># 配置消费的kafka topic</span><br><span class="line">agent.sources.kafkaSource.kafka.topics &#x3D; user_active</span><br><span class="line"># 配置消费者组的id</span><br><span class="line">agent.sources.kafkaSource.kafka.consumer.group.id &#x3D; user_active_con_1</span><br><span class="line"></span><br><span class="line">#------- fileChannel-1相关配置-------------------------</span><br><span class="line"># channel类型</span><br><span class="line">agent.channels.kafka2Hdfs.type &#x3D; file</span><br><span class="line">agent.channels.kafka2Hdfs.checkpointDir &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;user_active&#x2F;checkpoint</span><br><span class="line">agent.channels.kafka2Hdfs.dataDirs &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;user_active&#x2F;data</span><br><span class="line"></span><br><span class="line">#---------hdfsSink 相关配置------------------</span><br><span class="line">agent.sinks.hdfsSink.type &#x3D; hdfs</span><br><span class="line"># 注意, 我们输出到下面一个子文件夹datax中</span><br><span class="line">agent.sinks.hdfsSink.hdfs.path &#x3D; hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;user_active&#x2F;%Y%m%d</span><br><span class="line">agent.sinks.hdfsSink.hdfs.writeFormat &#x3D; Text</span><br><span class="line">agent.sinks.hdfsSink.hdfs.fileType &#x3D; DataStream</span><br><span class="line">agent.sinks.hdfsSink.hdfs.callTimeout &#x3D; 3600000</span><br><span class="line"></span><br><span class="line">#当文件大小为104857600字节时，将临时文件滚动成一个目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollSize &#x3D; 104857600</span><br><span class="line">#events数据达到该数量的时候，将临时文件滚动成目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollCount &#x3D; 0</span><br><span class="line">#每隔N s将临时文件滚动成一个目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollInterval &#x3D; 3600</span><br><span class="line"></span><br><span class="line">#配置前缀和后缀</span><br><span class="line">agent.sinks.hdfsSink.hdfs.filePrefix&#x3D;run</span><br><span class="line">agent.sinks.hdfsSink.hdfs.fileSuffix&#x3D;.data</span><br></pre></td></tr></table></figure>

<h3 id="kafka-hdfs-video-info-conf"><a href="#kafka-hdfs-video-info-conf" class="headerlink" title="kafka-hdfs-video-info.conf"></a>kafka-hdfs-video-info.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#source+channel+sink的名字</span><br><span class="line">agent.sources &#x3D; kafkaSource</span><br><span class="line">agent.channels &#x3D; kafka2Hdfs</span><br><span class="line">agent.sinks &#x3D; hdfsSink</span><br><span class="line"></span><br><span class="line"># 指定source使用的channel名字</span><br><span class="line">agent.sources.kafkaSource.channels &#x3D; kafka2Hdfs</span><br><span class="line"># 指定sink需要使用的channel的名字</span><br><span class="line">agent.sinks.hdfsSink.channel &#x3D; kafka2Hdfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-------- kafkaSource相关配置-----------------</span><br><span class="line"># 定义消息源类型</span><br><span class="line">agent.sources.kafkaSource.type &#x3D; org.apache.flume.source.kafka.KafkaSource</span><br><span class="line"># 定义kafka所在zk的地址</span><br><span class="line">agent.sources.kafkaSource.kafka.bootstrap.servers &#x3D; bigdata01:9092,bigdata02:9092,bigdata03:9092</span><br><span class="line"># 配置消费的kafka topic</span><br><span class="line">agent.sources.kafkaSource.kafka.topics &#x3D; video_info</span><br><span class="line"># 配置消费者组的id</span><br><span class="line">agent.sources.kafkaSource.kafka.consumer.group.id &#x3D; video_info_con_1</span><br><span class="line"></span><br><span class="line">#------- fileChannel-1相关配置-------------------------</span><br><span class="line"># channel类型</span><br><span class="line">agent.channels.kafka2Hdfs.type &#x3D; file</span><br><span class="line">agent.channels.kafka2Hdfs.checkpointDir &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;video_info&#x2F;checkpoint</span><br><span class="line">agent.channels.kafka2Hdfs.dataDirs &#x3D; &#x2F;data&#x2F;filechannle_data&#x2F;video_info&#x2F;data</span><br><span class="line"></span><br><span class="line">#---------hdfsSink 相关配置------------------</span><br><span class="line">agent.sinks.hdfsSink.type &#x3D; hdfs</span><br><span class="line"># 注意, 我们输出到下面一个子文件夹datax中</span><br><span class="line">agent.sinks.hdfsSink.hdfs.path &#x3D; hdfs:&#x2F;&#x2F;bigdata01:9000&#x2F;data&#x2F;video_info&#x2F;%Y%m%d</span><br><span class="line">agent.sinks.hdfsSink.hdfs.writeFormat &#x3D; Text</span><br><span class="line">agent.sinks.hdfsSink.hdfs.fileType &#x3D; DataStream</span><br><span class="line">agent.sinks.hdfsSink.hdfs.callTimeout &#x3D; 3600000</span><br><span class="line"></span><br><span class="line">#当文件大小为104857600字节时，将临时文件滚动成一个目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollSize &#x3D; 104857600</span><br><span class="line">#events数据达到该数量的时候，将临时文件滚动成目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollCount &#x3D; 0</span><br><span class="line">#每隔N s将临时文件滚动成一个目标文件</span><br><span class="line">agent.sinks.hdfsSink.hdfs.rollInterval &#x3D; 3600</span><br><span class="line"></span><br><span class="line">#配置前缀和后缀</span><br><span class="line">agent.sinks.hdfsSink.hdfs.filePrefix&#x3D;run</span><br><span class="line">agent.sinks.hdfsSink.hdfs.fileSuffix&#x3D;.data</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后将hadoop集群启动起来，因为数据落盘会使用到HDFS</span><br></pre></td></tr></table></figure>

<h3 id="数据落盘-1"><a href="#数据落盘-1" class="headerlink" title="数据落盘"></a>数据落盘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">好 到这为止，采集需要的配置都修改好了</span><br><span class="line">下面我们就来启动一下</span><br><span class="line">1：先启动数据落盘的flume</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252219426.png" alt="image-20230425221947341"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252220669.png" alt="image-20230425222021013"></p>
<h3 id="数据分发-1"><a href="#数据分发-1" class="headerlink" title="数据分发"></a>数据分发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2：再启动数据分发的flume</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252225085.png" alt="image-20230425222459145"></p>
<h3 id="数据采集聚合-1"><a href="#数据采集聚合-1" class="headerlink" title="数据采集聚合"></a>数据采集聚合</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3：最后启动filebeat采集进程</span><br><span class="line"></span><br><span class="line">注意：针对filebeat进程，正式启动的时候也需要使用nohup 放在后台运行，在这里我们为了一会使用方便，所以先在前台启动。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252227824.png" alt="image-20230425222700964"></p>
<h3 id="执行数据生成程序"><a href="#执行数据生成程序" class="headerlink" title="执行数据生成程序"></a>执行数据生成程序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4：接下来启动生成数据的程序</span><br><span class="line">先执行GenerateRealTimeFollowData</span><br><span class="line">验证效果</span><br><span class="line">查看all_type_data_r2p40这个topic中的数据</span><br><span class="line"></span><br><span class="line">验证</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252230600.png" alt="image-20230425223043250"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252231054.png" alt="image-20230425223117407"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以执行成功了，那我们来验证一下结果。我们到那个卡夫卡里面来消费一下。基于console的。注意这个内容还是比较多的，但是我们可以大致看一下啊，你看。这是一条数据，是不是很乱呀？我们的日志数据没有这么乱吧，并且我们的日志数据里面也没有这个东西。对吧，我们的日志数据里面其实是这些东西在这，你看它其实啊，其实在这面又封装了一层，他把我这个具体的业务数据啊，给封装到这个message字段里面。注意这些字段的话，相对来讲是filebeat默认生成的，那这些字段呢，它不是我们需要的，我们希望啊，只记录我们的原始日志即可。那怎么解决这个问题呢？可以解决啊，我们需要在那个filebeat那个配置文件里面加一个配置。需要在filebeat中的output.kafka里面增加codec.format配置。在这相当于啊，你要对它输出这个数据啊，做一个格式化。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252235554.png" alt="image-20230425223504841"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CD format。做一个格式化。四六类形的。对。我们呢，只取它里面的这个东西，哎，问号首先呢，括括号中括号我们只取里面那个message。所以这个配置的意思呢，就是说我们从这个数据里面。你看它这个采集过来数据里面有很多字段，我们只需要message字段里面内容，其实这里面就是我们的原始的日志数据。然后把这个filebeat再停一下。你再来启动，我们再来执行这个生成数据的这个。看到没有？这个就正常了，这样就可以</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252237920.png" alt="image-20230425223717162"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们再来查看一下这个user_follow这个topic，这个看一看它里面能不能消费到数据，如果能消费到数据，就说明那个flume的数据分发过程是没有问题的啊</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252240353.png" alt="image-20230425224013711"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">收到了吧。注意你在这能收到就说明啊，我们中间那个flume的分发程序是OK的，他从那个大的topic里面把这个数据读出来，然后呢写到这里，这样就可以好。那接下来我们再来执行两个程序。一个是这个active。其实呢，我们之前已经执行过了，在这我们再重新执行一下啊。然后重新呢，再生成一批数据，就是往那个日志文件里面再写一批啊，因为你调用接口，这个接口就会记录了，以及这个video info。好，这个执行成功之后呀，注意我们就可以到那个HDPS里面去确认一下结果数据了。因为你这个执行之后啊，他呢，这个接口就会把那个日志记录到本地。这个接口呢，就会把那个日志数据啊，记录到这个本地的日文件里面，然后filebeat呢，发现你里面啊有新增数据，所以说他就把这个数据给读出来，读出来之后呢，把它呢，采集到那个大的topic，就是all type data那个topic里面。然后呢，这里面有数据之后，后面那个的数据分发程序，它就会读取这个数据，对吧，对这个数据做分发，然后呢，把这个数据分发到不同的那个子topic里面，那我们最后呢，还有一个flume数据落盘层。他呢，就会从那个子topic里面把那些数据呢读出来，最终呢落到hdfs</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以下面我们来验证一下。看到没有，这个user active，对这个都是有的。好，这个目录来我们直接查看一下它里面的数据啊。使用管道来取，前一条取一条就行，好里面有数据。那说明是OK的，那其实对应的我可以直接把这个改一下，改成video。看一下他们的数据。也是有了。没有问题，好。那在这我们都可以获取到数据，那就说明了是没有问题的，这就意味着我们前面的整个数据采集流程是通的。那大家在下面做实验的时候呀，我估计啊，可能会遇到各种各样的问题啊，就是大家在操作这一块的时候，如果发现最终啊，看不到我们这个希望的结果。那你就需要一步一步去排查，你要确认一个数据到了哪一步。你先看一下那个大套贝里面有没有数据，然后呢，再看一下那个子套贝壳里面有没有数，如果子套贝格里面也有数据，那最终hps里面没数据，那肯定是你那个数据落盘程序有问题。所以说你需要一点点去分析啊。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252308990.png" alt="image-20230425230808125"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252309870.png" alt="image-20230425230907753"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252309790.png" alt="image-20230425230920558"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">针对这个filebeat呀，我再多说一点，这个filebeat它在采集日文件中的数据的时候呢，它会将日文件数据的采集的一个偏移量啊，记录到本地文件里。所以说它在这会记录一下，这样话你filebeat给重启之后，它呢会读取这个文件，然后呢，根据你上一次记录的off继续往下面消费。它可以保证，就算你那个filebeat要停了，那在它停的中间，你往那个日里面记录数据，它后期启动之后还可以把它呢采集过来是这样。注意了，如果说呢，我们想要让这个filebeat的重启之后啊，继续重新开始消费。这样怎么办呢？暴力一点的话，我们可以直接把这个。这个data目录啊，给它删掉，你删掉之后这些信息是不是就没了，没了之后它就认为它是一个新文件，就从头开始读了啊，这个需要注意一下。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252316813.png" alt="image-20230425231605565"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还有一点就是我们在使用filebeat的时候啊，如果发现filebeat没有正常工作，这个时候呢，我们需要去查看filebeat的日志文件，来排查具体是什么问题，因为有时候有一些错误信息啊，他不会暴露到这个工作台上面，它会记录到日志文件里面。像few b的下面有一个move。看到没有，它下面有这个这文件，注意你看的话就看这个，它后面这个相当于是一些备份的啊。你直接看这个就行。这是最新的一些日志。这些呢，是之前的一些老的日志。如果说他有一些错误信息在这里面就可以看。你在这儿可能看不到，它不会暴露到这个地方啊，你说呢，我把这个飞票启动了，也没见他报错呀，结果呢，他也没有把数据采集到我的卡夫卡里面，那所以说你就需要来这儿来看啊，看那个日文面。好，那针对服务端日志和这个客端日志的一个数据采集啊，我们先讲到这儿，在这呢，大家主要掌握数据采集的整理思路，重点是里面那个数据聚合，数据分发这两个步骤，那个数据落盘呢，倒没什么特殊的，对吧，咱们之前已经用过很多次。</span><br></pre></td></tr></table></figure>

<h2 id="采集服务端数据库数据"><a href="#采集服务端数据库数据" class="headerlink" title="采集服务端数据库数据"></a>采集服务端数据库数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">前面呢，我们把这个服务端日志以及客户端日志呢采集过来，下面呢，我们还需要将服务端数据库的数据也采集过来。咱们前面分析了啊，由于历史粉丝关注数据呢，只需要导出一次，所以说呢，没必要使用sqoop，那还有一份数据呢。是那个每日的主播等级数据对吧？所以这份数据呢，我们在最开始的时候会将数据库里面的全量数据导出来一份，后期只需要根据表中的更新字段获取发生了变化的数据即可，这样每天需要导出的数据量就很小了，属于增量采集。这时候呢，可以选择使用sqoop，其实呢也可以选择使用shell脚本，sqoop的使用在上一个项目中我们已经用过了，所以接着呢，我们来讲点不一样的，我来使用shell脚本，将mysql中的数据导出来，所以说么，这两份数据我全部呢使用mysql脚本。把它倒出来。那首先呢，我们使用这个mysql里面那个-e这个命令，将这个具体的查询命令啊准备好。</span><br><span class="line"></span><br><span class="line">注意我其实在这呢，可以直接操作我Windows本地的那个MYSQL，这个里面它默上是有那个MYSQL客户端的，你如果没有的话，你就装一下啊，我们使用mysql -e后面的话就可以写具体的sql了。因为你现在也不是连本地的马，你是连其他机器的马，对吧。我们在这个list里面连接我们Windows里边那个马。那我们Windows的那个机器这个IP是也有2.168.182.1。这样就可以，这也可以编了哈。那这里面写了一个参考，我们先写那个历史粉丝关注数据啊。再来呢，它里面有两列，一个UID，一个呢是UID。from我们这个库的名称啊，是一个点。follow。零零，我们先查这一张表。看到没有，它是可以执行的。那以及呢，我们还要查询这个每日主播等级数据啊，就每天发生了变化的那些主播数据。注意它里面的话字段比较多。注意它里面有一个update time，就是更新字段啊。就这个，如果说这里面这个数据发生了变化。某一个字段被改了，那么这个就会变化，所以说我们每天呢，就根据它去抽取数据。up time。大于等于。所以我们这里面这个日期啊，目前的话看一下。那是2月1号对吧。26年2月1号，所以说我在里面这样来，我就把这些数据给它查出来，二六杠零二杠零幺。000000对吧。只要凌晨开始按着。update time。小于等于。2026杠零二杠零一。23:59:59，这样的话就可以把这些数据全都查出来。没问题吧，也是可以的啊。好，那这两条命令啊</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">历史粉丝关注数据</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252328190.png" alt="image-20230425232805742"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252328755.png" alt="image-20230425232851743"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252350277.png" alt="image-20230425235033202"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每日主播等级数据</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252351285.png" alt="image-20230425235117301"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252351462.png" alt="image-20230425235132504"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">验证成功之后呢，我们就需要把这个命令啊公布到脚本里面，首先是这个用户历史关注数据，注意这份数据啊。它其实呢是分表存取。你看我在这其实只是创建了一部分表，它有很多张。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252352125.png" alt="image-20230425235203139"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这个分表逻辑是什么样子的，你看它里面存储的是什么呀，是一个用户的一个UID啊。所以说这样的，它会根据这个用户的UID来计算一个MD5值。你这个MD5值是什么样子的呢？给他搜一下。对吧，你看它的MD5值其实就是这样。就是类似于这么一串。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304252354258.png" alt="image-20230425235426902"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">我们呢，会根据这个用户的UID去计算一个MD5值，然后呢获取最后两位字符，然后呢拼接到这个follow后面。组装一个新的表名。这样话呢，他会算一下你那个UID最后两位是什么，然后呢，存到对应的表里面。这是它一个分表逻辑啊，那你后期查的话呢，也会根据这个UID计算MD5获取最后两位，然后呢来前面呢拼那个follow下划线，后面的话拼上了两位，这样就找到它对应的一个表。</span><br><span class="line"></span><br><span class="line">注意这种组合呀。这两位你看它有可能是零到九以及a到z中的任意一个，所以说呢，这位它呢有36种情况，这一位呢也是36种情况，你26个英文字母加上零到九有十个，一共是36，每一位都三十六三十六乘以36是吧。1296张表。所以说呢，我们其实在实际过程中，我们需要将这1296张表中的数据全部都导出来，所以我在这呢，也没有建那么多张表，太多了啊，所以说在这建了一部分，在这大家知道它是一个分表的就行啊。然后呢，你要知道它这个分表规则。OK。这样的话，一会我们采集数据，我就先采集一张就行，但是呢，我会写脚本，让他可以支持把这个1296张表中的数据全部都采集出来。我们把那个脚本写好，但是具体采的时候，我们就只采这一张表就行啊，因为就它里面有数据。</span><br></pre></td></tr></table></figure>

<h3 id="extractFollower-sh"><a href="#extractFollower-sh" class="headerlink" title="extractFollower.sh"></a>extractFollower.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">好，下面我们来开发第一个脚本。我现在来写。简单号。它保存一下啊，给它起个名字叫attracted。要抽取follow。是脚本。只需要执行一次即可。你只需要抽取自己的是历史数据，后期的话我们还有一份实时数据，就可以实时维护了。针对1296张表。需要使用这个双层或循环。动态生成表明。I。12345678。所以后面还有呢a。FGH。I z KL mn pqr。ST。UVWXYZ，好吧，这题又是个直接画啊度。这是一层，你里面还要套一层呢。因为我们要批那个表明的最后两个字符嘛，对吧。G。这个我就不是文桥了。50块。好。那现在里面了，我来艾打印一下。就把那个表明啊给他批出来。哎。当然，这行吧。其实你在这儿只要能把这1000多张表的那个表明全都拼出来，那继续把它导出去，那不就很简单了吗？对吧？我先在这呢，先写一个导师的一个脚本。马杠u杠P杠H。18291。藏意后面是circle。这个UIDUID。from。video。零零。注意这样的话就可以获取那些数据了，然后我把这个数据呢，给它重定向。到这个里面这个soft。video recommend。就使用这个表名作为文件里面的前缀log，这样的话其实就可以把这张表数据给它导出来了。你如果把这个东西放到这儿。好把重要啊，我们一会执行不执行，你把里面改一下是不是就行了，你这个东西。还有那个。这东西，然后那个是不是可以了呀。你只要说这个循环执行完，其实就可以把所有数据全都倒出来。我在这通过IO把这个表名导一下就行，行吗。最后的话呢，我们只是把这一个标点数据给它打开就行。好，那接下来呢。先试一下啊，重新在这儿来建一个脚本。video&#39;。到了。OK，这样就可以了，那接下来我们来执行SH。看到没有，前面都打印出来了，没问题啊。那我们来确认一下，这个木下面有没有产生那个零零.log。产生了吧。看一下里面的数据。没问题吧，没问题啊好，</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># 此脚本只需要执行一次即可</span><br><span class="line"></span><br><span class="line"># 针对1296张表，需要使用双层for循环动态生成表名</span><br><span class="line">for i in 0 1 2 3 4 5 6 7 8 9 a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br><span class="line">do</span><br><span class="line"> for j in 0 1 2 3 4 5 6 7 8 9 a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br><span class="line"> do</span><br><span class="line">	echo follower_$&#123;i&#125;$&#123;j&#125;</span><br><span class="line">	#mysql -uroot -padmin -h 192.168.182.1 -e &quot;select fuid,uid from video.follower_$&#123;i&#125;$&#123;j&#125;&quot; &gt;&gt; &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;follower_$&#123;i&#125;$&#123;j&#125;.log</span><br><span class="line"> done</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">mysql -uroot -padmin -h 192.168.182.1 -e &quot;select fuid,uid from video.follower_00&quot; &gt;&gt; &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;follower_00.log</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260002090.png" alt="image-20230426000249498"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260003322.png" alt="image-20230426000303163"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260003085.png" alt="image-20230426000343050"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260004849.png" alt="image-20230426000403681"></p>
<h3 id="extractUserLevel-sh"><a href="#extractUserLevel-sh" class="headerlink" title="extractUserLevel.sh"></a>extractUserLevel.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line"># 此脚本每天执行一次，添加到crontab或者Azkaban调度器中[每天0:30分开始执行]</span><br><span class="line"></span><br><span class="line"># 正常情况下获取昨天的数据，如果需要补数据，可以直接指定日期</span><br><span class="line">if [ &quot;X$1&quot; &#x3D;&#x3D; &quot;X&quot; ]</span><br><span class="line">then</span><br><span class="line">	yesterday&#x3D;&#96;date --date&#x3D;&quot;1 days ago&quot; +%Y-%m-%d&#96;</span><br><span class="line">else</span><br><span class="line">	yesterday&#x3D;$1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mysql -uroot -padmin -h 192.168.182.1 -e &quot;select * from video.cl_level_user where update_time &gt;&#x3D;&#39;$&#123;yesterday&#125; 00:00:00&#39; and update_time &lt;&#x3D; &#39;$&#123;yesterday&#125; 23:59:59&#39;&quot; &gt;&gt; &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;cl_level_user_$&#123;yesterday&#125;.log</span><br><span class="line"></span><br><span class="line"># 将数据上传到hdfs上，每天一个目录</span><br><span class="line"></span><br><span class="line"># 先在hdfs上创建日期目录</span><br><span class="line">hdfs dfs -mkdir -p &#x2F;data&#x2F;cl_level_user&#x2F;$&#123;yesterday&#x2F;&#x2F;-&#x2F;&#125;</span><br><span class="line"></span><br><span class="line"># 上传</span><br><span class="line">hdfs dfs -put &#x2F;data&#x2F;soft&#x2F;video_recommend&#x2F;cl_level_user_$&#123;yesterday&#125;.log &#x2F;data&#x2F;cl_level_user&#x2F;$&#123;yesterday&#x2F;&#x2F;-&#x2F;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们来开发第二个脚本。这个也是抽取数据了。他呢是抽取了一个user level，有这个主播等级的啊。注意在这个脚本中啊，我们需要将数据上传到hdfs上面，并且呢，这个脚本啊，也需要添加到Crontab或者azakaban那个调度器中，每天凌晨00:30了，然后执行一次。就是每天呢抽取一次啊。</span><br><span class="line"></span><br><span class="line">那下面我们写一下，就是正常情况下。每天凌晨获取昨天的数据。你如果呢，你需要补数据的话。可以直接指定日期。所以这个的话，我来获取一个日期。呃，一。等等a。那说明道一为空。then。还有这个yesterday。等于。加个反引号。刚刚date。days ago，一天以前就是昨天嘛，对吧，加号百分号Y杠百分号M，杠百分号D。这就过去昨天日期了。else，如果说呢不相等，那说明了多少？有值，有值的话呢？二。这样就快。那下面的话其实就可以把我们那个circle语句给它拿回来，那个搜有点长，我在这呢。到这儿拿一下。我们在前面是不是写过呀。对，这里面写这个星号就可以啊，没问题。这边需要改一下。把那个日期拼上。注意你说我在这成这个单引号，它不是不解析吗？大家注意外面还有一层双引号，咱们之前讲过对吧，双引号里面这个单引号这个会解析这个变量啊。我反过来又不行。那最后呢，我们把这个日志数据呢，给它重进现到这个目下面，在这我可以把前面这个复制一下是吧过来。后面的话呢，其实就是这个。表明了。使它来拼接一个热面。注意其在后面呢，你最好拼一个日期对吧，因为他每天都有一次。填了一个日期。点到这就可以。注意，那你到这还没完，我们还需要把这个日上传到HDS上面。杨淑玉上传。的X元。每天一个目录。所以你在这呢，你先在hps上创建日期目录，因为每天一个目录嘛，对吧。CS杠那个地可以加个杠P对吧。it。后面呢，我们就使用这个level user。然后后面把这个复制过来。大家注意这个日期格式呢，中间是带这个横杠的年月日，我们其实想获取这个不带横杠的。但是由于这他确实需要带横杠的，那我们这又不想要怎么办呢？那你就改一下呗，是吧。把横杠给替换掉就行，对吧，全部横杠替换成空，这样的话就是这个年月日中间不带任何分隔符了。这个用法咱们前面也讲过吧。还没上班。高foot。那就是这。把它呢，上传到这个目录下。这一块。</span><br><span class="line"></span><br><span class="line">好，注意，我这个脚本其实就是一个增量脚本，咱们前面说了，你在最开始的时候，其实啊，你还需要将这个表里面的之前的全量数据也给它导一次。那个脚本我这里先不写。我直接写了一个每日的增量脚本啊，大家要知道这个事情。因为我们现在这里面这个数据其实都是认为是一些增量数据啊，我直接。使用这个日期过滤，就可以把里面所有东西全都过滤出来。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260033394.png" alt="image-20230426003329063"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下面我们来确认一下。杠，我们来查一下这个date。小level user。有吧？再来查一下这个。没问题吧，有数据啊，那我们来看一下里面内容呗。对吧，这就是我们采集过来的内容。</span><br><span class="line"></span><br><span class="line">但是你在这需要注意点，它是有一个表头的。所以说呢，我们后期啊，在处理这个数据的时候，需要把这些数据给它归掉就行。那到此为止，服务端数据库中的数据我们就采集完毕了，那在这里面啊，大家需要熟悉我们的数据来源，以及数据最终的存储位置。后面我们的计算程序呢，都需要依赖于这些数据。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260034352.png" alt="image-20230426003427969"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304260034803.png" alt="image-20230426003455794"></p>
<h2 id="数据计算核心指标详细分析"><a href="#数据计算核心指标详细分析" class="headerlink" title="数据计算核心指标详细分析"></a>数据计算核心指标详细分析</h2><p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261043614.png" alt="image-20230426104322881"></p>
<h3 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">大家好，前面我们把项目需要的数据都采集过来了，下面我们开始基于这些数据开发数据计算模块。由于我们需要计算的指标比较多，所以呢，我们先对需要计算的这些核心指标呢进行详细分析。来看一下这张图。我们从左往右分析，首先看左边第一列，这里面表示的是计算程序的数据源，其实就是咱们前面分析的那五种数据。服务端日，客端日加上服务端数据库数据。</span><br><span class="line"></span><br><span class="line">那既往右边看。注意，右边这里面列出来的都是具体的计算任务。那我们首先呢，来看一下第一个任务。它表示的是历史粉丝关注数据的初始化，这个任务负责把服务端数据库中的历史粉丝关注数据批量初始化到neo4j。这个任务呀，只需要运行一次即可，后面就不需要了，它属于一个临时的任务，因为后续的粉丝关注数据就通过第二个任务来实施维护了。</span><br></pre></td></tr></table></figure>

<h3 id="第二个任务"><a href="#第二个任务" class="headerlink" title="第二个任务"></a>第二个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那下面呢，我们来看一下第二个任务。这个任务呢，是实时维护follow和UN follow关系，follow呢就是表示关注，UN follow表示取消关注。这个任务是需要一直运行的，他会实时维护粉丝和主播的关注情况。它的数据来源是kafka中的实时粉丝关注数据，这个是通过我们的日志采集程序采集过来的。那通过前面这两个任务呀，就可以将我们全平台的粉丝关注数据进行全量维护了。第一个任务负责历史粉丝关注数据的迁移，第二个任务负责实时维护，这样在neo4j中就维护了全量的粉丝关注数据。</span><br></pre></td></tr></table></figure>

<h3 id="第三个任务"><a href="#第三个任务" class="headerlink" title="第三个任务"></a>第三个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们来看一下第三个任务。他需要每天定时更新用户最新活跃时间。这个任务的主要作用呢，是为了维护所有用户的活跃时间。因为最终我们在统计三度关系的时候，如果是针对全平台所有的用户都计算，这样是没有意义的。为什么呢？我们来画一个图，再来分析一下这个三个关系的一个流程。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202305201757733.png" alt="image-20230520175733543"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这个呢，是一个主播，主播一吧。好，这个主播呢，他有一些粉丝。这些粉丝是不是还可能会关注了其他主播呀？所以说在这呢，我们再画几个主播。你看这时候如果说有一个用户。当这个用户呢，你看他去关注这个主播一的时候。其实呢，我们需要把它对应的一个三度关系推荐给这个用户，对吧，其实就是这块这些主播对吧。它们两个之间的一个关系，它到它是两个关系，再到它是三种关系好。注意这里面这个主播以及粉丝呢，其实都属于用户，只是说呢，他的角色不一样吧。对于我们平台而言，所有的主播以及粉丝都属于用户。</span><br><span class="line"></span><br><span class="line">那我们在计算三的关系的时候，针对这里面这个主播和粉丝最好呀，都是最近活跃过的。如果说这些粉丝很长时间都不回来了。那么我们认为他的这些关注数据啊，这个参考价值就没那么大了。如果这些主播呀，也是很长时间都不活跃了，那么更不应该进行计算。因为最终假设把它计算出来的话，就会把它推荐给用户。那用户关注他了之后呢，就想去看一下他最近的开播视频。结果发现这个哥们呢，很久都没开播了，那你这种推荐就没有任何意义了，其实就浪费了一次机会对吧。</span><br><span class="line"></span><br><span class="line">所以后期啊，我们在计算三度关系的时候，会对这里面所有的用户，不管你是粉丝还是主播，都会对他的一个活跃时间进行过滤。当时我们在实际工作中使用的那个时间，是根据最近一周活跃过的用户来计算三种关系。就说你这里面这些主播以及粉丝都要是最近一周活跃过来，如果没有活跃过，我在计算三种关系的时候，就不把你们计算在内，直接把你刨除掉。OK，那这个就是第三个任务。这个任务呢，它是每天执行，因此每天凌晨根据昨天的主活数据来维护每个用户的活跃时间。当我们后期计算三个关系的时候，会根据这个条件过滤出来满足条件的用户。</span><br></pre></td></tr></table></figure>

<h3 id="第四个任务"><a href="#第四个任务" class="headerlink" title="第四个任务"></a>第四个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">好，接下来我们来看一下第四个任务。这个任务啊，主要是在neo4j中维护主播的最新等级信息，因为我们在计算三度关系的时候，还需要对最终计算出来的主播等级进行过滤。如果主播等级太低，那就没必要推荐了。这个任务呢，也是一个离线任务，每天执行一次即可，它的数据呢来源于hdfs，这个数据是我们通过脚本每天定时从服务端数据库中找出来的。</span><br></pre></td></tr></table></figure>

<h3 id="第五个任务"><a href="#第五个任务" class="headerlink" title="第五个任务"></a>第五个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们来看一下第五个任务，这个任务呢是每周一计算一次，每周一会到HDPS上面获取最近一个月的视频数据。计算最近一个月内视频评级满足3B加或者是2a加的主播。注意视频等级呢，主要有sabcd这五个等级，S是评级最高的，D是最差的。这里面的3B＋表示最近一个月至少要有三次开播，并且最近三次开播视频的评级需要是B级以上，包含B级。那这里面的2a＋表示最近一个月至少要有两次开播，并且最近两次开播视频的评级需要是a级以上，包含a级。这两个指标，一个是考虑主播的开播频次比较高，但是呢，视频的评级不是特别高，这样也是可以推荐的，相当于它是一种勤劳的主播。还有一种呢，是主播开播频次比较低，但是呢视频评级特别高，比较优秀，这种呢也可以推荐啊。所以说你只需要满足3B加或者2a加都是可以的。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">那最终啊，我们把满足条件的主播计算出来，然后呢到neo4j中进行维护。给主播增加一个flag属性，如果主播最近的开播数据满足3B加或者是2A加，则把这个flag属性置为一。后面在计算三度关系的时候呢，会对主播的这个属性进行过滤，不满足条件呢就不推荐了。那到这为止，前面这五个任务啊，都是对这个neo4j它里面这个数据进行维护的。其中第一个任务呢是初始化数据的是执行一次。</span><br><span class="line"></span><br><span class="line">因此。第二个任务呢，是一个实时任务，需要一直执行，其实这个任务呢，也可以改为离线的，一天执行一次，我们当时主要考虑的是这样的neo4j中的那个粉丝关注数据啊，我们会有其他业务部门也在使用。所以说呢，我们就让这个任务实施维护了。那第三个和第四个任务呢，是每天只一次。第五个任务，本来啊，也考虑每天执行一次，但是呢，每天都计算最近一个月的数据，这样太频繁了，浪费计算资源，所以呢，我们就改为了每周一计算一次。因为我们最终的三个关系数据也是一周计算一次。所以这里面啊，这些离线任务，它的一个计算周期，其实最迟都是一周。所以说第三个和第四个任务其实也可以每周一计算一次。不过当时呢，是因为这些指标，其他业务部门在使用用户率的时候呢，也会用到，所以说呢，我们就每天执行一次。</span><br><span class="line"></span><br><span class="line">那我在这呢，说这么多呀，主要是为了让大家明白，为什么有的任务需要实时，为什么有的任务需要离线，以及离线的任务为什么还要分为一天进行一次和一周之间一次。这些都是由一些具体的业务环境而导致的。</span><br><span class="line"></span><br><span class="line">那到现在为止，你neo4j中的数据是这样。假设我们这里面创建的是一个user这个节点，对吧，这个节点的话，它俩具备以下这些属性。UID。以及呢，它里面有一个时间桌，代表它的一个活跃时间。就是最近的一个活跃时间。以及呢，有一个等级叫level对吧，主播等级。还有一个flag。表示啊，你这个主播最近这一个月，你这个视频平移是否满足3B加或者2a加，如果满足它的值就是一，不满足就是零了。</span><br><span class="line">好，所以说呢，经过前面这五个任务在neo4j里面，我维护的数据其实就是这样。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261105667.png" alt="image-20230426110524589"></p>
<h3 id="第六个任务"><a href="#第六个任务" class="headerlink" title="第六个任务"></a>第六个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们来看一下第六个任务。这个任务呢，是计算满足条件的主播的三度关系推荐列表。在计算的时候会根据前面几个任务的指标作为过滤条件。首先第一点在这里。他俩需要过滤出来最近一周里活跃过的。第二点呢，需要过滤出来主播等级大于四级的。第三点再过滤出来，最近一个月开播视频，满足这个3B加或者2a加这个条件。第四点，再过滤出来推荐列表中粉丝列表关注重合度大于二的。那根据这四点过滤之后呀，最终计算的三个关系列表数据才是我们需要的。</span><br><span class="line"></span><br><span class="line">第六个任务，计算好的数据会先存储到hdfs上面，这个任务是每周一计算一次。因为这个三种关系出现，数据的更新力度没有必要细化到每天。如果每天都计算一次，最终的结果数据变化也不大，并且每天都计算一次，对计算资源的要求也比较高，所以当时我们定的是每周计算一次。更新一次最新的三度关系列表数据。</span><br></pre></td></tr></table></figure>

<h3 id="第七个任务"><a href="#第七个任务" class="headerlink" title="第七个任务"></a>第七个任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据计算出来以后，会通过第七个任务把这个数据导出到MYSQ里面。这样就可以通过MYSQL对外提供数据了。这就是数据计算模块中的详细计算流程。下面呢，我把这个数据计算步骤啊做了一个汇总，我们来看一下。</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261109573.png" alt="image-20230426110912322"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261109688.png" alt="image-20230426110948070"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261111274.png" alt="image-20230426111106202"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一步，历史粉丝关注，数据初始化。第二步，实时维护粉丝关注数据。第三步，每天定时更新主播等级。第四步，每天定时更新用户活跃时间。第五步，每周一计算最近一个月主播视频评级信息。第六步，每周一计算最近一周内主活主播的三组关系列表。第七步，三种关系列表数据导出到马，这个就是具体的我们的计算步骤。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261111021.png" alt="image-20230426111116924"></p>
<h2 id="数据计算之历史粉丝关注数据初始化-第一个任务"><a href="#数据计算之历史粉丝关注数据初始化-第一个任务" class="headerlink" title="数据计算之历史粉丝关注数据初始化(第一个任务)"></a>数据计算之历史粉丝关注数据初始化(第一个任务)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面呢，我们首先来看一下数据计算中的第一步。历史粉丝关注出于初始化。咱们前面分析过啊，历史粉丝关的数据呢，来源于服务端数据库，并且呢，这些数据在存储的时候还是分表存储，一共1296张。这个表里的数据格式呢是一样的。fuid、uid，还有一个time stamp。这个fuid呢，表示关注者，其实呢就是粉丝。这个UID表示被关注者的UID，其实就是主播。这份数据呢，在前面开发数据采集模块的时候，我们已经生成过。那接下来我们就要把这个数据啊，初始化到neo4j中。那我们需要把之前生成的这个文件呢，上传到neo4j的一个import下面才可以使用。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261117713.png" alt="image-20230426111700471"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们之前导出的这个粉丝关注数据在这就这个文件，那我们需要把这个文件给它复制到import目下面。嗯了，好，这样就可以了。那下面呢，我们在初始化这个数据之前啊，我们把那个neo4j重新初始化一下，就把里面数据全给它删掉。因为之前里面有一些特殊数据。把那个data目录删掉。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261118389.png" alt="image-20230426111836337"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261118328.png" alt="image-20230426111852239"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">停一下。嗯。在其中。好，这样的话就可以了，注意因为你在这把那个data目录删了之后啊，你再重新启动之后呢，我们需要去修改一下密码。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261119828.png" alt="image-20230426111933953"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">那接下来我们需要到这儿来初始化数据了。我们在这先连到这个bin&#x2F;cypher-shell这里面。bin&#x2F;cypher-shell -a bolt:&#x2F;&#x2F;bigdata04:7687 -u neo4j -p admin。</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261122789.png" alt="image-20230426112214786"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">好，那这里面呢，我们首先要针对这个关键字段建立索引，对吧。咱们前面是不是已经做过这种操作呀。所以下面呢，我们还需要执行一个这个。好，执行成功，那我们到界面上来确认一下数据。好，是可以的。</span><br><span class="line">neo4j&gt; CREATE CONSTRAINT ON (user:User) ASSERT user.uid IS UNIQUE;</span><br><span class="line">0 rows available after 281 ms, consumed after another 0 ms</span><br><span class="line">Added 1 constraints</span><br><span class="line">然后批量导入数据</span><br><span class="line">neo4j&gt; USING PERIODIC COMMIT 1000</span><br><span class="line">       LOAD CSV WITH HEADERS FROM &#39;file:&#x2F;&#x2F;&#x2F;follower_00.log&#39; AS line FIELDTERMINATOR &#39;\t&#39;</span><br><span class="line">       MERGE (viewer:User &#123; uid: toString(line.fuid)&#125;)</span><br><span class="line">       MERGE (anchor:User &#123; uid: toString(line.uid)&#125;)</span><br><span class="line">       MERGE (viewer)-[:follow]-&gt;(anchor);</span><br><span class="line">0 rows available after 791 ms, consumed after another 0 ms</span><br><span class="line">Added 11 nodes, Created 17 relationships, Set 11 properties, Added 11 labels</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261127580.png" alt="image-20230426112713190"></p>
<p><img src="https://gitee.com/ttyong/hexoBlog/raw/master/%E6%9E%97%E5%AD%90%E9%9B%A8%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/202304261133414.png" alt="image-20230426113352894"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意，我们这儿呢，只初始化一个数据文件。那你说真的，我们实际工作中啊，我们有1000多个这种数据文件，你需要让我在这执行这个命令，执行1000多次吗？这肯定是不合理的。那如何一次性批量导入呢？可以这样来做啊。我们可以把这多个文件合并成一个大文件，对吧，你在Linux命行里面，你看这个文件，然后呢，通过这个右箭头&gt;&gt;重定向。把这个1000多个文件里面那个数据啊，整合到一个大文件里，这就可以了。好，那这样的话呢，针对数据计算的第一步初始化数据，这个我们就搞定了。</span><br></pre></td></tr></table></figure>



<hr>
<blockquote>
</blockquote>

      
    </div>
    
    
    
	
	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html">大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 TTYONG 的个人博客">TTYONG</a></p>
  <p><span>发布时间:</span>2023年04月24日 - 15:04</p>
  <p><span>最后更新:</span>2023年05月20日 - 18:05</p>
  <p><span>原始链接:</span><a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html" title="大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-2">http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://tianyong.fun/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-2.html" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
    });
    });  
</script>



      
	</div>



    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>多少都是爱</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_reward.jpg" alt="TTYONG 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay_reward.jpg" alt="TTYONG 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0/" rel="tag"><i class="fa fa-tag"></i> 直播平台三度关系推荐v1.0</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-1.html" rel="next" title="大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-1">
                <i class="fa fa-chevron-left"></i> 大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-1
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88-%E7%AC%AC%E5%8D%81%E5%85%AB%E5%91%A8-%E7%9B%B4%E6%92%AD%E5%B9%B3%E5%8F%B0%E4%B8%89%E5%BA%A6%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90v1-0-3.html" rel="prev" title="大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-3">
                大数据开发工程师-第十八周 直播平台三度关系推荐v1.0-3 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
      
        
          <ul class="sidebar-nav motion-element">
            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
              文章目录
            </li>
            <li class="sidebar-nav-overview" data-target="site-overview">
              站点概览
            </li>
          </ul>
        
      

	<section class="site-overview sidebar-panel">
	  <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
		<img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="TTYONG">
		<p class="site-author-name" itemprop="name">TTYONG</p>
		 
			<p class="site-description motion-element" itemprop="description"></p>
		 
	  </div>
	  <nav class="site-state motion-element">

		
		  <div class="site-state-item site-state-posts">
			<a href="/archives/%7C%7C%20archive">
			  <span class="site-state-item-count">356</span>
			  <span class="site-state-item-name">日志</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-categories">
			<a href="/categories/index.html">
			  <span class="site-state-item-count">50</span>
			  <span class="site-state-item-name">分类</span>
			</a>
		  </div>
		

		
		  
		  
		  <div class="site-state-item site-state-tags">
			<a href="/tags/index.html">
			  <span class="site-state-item-count">121</span>
			  <span class="site-state-item-name">标签</span>
			</a>
		  </div>
		

	  </nav>

	  
		<div class="feed-link motion-element">
		  <a href="/atom.xml" rel="alternate">
			<i class="fa fa-rss"></i>
			RSS
		  </a>
		</div>
	  

	  <div class="links-of-author motion-element">
		
		  
			<span class="links-of-author-item">
			  <a href="2364076207@qq.com || envelope" target="_blank" title="E-Mail">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				E-Mail
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://wpa.qq.com/msgrd?v=3&uin=2364076207&site=qq&menu=yes || qq" target="_blank" title="QQ" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				QQ
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://weibo.com/p/1005051833844383/home || weixin" target="_blank" title="WeiXin" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				WeiXin
			  </a>
			</span>
		  
			<span class="links-of-author-item">
			  <a href="https://www.zhihu.com/people/he-he-ty || zhihu" target="_blank" title="ZhiHu" rel="external nofollow noopener noreferrer">
				
				  <i class="fa fa-fw fa-globe"></i>
				
				ZhiHu
			  </a>
			</span>
		  
		
	  </div>

	  
	  

	  
	  
		<div class="links-of-blogroll motion-element links-of-blogroll-block">
		  <div class="links-of-blogroll-title">
			<i class="fa  fa-fw fa-link"></i>
			友链
		  </div>
		  <ul class="links-of-blogroll-list">
			
			  <li class="links-of-blogroll-item">
				<a href="https://www.baidu.com/" target="_blank" rel="external nofollow noopener noreferrer">百度</a>
			  </li>
			
		  </ul>
		</div>
	  

	  


	</section>
	
	  
	  <!--noindex-->
		<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
		  <div class="post-toc">

			
			  
			

			
			  <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第十八周-直播平台三度关系推荐v1-0-2"><span class="nav-number">1.</span> <span class="nav-text">第十八周 直播平台三度关系推荐v1.0-2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据采集架构详细设计"><span class="nav-number">1.1.</span> <span class="nav-text">数据采集架构详细设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据来源分析"><span class="nav-number">1.2.</span> <span class="nav-text">数据来源分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端日志数据"><span class="nav-number">1.2.1.</span> <span class="nav-text">服务端日志数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端数据库数据"><span class="nav-number">1.2.2.</span> <span class="nav-text">服务端数据库数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端日志数据"><span class="nav-number">1.2.3.</span> <span class="nav-text">客户端日志数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟产生数据"><span class="nav-number">1.3.</span> <span class="nav-text">模拟产生数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客服端日志接收服务"><span class="nav-number">1.3.1.</span> <span class="nav-text">客服端日志接收服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端http接口"><span class="nav-number">1.3.2.</span> <span class="nav-text">服务端http接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实时粉丝关注"><span class="nav-number">1.3.3.</span> <span class="nav-text">实时粉丝关注</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视频数据"><span class="nav-number">1.3.4.</span> <span class="nav-text">视频数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#历史粉丝关注"><span class="nav-number">1.3.5.</span> <span class="nav-text">历史粉丝关注</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#历史主播等级"><span class="nav-number">1.3.6.</span> <span class="nav-text">历史主播等级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端用户活跃日志"><span class="nav-number">1.3.7.</span> <span class="nav-text">客户端用户活跃日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据采集聚合"><span class="nav-number">1.4.</span> <span class="nav-text">数据采集聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据分发"><span class="nav-number">1.5.</span> <span class="nav-text">数据分发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据落盘"><span class="nav-number">1.6.</span> <span class="nav-text">数据落盘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka-hdfs-user-active-conf"><span class="nav-number">1.6.1.</span> <span class="nav-text">kafka-hdfs-user-active.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka-hdfs-video-info-conf"><span class="nav-number">1.6.2.</span> <span class="nav-text">kafka-hdfs-video-info.conf</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动"><span class="nav-number">1.7.</span> <span class="nav-text">启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据落盘-1"><span class="nav-number">1.7.1.</span> <span class="nav-text">数据落盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据分发-1"><span class="nav-number">1.7.2.</span> <span class="nav-text">数据分发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据采集聚合-1"><span class="nav-number">1.7.3.</span> <span class="nav-text">数据采集聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行数据生成程序"><span class="nav-number">1.7.4.</span> <span class="nav-text">执行数据生成程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#采集服务端数据库数据"><span class="nav-number">1.8.</span> <span class="nav-text">采集服务端数据库数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#extractFollower-sh"><span class="nav-number">1.8.1.</span> <span class="nav-text">extractFollower.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extractUserLevel-sh"><span class="nav-number">1.8.2.</span> <span class="nav-text">extractUserLevel.sh</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算核心指标详细分析"><span class="nav-number">1.9.</span> <span class="nav-text">数据计算核心指标详细分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一个任务"><span class="nav-number">1.9.1.</span> <span class="nav-text">第一个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二个任务"><span class="nav-number">1.9.2.</span> <span class="nav-text">第二个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三个任务"><span class="nav-number">1.9.3.</span> <span class="nav-text">第三个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第四个任务"><span class="nav-number">1.9.4.</span> <span class="nav-text">第四个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第五个任务"><span class="nav-number">1.9.5.</span> <span class="nav-text">第五个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第六个任务"><span class="nav-number">1.9.6.</span> <span class="nav-text">第六个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第七个任务"><span class="nav-number">1.9.7.</span> <span class="nav-text">第七个任务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据计算之历史粉丝关注数据初始化-第一个任务"><span class="nav-number">1.10.</span> <span class="nav-text">数据计算之历史粉丝关注数据初始化(第一个任务)</span></a></li></ol></li></ol></div>
			

		  </div>
		</section>
	  <!--/noindex-->
	  
	

	

  </div>
</aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2020.3.4 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TTYONG</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">613.4k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow>Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next rel="external nofollow">NexT.Pisces</a> v5.1.4</div>



-->  


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <div id="gitalk-container"></div>
  <script src="/js/src/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'd3f3299eb0cc69c8f171',
      clientSecret: '23bf8796e5dda2daf0a1b12964d89f4cc88f9ddf',
      repo: 'comments_repository',
      owner: 'ttyong',
      admin: ['ttyong'],
      id: md5(location.pathname),
      distractionFreeMode: 'false'
    })
    gitalk.render('gitalk-container')
  </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  
  

  

  

  

  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>
  
  
  
  

  <canvas id="evanyou"></canvas>
  <style>
    #evanyou {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
  <script src="/js/src/evan-you.js"></script>




  <script src="/js/src/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>




  <script async src="/js/cursor/fireworks.js"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
